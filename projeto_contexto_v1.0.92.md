CONTEXTO DO PROJETO - VERSÃƒO 1.0.92
Data de GeraÃ§Ã£o: 20/12/2025 12:38:49
### SEMPRE DIGITE OS CÃ“DIGOS, MESMO COM CORREÃ‡Ã•ES COMPLETO! NÃƒO SUGIRA CÃ“DIGOS PARA ALTERAR ALGUM JÃ CRIADO, SEMPRE O CÃ“DIGO COMPLETO.
==================================================

ESTRUTURA DE DIRETÃ“RIOS:
.
â”œâ”€â”€ doc.md
â”œâ”€â”€ index.html
â”œâ”€â”€ package.json
â”œâ”€â”€ pb_schema.md
â”œâ”€â”€ projeto_contexto_v1.0.91.md
â”œâ”€â”€ Projeto_TeAgendei_v2.1.md
â”œâ”€â”€ StaffBookingModal.tsx
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tsconfig.node.json
â”œâ”€â”€ vite.config.ts
â”œâ”€â”€ .cursor/
â”‚   â”œâ”€â”€ worktrees.json
â”œâ”€â”€ public/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.css
â”‚   â”œâ”€â”€ vite-env.d.ts
â”‚   â”œâ”€â”€ react-app/
â”‚   â”‚   â”œâ”€â”€ App.tsx
â”‚   â”‚   â”œâ”€â”€ main.tsx
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ booking/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StepConfirm.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StepDateTime.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StepProfessional.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StepService.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Modal.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StaffBookingModal.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ layout/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AppLayout.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Header.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StaffLayout.tsx
â”‚   â”‚   â”œâ”€â”€ contexts/
â”‚   â”‚   â”‚   â”œâ”€â”€ AuthContext.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ BookingContext.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ TenantContext.tsx
â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ appointments.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ availability.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ booking.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ client.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ financial.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ onboarding.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ pocketbase.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ register.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ services.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ shop-hours.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ shops.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ staff.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ slots.ts
â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ LoginPage.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RegisterPage.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ booking/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BookPage.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ client/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ClientPanelPage.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DashboardHome.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ onboarding/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CompanyStep.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DoneStep.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OnboardingRouter.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OwnerProfessionalStep.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ShopStep.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ owner/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FinancialPage.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ServicesPage.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SettingsPage.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ShopsPage.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StaffPage.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ LandingPage.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ staff/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StaffAgendaPage.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StaffProfilePage.tsx
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ AppRouter.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ProtectedRoute.tsx
â”‚   â”œâ”€â”€ shared/
â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â”œâ”€â”€ utils/


==================================================
CONTEÃšDO DOS ARQUIVOS
==================================================


--- INICIO DO ARQUIVO: doc.md ---
Path: doc.md
------------------------------
ğŸ“‹ VisÃ£o Geral
TeAgendei Ã© uma plataforma de gestÃ£o de agendamentos para negÃ³cios de serviÃ§os (barbearias, salÃµes, clÃ­nicas estÃ©ticas, etc.) com arquitetura multi-tenant completa.

ğŸ—ï¸ Arquitetura
Stack TecnolÃ³gico

Frontend: React 18 + TypeScript + Vite + Tailwind CSS
Backend: PocketBase (SQLite + API REST integrada)
Roteamento: React Router v7
Estado: Context API (Auth + Tenant)

Estrutura Multi-Tenant
Company (Empresa)
â””â”€â”€ Shops (Unidades/Lojas)
â”œâ”€â”€ Services (ServiÃ§os)
â”œâ”€â”€ Staff (Profissionais)
â””â”€â”€ Appointments (Agendamentos)

ğŸ‘¥ Tipos de UsuÃ¡rio

Dono (Owner)

Gerencia empresa, lojas, equipe
Acessa dashboard, financeiro, configuraÃ§Ãµes
Rota base: /owner/\*

Staff (Profissional)

VÃª apenas sua prÃ³pria agenda
Gerencia atendimentos do dia
Rota base: /staff/\*

Cliente

Agenda serviÃ§os via link pÃºblico
Acompanha histÃ³rico
Rota: /client

ğŸ¯ Funcionalidades Principais

1. Sistema de Agendamento

Engine inteligente de slots (slots.ts)
Previne overbooking
Respeita horÃ¡rios de funcionamento
Considera duraÃ§Ã£o de serviÃ§os
Suporta antecedÃªncia mÃ­nima/mÃ¡xima

2. Fluxo de Booking (4 Passos)
   StepService â†’ StepProfessional â†’ StepDateTime â†’ StepConfirm
3. GestÃ£o Operacional

Dashboard com KPIs diÃ¡rios
Agenda por profissional
Status de atendimento (9 estados)
Bloqueio de horÃ¡rios
Pagamentos e mÃ©todos

4. Financeiro

Receita realizada vs prevista
Receita por mÃ©todo de pagamento
Detalhamento diÃ¡rio
Ticket mÃ©dio

ğŸ” SeguranÃ§a e Regras
Regras do PocketBase

Filtros automÃ¡ticos por company_id e shop_id
Dono vÃª tudo da empresa
Staff vÃª apenas sua loja
Cliente vÃª apenas seus agendamentos

Exemplo de Regra (Appointments)
javascriptlistRule: "shop_id = @request.auth.shop_id ||
client_id = @request.auth.id ||
barber_id = @request.auth.id"

ğŸš€ Fluxos CrÃ­ticos
Onboarding do Dono

Criar empresa (CompanyStep)
Criar primeira loja (ShopStep)
Definir se Ã© profissional (OwnerProfessionalStep)
Concluir â†’ Dashboard

Agendamento de Cliente

Acessa /book/:slug
Escolhe serviÃ§o
Escolhe profissional (ou "Qualquer")
Escolhe data/hora
Confirma â†’ Cria appointment

Agenda do Staff

Lista appointments do dia
Atualiza status (Pendente â†’ Em Andamento â†’ ConcluÃ­do)
Registra pagamento ao finalizar
Pode criar novos agendamentos ou bloqueios

ğŸ› ï¸ Destaques TÃ©cnicos

1. GestÃ£o de Estado
   typescript// AuthContext: sessÃ£o do usuÃ¡rio
   // TenantContext: empresa/loja ativa
   // BookingContext: fluxo de agendamento
2. API Centralizada
   Todas as chamadas ao PocketBase estÃ£o em lib/api/\*:

pocketbase.ts - Cliente base
appointments.ts - Agendamentos
availability.ts - Disponibilidade
financial.ts - Dados financeiros
etc.

3. CorreÃ§Ãµes Importantes Aplicadas

âœ… ConversÃ£o UTC â†’ Local (horÃ¡rios)
âœ… Status "6" (Bloqueio) tratado separadamente
âœ… Cliente avulso (sem login) suportado
âœ… Cancelamento automÃ¡tico de requests ignorado
âœ… ValidaÃ§Ã£o de colisÃ£o de slots corrigida

4. CÃ¡lculo de Slots
   typescript// Verifica interseÃ§Ã£o de intervalos
   return slotStart < busy.end && slotEnd > busy.start;

ğŸ“Š Banco de Dados (PocketBase)
ColeÃ§Ãµes Principais
ColeÃ§Ã£oFunÃ§Ã£ousersUsuÃ¡rios (auth)companiesEmpresasshopsUnidadesservicesServiÃ§osappointmentsAgendamentosshop_hoursHorÃ¡rios de funcionamentopayment_methodsFormas de pagamentocategoriesCategorias de serviÃ§os
Campos CrÃ­ticos de Appointments
typescript{
client_id?: string; // Cliente cadastrado
customer_name?: string; // Cliente avulso
customer_phone?: string; // Telefone avulso
status: '0'-'9'; // 9 estados possÃ­veis
payment_status: '1'-'3'; // A Pagar, Pago, Pendente
}

```

---

## ğŸ¨ **UI/UX**

- **Design:** Dark mode com Tailwind
- **Responsivo:** Mobile-first
- **AnimaÃ§Ãµes:** TransiÃ§Ãµes suaves
- **Feedback:** Toasts, modais, loading states
- **Acessibilidade:** Labels, ARIA

---

## ğŸ”„ **Fluxo de Dados TÃ­pico**
```

User Action â†’ Component â†’ Context (se necessÃ¡rio)
â†’ API Function â†’ PocketBase â†’ Database
â†’ Response â†’ Update State â†’ Re-render

ğŸ“ Pontos de AtenÃ§Ã£o
Boas PrÃ¡ticas Implementadas
âœ… Tratamento de erros robusto
âœ… Cancelamento de requests evitado
âœ… ValidaÃ§Ã£o em mÃºltiplas camadas
âœ… Feedback visual consistente
âœ… CÃ³digo tipado (TypeScript)
LimitaÃ§Ãµes Conhecidas
âš ï¸ Sem localStorage (restriÃ§Ã£o Claude.ai)
âš ï¸ Sem notificaÃ§Ãµes push
âš ï¸ Sem integraÃ§Ã£o de pagamento real
âš ï¸ Sem modo offline

ğŸ¯ ConclusÃ£o
O TeAgendei Ã© um projeto profissional e escalÃ¡vel, com:

Arquitetura multi-tenant robusta
SeparaÃ§Ã£o clara de responsabilidades
Engine de agendamento inteligente
Fluxos otimizados para cada tipo de usuÃ¡rio
CÃ³digo limpo e bem documentado

Pronto para produÃ§Ã£o com pequenos ajustes de infraestrutura e possÃ­veis melhorias incrementais (notificaÃ§Ãµes, relatÃ³rios avanÃ§ados, etc.).

--- FIM DO ARQUIVO: doc.md ---


--- INICIO DO ARQUIVO: index.html ---
Path: index.html
------------------------------
<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>TeAgendei</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
          }
        }
      }
    </script>
  </head>

  <body>
    <div id="root"></div>

    <script type="module" src="/src/react-app/main.tsx"></script>
  </body>
</html>
--- FIM DO ARQUIVO: index.html ---


--- INICIO DO ARQUIVO: package.json ---
Path: package.json
------------------------------
{
  "name": "teagendei",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "lucide-react": "^0.562.0",
    "pocketbase": "^0.26.5",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-hot-toast": "^2.6.0",
    "react-router-dom": "^7.10.1"
  },
  "devDependencies": {
    "@types/react": "^18.3.2",
    "@types/react-dom": "^18.3.0",
    "@vitejs/plugin-react": "^4.3.1",
    "typescript": "^5.4.5",
    "vite": "^5.2.10"
  }
}

--- FIM DO ARQUIVO: package.json ---


--- INICIO DO ARQUIVO: pb_schema.md ---
Path: pb_schema.md
------------------------------
[
  {
    "id": "pbc_3142635823",
    "listRule": null,
    "viewRule": null,
    "createRule": null,
    "updateRule": null,
    "deleteRule": null,
    "name": "_superusers",
    "type": "auth",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "cost": 0,
        "hidden": true,
        "id": "password901924565",
        "max": 0,
        "min": 8,
        "name": "password",
        "pattern": "",
        "presentable": false,
        "required": true,
        "system": true,
        "type": "password"
      },
      {
        "autogeneratePattern": "[a-zA-Z0-9]{50}",
        "hidden": true,
        "id": "text2504183744",
        "max": 60,
        "min": 30,
        "name": "tokenKey",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "exceptDomains": null,
        "hidden": false,
        "id": "email3885137012",
        "name": "email",
        "onlyDomains": null,
        "presentable": false,
        "required": true,
        "system": true,
        "type": "email"
      },
      {
        "hidden": false,
        "id": "bool1547992806",
        "name": "emailVisibility",
        "presentable": false,
        "required": false,
        "system": true,
        "type": "bool"
      },
      {
        "hidden": false,
        "id": "bool256245529",
        "name": "verified",
        "presentable": false,
        "required": false,
        "system": true,
        "type": "bool"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": true,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": true,
        "type": "autodate"
      }
    ],
    "indexes": [
      "CREATE UNIQUE INDEX `idx_tokenKey_pbc_3142635823` ON `_superusers` (`tokenKey`)",
      "CREATE UNIQUE INDEX `idx_email_pbc_3142635823` ON `_superusers` (`email`) WHERE `email` != ''"
    ],
    "system": true,
    "authRule": "",
    "manageRule": null,
    "authAlert": {
      "enabled": true,
      "emailTemplate": {
        "subject": "Login from a new location",
        "body": "<p>Hello,</p>\n<p>We noticed a login to your {APP_NAME} account from a new location:</p>\n<p><em>{ALERT_INFO}</em></p>\n<p><strong>If this wasn't you, you should immediately change your {APP_NAME} account password to revoke access from all other locations.</strong></p>\n<p>If this was you, you may disregard this email.</p>\n<p>\n  Thanks,<br/>\n  {APP_NAME} team\n</p>"
      }
    },
    "oauth2": {
      "mappedFields": {
        "id": "",
        "name": "",
        "username": "",
        "avatarURL": ""
      },
      "enabled": false
    },
    "passwordAuth": {
      "enabled": true,
      "identityFields": [
        "email"
      ]
    },
    "mfa": {
      "enabled": false,
      "duration": 1800,
      "rule": ""
    },
    "otp": {
      "enabled": false,
      "duration": 180,
      "length": 8,
      "emailTemplate": {
        "subject": "OTP for {APP_NAME}",
        "body": "<p>Hello,</p>\n<p>Your one-time password is: <strong>{OTP}</strong></p>\n<p><i>If you didn't ask for the one-time password, you can ignore this email.</i></p>\n<p>\n  Thanks,<br/>\n  {APP_NAME} team\n</p>"
      }
    },
    "authToken": {
      "duration": 86400
    },
    "passwordResetToken": {
      "duration": 1800
    },
    "emailChangeToken": {
      "duration": 1800
    },
    "verificationToken": {
      "duration": 259200
    },
    "fileToken": {
      "duration": 180
    },
    "verificationTemplate": {
      "subject": "Verify your {APP_NAME} email",
      "body": "<p>Hello,</p>\n<p>Thank you for joining us at {APP_NAME}.</p>\n<p>Click on the button below to verify your email address.</p>\n<p>\n  <a class=\"btn\" href=\"{APP_URL}/_/#/auth/confirm-verification/{TOKEN}\" target=\"_blank\" rel=\"noopener\">Verify</a>\n</p>\n<p>\n  Thanks,<br/>\n  {APP_NAME} team\n</p>"
    },
    "resetPasswordTemplate": {
      "subject": "Reset your {APP_NAME} password",
      "body": "<p>Hello,</p>\n<p>Click on the button below to reset your password.</p>\n<p>\n  <a class=\"btn\" href=\"{APP_URL}/_/#/auth/confirm-password-reset/{TOKEN}\" target=\"_blank\" rel=\"noopener\">Reset password</a>\n</p>\n<p><i>If you didn't ask to reset your password, you can ignore this email.</i></p>\n<p>\n  Thanks,<br/>\n  {APP_NAME} team\n</p>"
    },
    "confirmEmailChangeTemplate": {
      "subject": "Confirm your {APP_NAME} new email address",
      "body": "<p>Hello,</p>\n<p>Click on the button below to confirm your new email address.</p>\n<p>\n  <a class=\"btn\" href=\"{APP_URL}/_/#/auth/confirm-email-change/{TOKEN}\" target=\"_blank\" rel=\"noopener\">Confirm new email</a>\n</p>\n<p><i>If you didn't ask to change your email address, you can ignore this email.</i></p>\n<p>\n  Thanks,<br/>\n  {APP_NAME} team\n</p>"
    }
  },
  {
    "id": "_pb_users_auth_",
    "listRule": "",
    "viewRule": "",
    "createRule": "id = @request.auth.id",
    "updateRule": "id = @request.auth.id || (company_id != \"\" && company_id = @request.auth.company_id && @request.auth.role = \"dono\")",
    "deleteRule": "id = @request.auth.id || (company_id != \"\" && company_id = @request.auth.company_id && @request.auth.role = \"dono\")",
    "name": "users",
    "type": "auth",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "cost": 0,
        "hidden": true,
        "id": "password901924565",
        "max": 0,
        "min": 8,
        "name": "password",
        "pattern": "",
        "presentable": false,
        "required": true,
        "system": true,
        "type": "password"
      },
      {
        "autogeneratePattern": "[a-zA-Z0-9]{50}",
        "hidden": true,
        "id": "text2504183744",
        "max": 60,
        "min": 30,
        "name": "tokenKey",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "exceptDomains": null,
        "hidden": false,
        "id": "email3885137012",
        "name": "email",
        "onlyDomains": null,
        "presentable": false,
        "required": true,
        "system": true,
        "type": "email"
      },
      {
        "hidden": false,
        "id": "bool1547992806",
        "name": "emailVisibility",
        "presentable": false,
        "required": false,
        "system": true,
        "type": "bool"
      },
      {
        "hidden": false,
        "id": "bool256245529",
        "name": "verified",
        "presentable": false,
        "required": false,
        "system": true,
        "type": "bool"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1579384326",
        "max": 255,
        "min": 0,
        "name": "name",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": false,
        "system": false,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "file376926767",
        "maxSelect": 1,
        "maxSize": 5242880,
        "mimeTypes": [
          "image/jpeg",
          "image/png",
          "image/svg+xml",
          "image/gif",
          "image/webp"
        ],
        "name": "avatar",
        "presentable": false,
        "protected": false,
        "required": false,
        "system": false,
        "thumbs": null,
        "type": "file"
      },
      {
        "hidden": false,
        "id": "select1466534506",
        "maxSelect": 1,
        "name": "role",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "select",
        "values": [
          "dono",
          "cliente",
          "staff"
        ]
      },
      {
        "cascadeDelete": false,
        "collectionId": "pbc_3866053794",
        "hidden": false,
        "id": "relation2543524566",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "company_id",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "relation"
      },
      {
        "cascadeDelete": false,
        "collectionId": "pbc_3896301928",
        "hidden": false,
        "id": "relation1293337821",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "shop_id",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "relation"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1146066909",
        "max": 0,
        "min": 0,
        "name": "phone",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": false,
        "system": false,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "bool2467008628",
        "name": "is_professional",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "bool"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": false,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": false,
        "type": "autodate"
      }
    ],
    "indexes": [
      "CREATE UNIQUE INDEX `idx_tokenKey__pb_users_auth_` ON `users` (`tokenKey`)",
      "CREATE UNIQUE INDEX `idx_email__pb_users_auth_` ON `users` (`email`) WHERE `email` != ''"
    ],
    "system": false,
    "authRule": "",
    "manageRule": null,
    "authAlert": {
      "enabled": false,
      "emailTemplate": {
        "subject": "Login from a new location",
        "body": "<p>Hello,</p>\n<p>We noticed a login to your {APP_NAME} account from a new location:</p>\n<p><em>{ALERT_INFO}</em></p>\n<p><strong>If this wasn't you, you should immediately change your {APP_NAME} account password to revoke access from all other locations.</strong></p>\n<p>If this was you, you may disregard this email.</p>\n<p>\n  Thanks,<br/>\n  {APP_NAME} team\n</p>"
      }
    },
    "oauth2": {
      "mappedFields": {
        "id": "",
        "name": "name",
        "username": "",
        "avatarURL": "avatar"
      },
      "enabled": false
    },
    "passwordAuth": {
      "enabled": true,
      "identityFields": [
        "email"
      ]
    },
    "mfa": {
      "enabled": false,
      "duration": 1800,
      "rule": ""
    },
    "otp": {
      "enabled": false,
      "duration": 180,
      "length": 8,
      "emailTemplate": {
        "subject": "OTP for {APP_NAME}",
        "body": "<p>Hello,</p>\n<p>Your one-time password is: <strong>{OTP}</strong></p>\n<p><i>If you didn't ask for the one-time password, you can ignore this email.</i></p>\n<p>\n  Thanks,<br/>\n  {APP_NAME} team\n</p>"
      }
    },
    "authToken": {
      "duration": 604800
    },
    "passwordResetToken": {
      "duration": 1800
    },
    "emailChangeToken": {
      "duration": 1800
    },
    "verificationToken": {
      "duration": 259200
    },
    "fileToken": {
      "duration": 180
    },
    "verificationTemplate": {
      "subject": "Verify your {APP_NAME} email",
      "body": "<p>Hello,</p>\n<p>Thank you for joining us at {APP_NAME}.</p>\n<p>Click on the button below to verify your email address.</p>\n<p>\n  <a class=\"btn\" href=\"{APP_URL}/_/#/auth/confirm-verification/{TOKEN}\" target=\"_blank\" rel=\"noopener\">Verify</a>\n</p>\n<p>\n  Thanks,<br/>\n  {APP_NAME} team\n</p>"
    },
    "resetPasswordTemplate": {
      "subject": "Reset your {APP_NAME} password",
      "body": "<p>Hello,</p>\n<p>Click on the button below to reset your password.</p>\n<p>\n  <a class=\"btn\" href=\"{APP_URL}/_/#/auth/confirm-password-reset/{TOKEN}\" target=\"_blank\" rel=\"noopener\">Reset password</a>\n</p>\n<p><i>If you didn't ask to reset your password, you can ignore this email.</i></p>\n<p>\n  Thanks,<br/>\n  {APP_NAME} team\n</p>"
    },
    "confirmEmailChangeTemplate": {
      "subject": "Confirm your {APP_NAME} new email address",
      "body": "<p>Hello,</p>\n<p>Click on the button below to confirm your new email address.</p>\n<p>\n  <a class=\"btn\" href=\"{APP_URL}/_/#/auth/confirm-email-change/{TOKEN}\" target=\"_blank\" rel=\"noopener\">Confirm new email</a>\n</p>\n<p><i>If you didn't ask to change your email address, you can ignore this email.</i></p>\n<p>\n  Thanks,<br/>\n  {APP_NAME} team\n</p>"
    }
  },
  {
    "id": "pbc_4275539003",
    "listRule": "@request.auth.id != '' && recordRef = @request.auth.id && collectionRef = @request.auth.collectionId",
    "viewRule": "@request.auth.id != '' && recordRef = @request.auth.id && collectionRef = @request.auth.collectionId",
    "createRule": null,
    "updateRule": null,
    "deleteRule": "@request.auth.id != '' && recordRef = @request.auth.id && collectionRef = @request.auth.collectionId",
    "name": "_authOrigins",
    "type": "base",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text455797646",
        "max": 0,
        "min": 0,
        "name": "collectionRef",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text127846527",
        "max": 0,
        "min": 0,
        "name": "recordRef",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text4228609354",
        "max": 0,
        "min": 0,
        "name": "fingerprint",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": true,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": true,
        "type": "autodate"
      }
    ],
    "indexes": [
      "CREATE UNIQUE INDEX `idx_authOrigins_unique_pairs` ON `_authOrigins` (collectionRef, recordRef, fingerprint)"
    ],
    "system": true
  },
  {
    "id": "pbc_2281828961",
    "listRule": "@request.auth.id != '' && recordRef = @request.auth.id && collectionRef = @request.auth.collectionId",
    "viewRule": "@request.auth.id != '' && recordRef = @request.auth.id && collectionRef = @request.auth.collectionId",
    "createRule": null,
    "updateRule": null,
    "deleteRule": "@request.auth.id != '' && recordRef = @request.auth.id && collectionRef = @request.auth.collectionId",
    "name": "_externalAuths",
    "type": "base",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text455797646",
        "max": 0,
        "min": 0,
        "name": "collectionRef",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text127846527",
        "max": 0,
        "min": 0,
        "name": "recordRef",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text2462348188",
        "max": 0,
        "min": 0,
        "name": "provider",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1044722854",
        "max": 0,
        "min": 0,
        "name": "providerId",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": true,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": true,
        "type": "autodate"
      }
    ],
    "indexes": [
      "CREATE UNIQUE INDEX `idx_externalAuths_record_provider` ON `_externalAuths` (collectionRef, recordRef, provider)",
      "CREATE UNIQUE INDEX `idx_externalAuths_collection_provider` ON `_externalAuths` (collectionRef, provider, providerId)"
    ],
    "system": true
  },
  {
    "id": "pbc_2279338944",
    "listRule": "@request.auth.id != '' && recordRef = @request.auth.id && collectionRef = @request.auth.collectionId",
    "viewRule": "@request.auth.id != '' && recordRef = @request.auth.id && collectionRef = @request.auth.collectionId",
    "createRule": null,
    "updateRule": null,
    "deleteRule": null,
    "name": "_mfas",
    "type": "base",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text455797646",
        "max": 0,
        "min": 0,
        "name": "collectionRef",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text127846527",
        "max": 0,
        "min": 0,
        "name": "recordRef",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1582905952",
        "max": 0,
        "min": 0,
        "name": "method",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": true,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": true,
        "type": "autodate"
      }
    ],
    "indexes": [
      "CREATE INDEX `idx_mfas_collectionRef_recordRef` ON `_mfas` (collectionRef,recordRef)"
    ],
    "system": true
  },
  {
    "id": "pbc_1638494021",
    "listRule": "@request.auth.id != '' && recordRef = @request.auth.id && collectionRef = @request.auth.collectionId",
    "viewRule": "@request.auth.id != '' && recordRef = @request.auth.id && collectionRef = @request.auth.collectionId",
    "createRule": null,
    "updateRule": null,
    "deleteRule": null,
    "name": "_otps",
    "type": "base",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text455797646",
        "max": 0,
        "min": 0,
        "name": "collectionRef",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text127846527",
        "max": 0,
        "min": 0,
        "name": "recordRef",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "cost": 8,
        "hidden": true,
        "id": "password901924565",
        "max": 0,
        "min": 0,
        "name": "password",
        "pattern": "",
        "presentable": false,
        "required": true,
        "system": true,
        "type": "password"
      },
      {
        "autogeneratePattern": "",
        "hidden": true,
        "id": "text3866985172",
        "max": 0,
        "min": 0,
        "name": "sentTo",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": false,
        "system": true,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": true,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": true,
        "type": "autodate"
      }
    ],
    "indexes": [
      "CREATE INDEX `idx_otps_collectionRef_recordRef` ON `_otps` (collectionRef, recordRef)"
    ],
    "system": true
  },
  {
    "id": "pbc_1037645436",
    "listRule": "shop_id = @request.auth.shop_id || client_id = @request.auth.id || barber_id = @request.auth.id",
    "viewRule": "shop_id = @request.auth.shop_id || client_id = @request.auth.id || barber_id = @request.auth.id",
    "createRule": "@request.auth.id != \"\"",
    "updateRule": "shop_id = @request.auth.shop_id || client_id = @request.auth.id",
    "deleteRule": "shop_id = @request.auth.shop_id",
    "name": "appointments",
    "type": "base",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "date1345189255",
        "max": "",
        "min": "",
        "name": "start_time",
        "presentable": true,
        "required": true,
        "system": false,
        "type": "date"
      },
      {
        "hidden": false,
        "id": "date1096160257",
        "max": "",
        "min": "",
        "name": "end_time",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "date"
      },
      {
        "hidden": false,
        "id": "select2063623452",
        "maxSelect": 1,
        "name": "status",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "select",
        "values": [
          "0",
          "1",
          "2",
          "3",
          "4",
          "5",
          "6",
          "7",
          "8",
          "9"
        ]
      },
      {
        "hidden": false,
        "id": "select1580793482",
        "maxSelect": 1,
        "name": "payment_status",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "select",
        "values": [
          "1",
          "2",
          "3"
        ]
      },
      {
        "cascadeDelete": false,
        "collectionId": "pbc_568792081",
        "hidden": false,
        "id": "relation2069996022",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "payment_method",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "relation"
      },
      {
        "hidden": false,
        "id": "number1186288468",
        "max": null,
        "min": null,
        "name": "total_amount",
        "onlyInt": false,
        "presentable": false,
        "required": false,
        "system": false,
        "type": "number"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text18589324",
        "max": 0,
        "min": 0,
        "name": "notes",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": false,
        "system": false,
        "type": "text"
      },
      {
        "cascadeDelete": false,
        "collectionId": "_pb_users_auth_",
        "hidden": false,
        "id": "relation434858273",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "client_id",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "relation"
      },
      {
        "cascadeDelete": false,
        "collectionId": "_pb_users_auth_",
        "hidden": false,
        "id": "relation3220373234",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "barber_id",
        "presentable": false,
        "required": true,
        "system": false,
        "type": "relation"
      },
      {
        "cascadeDelete": false,
        "collectionId": "pbc_863811952",
        "hidden": false,
        "id": "relation3982272998",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "service_id",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "relation"
      },
      {
        "cascadeDelete": true,
        "collectionId": "pbc_3896301928",
        "hidden": false,
        "id": "relation1293337821",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "shop_id",
        "presentable": false,
        "required": true,
        "system": false,
        "type": "relation"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text179493489",
        "max": 0,
        "min": 0,
        "name": "customer_name",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": false,
        "system": false,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text2323309286",
        "max": 0,
        "min": 0,
        "name": "customer_phone",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": false,
        "system": false,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": false,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": false,
        "type": "autodate"
      }
    ],
    "indexes": [
      "CREATE UNIQUE INDEX `idx_unique_active_booking` ON `appointments` (\n  `shop_id`,\n  `barber_id`,\n  `start_time`\n) WHERE status != 0"
    ],
    "system": false
  },
  {
    "id": "pbc_3292755704",
    "listRule": "shop_id.owner_id = @request.auth.id",
    "viewRule": "shop_id.owner_id = @request.auth.id",
    "createRule": "@request.auth.id != \"\"",
    "updateRule": "shop_id.owner_id = @request.auth.id",
    "deleteRule": "shop_id.owner_id = @request.auth.id",
    "name": "categories",
    "type": "base",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1579384326",
        "max": 0,
        "min": 0,
        "name": "name",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": false,
        "type": "text"
      },
      {
        "cascadeDelete": true,
        "collectionId": "pbc_3896301928",
        "hidden": false,
        "id": "relation1293337821",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "shop_id",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "relation"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": false,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": false,
        "type": "autodate"
      }
    ],
    "indexes": [],
    "system": false
  },
  {
    "id": "pbc_1997259952",
    "listRule": "user_id = @request.auth.id\n",
    "viewRule": "user_id = @request.auth.id\n",
    "createRule": "@request.auth.id != \"\" \n&& \nuser_id = @request.auth.id\n",
    "updateRule": "user_id = @request.auth.id\n",
    "deleteRule": "user_id = @request.auth.id\n",
    "name": "client_companies",
    "type": "base",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "cascadeDelete": false,
        "collectionId": "_pb_users_auth_",
        "hidden": false,
        "id": "relation2809058197",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "user_id",
        "presentable": false,
        "required": true,
        "system": false,
        "type": "relation"
      },
      {
        "cascadeDelete": false,
        "collectionId": "pbc_3866053794",
        "hidden": false,
        "id": "relation2543524566",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "company_id",
        "presentable": false,
        "required": true,
        "system": false,
        "type": "relation"
      },
      {
        "cascadeDelete": false,
        "collectionId": "pbc_3896301928",
        "hidden": false,
        "id": "relation1293337821",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "shop_id",
        "presentable": false,
        "required": true,
        "system": false,
        "type": "relation"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": false,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": false,
        "type": "autodate"
      }
    ],
    "indexes": [
      "CREATE INDEX `idx_PQB5sTm0hQ` ON `client_companies` (\n  `user_id`,\n  `company_id`\n)"
    ],
    "system": false
  },
  {
    "id": "pbc_3866053794",
    "listRule": "owner_id = @request.auth.id || id = @request.auth.company_id",
    "viewRule": "owner_id = @request.auth.id || id = @request.auth.company_id",
    "createRule": "@request.auth.id != \"\"",
    "updateRule": "owner_id = @request.auth.id",
    "deleteRule": "owner_id = @request.auth.id",
    "name": "companies",
    "type": "base",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1935184049",
        "max": 0,
        "min": 0,
        "name": "legal_name",
        "pattern": "",
        "presentable": true,
        "primaryKey": false,
        "required": true,
        "system": false,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text3368456299",
        "max": 14,
        "min": 0,
        "name": "cnpj",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": false,
        "system": false,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "select3478682990",
        "maxSelect": 1,
        "name": "plan_status",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "select",
        "values": [
          "trial",
          "active",
          "suspended",
          "cancelled"
        ]
      },
      {
        "cascadeDelete": false,
        "collectionId": "_pb_users_auth_",
        "hidden": false,
        "id": "relation2117886457",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "owner_id",
        "presentable": false,
        "required": true,
        "system": false,
        "type": "relation"
      },
      {
        "hidden": false,
        "id": "select3713686397",
        "maxSelect": 1,
        "name": "plan",
        "presentable": false,
        "required": true,
        "system": false,
        "type": "select",
        "values": [
          "trial",
          "basic",
          "pro"
        ]
      },
      {
        "hidden": false,
        "id": "date2463190971",
        "max": "",
        "min": "",
        "name": "trial_expires_at",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "date"
      },
      {
        "hidden": false,
        "id": "number2422433416",
        "max": 999,
        "min": 1,
        "name": "max_shops",
        "onlyInt": true,
        "presentable": false,
        "required": true,
        "system": false,
        "type": "number"
      },
      {
        "hidden": false,
        "id": "number2770142971",
        "max": 999,
        "min": 1,
        "name": "max_professionals",
        "onlyInt": false,
        "presentable": false,
        "required": true,
        "system": false,
        "type": "number"
      },
      {
        "hidden": false,
        "id": "date3053057214",
        "max": "",
        "min": "",
        "name": "billing_cycle",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "date"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": false,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": false,
        "type": "autodate"
      }
    ],
    "indexes": [
      "CREATE INDEX `idx_JkQ9hVKoch` ON `companies` (`cnpj`)"
    ],
    "system": false
  },
  {
    "id": "pbc_568792081",
    "listRule": "is_active = true || company_id.owner_id = @request.auth.id",
    "viewRule": "is_active = true || company_id.owner_id = @request.auth.id",
    "createRule": "company_id.owner_id = @request.auth.id",
    "updateRule": "company_id.owner_id = @request.auth.id",
    "deleteRule": "company_id.owner_id = @request.auth.id",
    "name": "payment_methods",
    "type": "base",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1579384326",
        "max": 0,
        "min": 0,
        "name": "name",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": false,
        "type": "text"
      },
      {
        "cascadeDelete": true,
        "collectionId": "pbc_3866053794",
        "hidden": false,
        "id": "relation2543524566",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "company_id",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "relation"
      },
      {
        "hidden": false,
        "id": "bool458715613",
        "name": "is_active",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "bool"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": false,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": false,
        "type": "autodate"
      }
    ],
    "indexes": [],
    "system": false
  },
  {
    "id": "pbc_1719698224",
    "listRule": "@request.auth.id != \"\"",
    "viewRule": "@request.auth.id != \"\"",
    "createRule": null,
    "updateRule": null,
    "deleteRule": null,
    "name": "segments",
    "type": "base",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1579384326",
        "max": 0,
        "min": 0,
        "name": "name",
        "pattern": "",
        "presentable": true,
        "primaryKey": false,
        "required": true,
        "system": false,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text2560465762",
        "max": 0,
        "min": 0,
        "name": "slug",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": false,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "file1704208859",
        "maxSelect": 1,
        "maxSize": 5242880,
        "mimeTypes": [
          "image/svg+xml",
          "image/png",
          "image/jpeg"
        ],
        "name": "icon",
        "presentable": false,
        "protected": false,
        "required": false,
        "system": false,
        "thumbs": [],
        "type": "file"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": false,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": false,
        "type": "autodate"
      }
    ],
    "indexes": [],
    "system": false
  },
  {
    "id": "pbc_863811952",
    "listRule": "",
    "viewRule": "",
    "createRule": "@request.auth.id != \"\"",
    "updateRule": "shop_id.owner_id = @request.auth.id",
    "deleteRule": "shop_id.owner_id = @request.auth.id",
    "name": "services",
    "type": "base",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1579384326",
        "max": 0,
        "min": 0,
        "name": "name",
        "pattern": "",
        "presentable": true,
        "primaryKey": false,
        "required": true,
        "system": false,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1843675174",
        "max": 0,
        "min": 0,
        "name": "description",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": false,
        "system": false,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "number3402113753",
        "max": null,
        "min": 0,
        "name": "price",
        "onlyInt": false,
        "presentable": false,
        "required": true,
        "system": false,
        "type": "number"
      },
      {
        "hidden": false,
        "id": "number2254405824",
        "max": null,
        "min": 0,
        "name": "duration",
        "onlyInt": true,
        "presentable": false,
        "required": true,
        "system": false,
        "type": "number"
      },
      {
        "hidden": false,
        "id": "bool458715613",
        "name": "is_active",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "bool"
      },
      {
        "cascadeDelete": true,
        "collectionId": "pbc_3896301928",
        "hidden": false,
        "id": "relation1293337821",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "shop_id",
        "presentable": false,
        "required": true,
        "system": false,
        "type": "relation"
      },
      {
        "cascadeDelete": false,
        "collectionId": "pbc_3292755704",
        "hidden": false,
        "id": "relation306617826",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "category_id",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "relation"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": false,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": false,
        "type": "autodate"
      }
    ],
    "indexes": [],
    "system": false
  },
  {
    "id": "pbc_3015497551",
    "listRule": "",
    "viewRule": "",
    "createRule": "@request.auth.id != \"\" &&\n@request.auth.role = \"dono\" &&\nshop_id.owner_id = @request.auth.id\n",
    "updateRule": "@request.auth.id != \"\" &&\n@request.auth.role = \"dono\" &&\nshop_id.owner_id = @request.auth.id\n",
    "deleteRule": "@request.auth.id != \"\" &&\n@request.auth.role = \"dono\" &&\nshop_id.owner_id = @request.auth.id\n",
    "name": "shop_hours",
    "type": "base",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "cascadeDelete": false,
        "collectionId": "pbc_3866053794",
        "hidden": false,
        "id": "relation2543524566",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "company_id",
        "presentable": false,
        "required": true,
        "system": false,
        "type": "relation"
      },
      {
        "cascadeDelete": false,
        "collectionId": "pbc_3896301928",
        "hidden": false,
        "id": "relation1293337821",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "shop_id",
        "presentable": false,
        "required": true,
        "system": false,
        "type": "relation"
      },
      {
        "hidden": false,
        "id": "select1267652495",
        "maxSelect": 1,
        "name": "weekday",
        "presentable": false,
        "required": true,
        "system": false,
        "type": "select",
        "values": [
          "dom",
          "seg",
          "ter",
          "qua",
          "qui",
          "sex",
          "sab"
        ]
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1345189255",
        "max": 0,
        "min": 0,
        "name": "start_time",
        "pattern": "^\\d{2}:\\d{2}$",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": false,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1096160257",
        "max": 0,
        "min": 0,
        "name": "end_time",
        "pattern": "^\\d{2}:\\d{2}$",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": false,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "bool1418641467",
        "name": "is_closed",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "bool"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": false,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": false,
        "type": "autodate"
      }
    ],
    "indexes": [
      "CREATE INDEX `idx_zCmYoRIcSW` ON `shop_hours` (\n  `company_id`,\n  `shop_id`,\n  `weekday`\n)"
    ],
    "system": false
  },
  {
    "id": "pbc_3896301928",
    "listRule": "",
    "viewRule": "",
    "createRule": "company_id.owner_id = @request.auth.id",
    "updateRule": "company_id.owner_id = @request.auth.id",
    "deleteRule": null,
    "name": "shops",
    "type": "base",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1579384326",
        "max": 0,
        "min": 0,
        "name": "name",
        "pattern": "",
        "presentable": true,
        "primaryKey": false,
        "required": true,
        "system": false,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text2560465762",
        "max": 0,
        "min": 0,
        "name": "slug",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": true,
        "system": false,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "file3834550803",
        "maxSelect": 1,
        "maxSize": 5242880,
        "mimeTypes": [],
        "name": "logo",
        "presentable": false,
        "protected": false,
        "required": false,
        "system": false,
        "thumbs": [],
        "type": "file"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text223244161",
        "max": 0,
        "min": 0,
        "name": "address",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": false,
        "system": false,
        "type": "text"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1146066909",
        "max": 0,
        "min": 0,
        "name": "phone",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": false,
        "system": false,
        "type": "text"
      },
      {
        "cascadeDelete": false,
        "collectionId": "pbc_568792081",
        "hidden": false,
        "id": "relation2650017717",
        "maxSelect": 999,
        "minSelect": 0,
        "name": "accepted_payment_methods",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "relation"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1910675334",
        "max": 0,
        "min": 0,
        "name": "pix_key",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": false,
        "system": false,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "select1401485156",
        "maxSelect": 1,
        "name": "pix_key_type",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "select",
        "values": [
          "cpf",
          "cnpj",
          "email",
          "telefone",
          "aleatoria"
        ]
      },
      {
        "cascadeDelete": true,
        "collectionId": "pbc_3866053794",
        "hidden": false,
        "id": "relation2543524566",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "company_id",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "relation"
      },
      {
        "cascadeDelete": false,
        "collectionId": "pbc_1719698224",
        "hidden": false,
        "id": "relation3676924589",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "segment_id",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "relation"
      },
      {
        "cascadeDelete": false,
        "collectionId": "_pb_users_auth_",
        "hidden": false,
        "id": "relation2117886457",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "owner_id",
        "presentable": false,
        "required": true,
        "system": false,
        "type": "relation"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text1843675174",
        "max": 0,
        "min": 0,
        "name": "description",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": false,
        "system": false,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "number2975870548",
        "max": null,
        "min": null,
        "name": "min_advance_time",
        "onlyInt": false,
        "presentable": false,
        "required": false,
        "system": false,
        "type": "number"
      },
      {
        "hidden": false,
        "id": "number3768161545",
        "max": null,
        "min": null,
        "name": "max_advance_time",
        "onlyInt": false,
        "presentable": false,
        "required": false,
        "system": false,
        "type": "number"
      },
      {
        "hidden": false,
        "id": "bool458715613",
        "name": "is_active",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "bool"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": false,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": false,
        "type": "autodate"
      }
    ],
    "indexes": [],
    "system": false
  },
  {
    "id": "pbc_3980638064",
    "listRule": "",
    "viewRule": "",
    "createRule": "",
    "updateRule": "",
    "deleteRule": "",
    "name": "subscriptions",
    "type": "base",
    "fields": [
      {
        "autogeneratePattern": "[a-z0-9]{15}",
        "hidden": false,
        "id": "text3208210256",
        "max": 15,
        "min": 15,
        "name": "id",
        "pattern": "^[a-z0-9]+$",
        "presentable": false,
        "primaryKey": true,
        "required": true,
        "system": true,
        "type": "text"
      },
      {
        "cascadeDelete": false,
        "collectionId": "pbc_3866053794",
        "hidden": false,
        "id": "relation2543524566",
        "maxSelect": 1,
        "minSelect": 0,
        "name": "company_id",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "relation"
      },
      {
        "hidden": false,
        "id": "select3713686397",
        "maxSelect": 1,
        "name": "plan",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "select",
        "values": [
          "trial",
          "basic",
          "pro"
        ]
      },
      {
        "hidden": false,
        "id": "number2392944706",
        "max": 199.99,
        "min": 59.99,
        "name": "amount",
        "onlyInt": false,
        "presentable": false,
        "required": true,
        "system": false,
        "type": "number"
      },
      {
        "hidden": false,
        "id": "date2932989418",
        "max": "",
        "min": "",
        "name": "period_start",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "date"
      },
      {
        "hidden": false,
        "id": "date179253131",
        "max": "",
        "min": "",
        "name": "period_end",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "date"
      },
      {
        "hidden": false,
        "id": "bool1753056537",
        "name": "is_paid",
        "presentable": false,
        "required": false,
        "system": false,
        "type": "bool"
      },
      {
        "autogeneratePattern": "",
        "hidden": false,
        "id": "text18589324",
        "max": 0,
        "min": 0,
        "name": "notes",
        "pattern": "",
        "presentable": false,
        "primaryKey": false,
        "required": false,
        "system": false,
        "type": "text"
      },
      {
        "hidden": false,
        "id": "autodate2990389176",
        "name": "created",
        "onCreate": true,
        "onUpdate": false,
        "presentable": false,
        "system": false,
        "type": "autodate"
      },
      {
        "hidden": false,
        "id": "autodate3332085495",
        "name": "updated",
        "onCreate": true,
        "onUpdate": true,
        "presentable": false,
        "system": false,
        "type": "autodate"
      }
    ],
    "indexes": [],
    "system": false
  }
]
--- FIM DO ARQUIVO: pb_schema.md ---


--- INICIO DO ARQUIVO: projeto_contexto_v1.0.91.md ---
Path: projeto_contexto_v1.0.91.md
------------------------------

--- FIM DO ARQUIVO: projeto_contexto_v1.0.91.md ---


--- INICIO DO ARQUIVO: Projeto_TeAgendei_v2.1.md ---
Path: Projeto_TeAgendei_v2.1.md
------------------------------
# **ğŸ“˜ PROJETO TEAGÃŠNDEI â€” DOCUMENTAÃ‡ÃƒO OFICIAL v2.1 (HÃBRIDA)**

Documento Final â€” Produto \+ Engenharia  
Blueprint completo do sistema antes da codificaÃ§Ã£o.

## **1\. VISÃƒO GERAL DO PRODUTO**

### **1.1. O que Ã© o TeAgendei**

O TeAgendei Ã© uma plataforma SaaS de agendamentos voltada para pequenos negÃ³cios de serviÃ§os:

* Barbearias  
* SalÃµes  
* Esmalterias  
* ClÃ­nicas estÃ©ticas  
* Profissionais autÃ´nomos

Ele funciona como um motor de agenda \+ operaÃ§Ã£o \+ faturamento, permitindo que um estabelecimento:

* Gerencie clientes  
* Controle profissionais  
* OfereÃ§a agendamento online  
* Acompanhe mÃ©tricas  
* Tenha visÃ£o do dia a dia da operaÃ§Ã£o

Ã‰ uma soluÃ§Ã£o desenhada para ser simples, moderna e escalÃ¡vel, com foco em velocidade e experiÃªncia.

### **1.2. Quem usa**

* **Dono (Administrador):** Controla tudo: empresa, unidades, equipe, agenda, serviÃ§os, preÃ§os, faturamento.  
* **Profissional (Staff):** SÃ³ vÃª sua prÃ³pria agenda. Registra atendimentos, pagamentos e cancelamentos.  
* **Cliente Final:** Agenda via link pÃºblico /book/:slug, e acompanha histÃ³rico no /client.

### **1.3. Problemas que resolve**

**Para o Dono:**

* Falta de controle do negÃ³cio  
* Agenda no WhatsApp  
* Overbooking  
* Zero visibilidade financeira

**Para o Profissional:**

* Agenda confusa  
* DependÃªncia do dono para saber horÃ¡rios  
* Falta de histÃ³rico e indicadores

**Para o Cliente:**

* Dificuldade para agendar  
* DesconfianÃ§a sobre horÃ¡rios  
* ComunicaÃ§Ã£o ineficiente

### **1.4. Diferenciais do TeAgendei**

* Multi-tenant real (empresa \> unidade \> profissional)  
* Engine de agendamento inteligente  
* Interface limpa e responsiva  
* RÃ¡pido onboarding  
* Link pÃºblico para agendamento por loja  
* Estrutura robusta com PocketBase \+ React  
* Nunca hÃ¡ overbooking  
* Tudo sincronizado em tempo real

## **2\. VISÃƒO ESTRATÃ‰GICA DO SAAS**

O TeAgendei nasce como uma soluÃ§Ã£o para barbearias, mas sua arquitetura permite suportar:

* ClÃ­nicas mÃ©dicas  
* EstÃºdios de tatuagem  
* Consultorias  
* Nail studios  
* Pet shops de banho e tosa

O sistema Ã© segmentÃ¡vel, graÃ§as Ã  coleÃ§Ã£o segments no PocketBase.

## **3\. ARQUITETURA DO SISTEMA (VisÃ£o Macro)**

**Fluxo:** CLIENTE â†’ React SPA â†’ API (PocketBase) â†’ SQLite Database

### **Tecnologias principais**

* React 19  
* TypeScript  
* Vite  
* Tailwind  
* React Router v6  
* PocketBase (backend e banco)  
* Context API

### **3.1. Por que PocketBase?**

* Backend completo sem necessidade de Node.js  
* AutenticaÃ§Ã£o robusta  
* Alta performance  
* Simplicidade  
* Regras de acesso integradas  
* Banco SQLite com seguranÃ§a  
* Consultas rÃ¡pidas  
* Realtime

### **3.2. Multi-tenant explicado**

Cada usuÃ¡rio pertence a uma empresa (company) e opcionalmente a uma unidade (shop).

**Estrutura:**

Company  
 â””â”€â”€ Shops  
       â”œâ”€â”€ Services  
       â”œâ”€â”€ Staff  
       â””â”€â”€ Appointments

**Regras no PocketBase garantem que:**

* O dono sÃ³ vÃª dados da prÃ³pria empresa  
* Staff sÃ³ vÃª dados da prÃ³pria loja  
* Cliente sÃ³ vÃª seus prÃ³prios agendamentos

## **4\. MODELO DE DADOS â€” EXPLICAÃ‡ÃƒO HUMANIZADA**

Os dados sÃ£o organizados em coleÃ§Ãµes:

| ColeÃ§Ã£o | FunÃ§Ã£o |
| :---- | :---- |
| users | Dono, cliente e staff |
| companies | Empresa (CNPJ, razÃ£o social, plano) |
| shops | Unidade da empresa |
| shop\_hours | HorÃ¡rio de funcionamento |
| services | ServiÃ§os ofertados |
| appointments | Agendamentos |
| categories | Categorias de serviÃ§os |
| payment\_methods | Formas de pagamento |
| segments | Segmentos (ex: barbearia) |

**Exemplo de fluxo narrativo:**

1. O dono cria a empresa.  
2. Cria a primeira unidade (shop).  
3. Define horÃ¡rio de funcionamento.  
4. Registra profissionais.  
5. Cliente acessa /book/:slug.  
6. Faz agendamento.  
7. Profissional vÃª agenda do dia.  
8. Dono vÃª mÃ©tricas no dashboard.

## **5\. FLUXOS DO SISTEMA (HÃBRIDO)**

Vamos agora narrar cada fluxo de maneira prÃ¡tica e tÃ©cnica.

### **5.1. Fluxo de Onboarding do Dono**

Quando o dono entra pela primeira vez:

1. **Passo 1 â€” Dados da Empresa:** Nome da empresa, CNPJ (opcional), Segmento (opcional).  
2. **Passo 2 â€” Criar Loja:** Nome da unidade, Slug (URL pÃºblica), Telefone, EndereÃ§o.  
3. **Passo 3 â€” HorÃ¡rio de Funcionamento:** Define funcionamento de segunda Ã  sÃ¡bado.  
4. **Resultado final:** Dono Ã© redirecionado para o Dashboard.

### **5.2. Fluxo de Agendamento (Cliente)**

Acessa: /book/:slug

1. Passo 1 â†’ Escolhe serviÃ§o  
2. Passo 2 â†’ Escolhe profissional  
3. Passo 3 â†’ Escolhe data  
4. Passo 4 â†’ Escolhe horÃ¡rio (engine calcula slots)  
5. Passo 5 â†’ Confirma nome/telefone  
6. Sistema cria appointment

### **5.3. Fluxo do Profissional**

Acessa /app/staff/agenda.

* VÃª sua agenda do dia  
* Marca como concluÃ­do  
* Marca paciente como pago  
* Cancela quando necessÃ¡rio  
* *Simples, direto, funcional.*

### **5.4. Fluxo do Cliente Autenticado**

Acessa /client.

* VÃª prÃ³ximos agendamentos  
* Cancela se faltar mais de 2h  
* VÃª histÃ³rico completo

### **5.5. Fluxo do Dono no Dashboard**

Mostra:

* Agendamentos do dia  
* Faturamento do dia  
* OcupaÃ§Ã£o  
* PrÃ³ximos atendimentos  
* Atalhos para serviÃ§os, equipe, configuraÃ§Ãµes

## **6\. ENGINE DE BOOKING â€” NÃšCLEO DO SISTEMA**

Ela calcula:

* horÃ¡rios vÃ¡lidos  
* horÃ¡rios bloqueados  
* fusos horÃ¡rios  
* duraÃ§Ã£o dos serviÃ§os  
* min/max advance time  
* disponibilidade do profissional  
* horÃ¡rios de funcionamento da loja  
* conflitos com agendamentos existentes

Exemplo:  
Se o serviÃ§o dura 30 min, e a loja funciona das 9h Ã s 18h:  
**Slots possÃ­veis (local):**

* 09:00  
* 09:05  
* 09:10  
* â€¦  
* 17:30  
* 17:35

**Depois aplicamos:**

* bloqueio por agendamento  
* bloqueio por antecedÃªncia mÃ­nima  
* bloqueio por antecedÃªncia mÃ¡xima

## **7\. ARQUITETURA FRONTEND (EXPLICADA)**

src/  
  react-app/  
    contexts/          \# Auth \+ Tenant  
    lib/api/           \# ComunicaÃ§Ã£o PocketBase  
    components/        \# UI e Booking  
    pages/             \# Telas principais  
    routes/            \# Router \+ ProtectedRoute  
    App.tsx  
  shared/  
    types.ts  
    utils/  
      date.ts  
      booking.ts

## **âœ… ESTRUTURA FINAL DO TEAGENDEI (PASTA POR PASTA, ARQUIVO POR ARQUIVO)**

**VersÃ£o Oficial v2.1**

**IMPORTANTE:** Essa Ã© a Ã¡rvore exata que criaremos atÃ© o final das FASES 4â€“9. Nada fora disso serÃ¡ criado. Tudo estarÃ¡ documentado antes de codar.

### **ğŸ“‚ /src**

src/  
  react-app/  
  shared/

### **ğŸ“‚ 1\. /src/react-app**

react-app/  
  App.tsx  
  main.tsx  
  routes/  
    AppRouter.tsx  
    ProtectedRoute.tsx  
  contexts/  
    AuthContext.tsx  
    TenantContext.tsx  
  lib/  
    api/  
      pocketbase.ts  
      auth.ts  
      companies.ts  
      shops.ts  
      services.ts  
      appointments.ts  
      customers.ts  
    utils/  
      date.ts  
      booking.ts  
      format.ts  
  components/  
    layout/  
      AppLayout.tsx  
      Sidebar.tsx  
      Header.tsx  
    booking/  
      StepService.tsx  
      StepProfessional.tsx  
      StepDateTime.tsx  
      StepConfirm.tsx  
    common/  
      Button.tsx  
      Input.tsx  
      Select.tsx  
      Modal.tsx  
      Card.tsx  
  pages/  
    auth/  
      LoginPage.tsx  
    onboarding/  
      OnboardingPage.tsx  
    owner/  
      DashboardPage.tsx  
      ShopsPage.tsx  
      NewShopPage.tsx  
      ServicesPage.tsx  
      StaffPage.tsx  
      SettingsPage.tsx  
    staff/  
      StaffAgendaPage.tsx  
    booking/  
      BookPage.tsx  
    client/  
      ClientPanelPage.tsx

### **ğŸ“‚ 2\. /src/shared**

shared/  
  types.ts  
  utils/  
    validation.ts  
    masks.ts

### **ğŸ§ª ValidaÃ§Ã£o prÃ¡tica â€” Contagem total de arquivos**

Para garantir precisÃ£o:

| Ãrea | Qtd arquivos |
| :---- | :---- |
| react-app/ | 33 |
| shared/ | 3 |
| **TOTAL DO PROJETO** | **36 arquivos** |

Isso significa que a Ã¡rvore final SEMPRE terÃ¡ 36 arquivos, exceto se futuramente adicionarmos testes, documentaÃ§Ã£o ou assets.

## **ğŸ§¬ CLASSIFICAÃ‡ÃƒO DOS ARQUIVOS POR FUNÃ‡ÃƒO**

### **âœ… 1\. Raiz de aplicaÃ§Ã£o (2 arquivos)**

* App.tsx  
* main.tsx

### **âœ… 2\. Roteamento (2 arquivos)**

* AppRouter.tsx  
* ProtectedRoute.tsx

### **âœ… 3\. Contextos (2 arquivos)**

* AuthContext.tsx  
* TenantContext.tsx

### **âœ… 4\. API PocketBase (7 arquivos)**

* pocketbase.ts  
* auth.ts  
* companies.ts  
* shops.ts  
* services.ts  
* appointments.ts  
* customers.ts

### **âœ… 5\. Utils (3 arquivos)**

* date.ts  
* booking.ts  
* format.ts

### **âœ… 6\. Componentes de UI (8 arquivos)**

* Button, Input, Select, Modal, Card  
* Sidebar, Header, AppLayout

### **âœ… 7\. Booking Steps (4 arquivos)**

* StepService  
* StepProfessional  
* StepDateTime  
* StepConfirm

### **âœ… 8\. PÃ¡ginas (12 arquivos)**

* **Auth:** LoginPage  
* **Onboarding:** OnboardingPage  
* **Owner:** DashboardPage, ShopsPage, NewShopPage, ServicesPage, StaffPage, SettingsPage  
* **Staff:** StaffAgendaPage  
* **Booking:** BookPage  
* **Client:** ClientPanelPage

### **âœ… 9\. Shared (3 arquivos)**

* types.ts  
* validation.ts  
* masks.ts

*Pilares:*

* **Contexts** centralizam estado  
* **API** centraliza chamadas ao PB  
* **Pages** integram tudo  
* **Components** compÃµem interface

## **8\. API DO FRONTEND â€” CONTRATOS**

* **auth.ts:** login, logout, getCurrentUser  
* **shops.ts:** listOwnerShops, getShopBySlug, createShop  
* **services.ts:** getServicesByShop, createService  
* **appointments.ts:** createAppointment, listAppointmentsByProfessional, listAppointmentsByClient  
* **clients.ts:** getClientAppointments

## **9\. PÃGINAS PRINCIPAIS â€” UX \+ TÃ‰C.**

### **9.1. LoginPage**

Simples, clara, eficiente.

### **9.2. Onboarding pages**

Wizard de 3 etapas.

### **9.3. DashboardPage**

KPIs \+ tabela do dia.

### **9.4. BookPage**

Fluxo de 4 passos com engine real.

### **9.5. ClientPanelPage**

PrÃ³ximos \+ histÃ³rico.

### **9.6. StaffAgendaPage**

OperaÃ§Ã£o do dia a dia.

## **10\. DEPLOY & BUILD â€” DOCUMENTAÃ‡ÃƒO FINAL**

### **Frontend**

* Vite â†’ build â†’ Cloudflare Pages  
* VariÃ¡vel ENV: VITE\_POCKETBASE\_URL

### **Backend (PB)**

* Rodando em VPS: pocketbase serve \--http=0.0.0.0:8090  
* Proxy reverso (Caddy):  
  api.teagendei.com {  
    reverse\_proxy 127.0.0.1:8090  
  }

* Backups diÃ¡rios  
* HTTPS automÃ¡tico

## **11\. ROADMAP OFICIAL**

**Faixa completa:**

1. **Fase 0** â€” Resumo TÃ©cnico  
2. **Fase 1** â€” Arquitetura Geral  
3. **Fase 2** â€” Tipos TS  
4. **Fase 3** â€” Estrutura Final  
5. **Fase 4** â€” Contexts  
6. **Fase 5** â€” API PocketBase  
7. **Fase 6** â€” Booking Engine  
8. **Fase 7** â€” PÃ¡ginas completas  
9. **Fase 8** â€” Deploy  
10. **Fase 9** â€” Entrega Final (vFinal.md)
--- FIM DO ARQUIVO: Projeto_TeAgendei_v2.1.md ---


--- INICIO DO ARQUIVO: StaffBookingModal.tsx ---
Path: StaffBookingModal.tsx
------------------------------
import { useState, useEffect } from "react";
import { X, User as UserIcon, Calendar, Clock, Scissors, Search, Ban, CheckCircle } from "lucide-react";
import { useAuth } from "@/react-app/contexts/AuthContext";
import { getServicesByShop } from "@/react-app/lib/api/services";
import { getProfessionalsByShop } from "@/react-app/lib/api/staff";
import { generateSlots } from "@/react-app/lib/utils/slots";
import { getShopHours, getProfessionalAppointments } from "@/react-app/lib/api/availability";
import { createStaffAppointment, searchClients } from "@/react-app/lib/api/appointments";
import { Service, User, TimeSlot, AppointmentStatus } from "@/shared/types";

interface StaffBookingModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
}

export function StaffBookingModal({ isOpen, onClose, onSuccess }: StaffBookingModalProps) {
  const { user } = useAuth();

  // Tipo de AÃ§Ã£o: AGENDAR ou BLOQUEAR
  const [modalType, setModalType] = useState<"appointment" | "block">("appointment");

  // Estados Comuns
  const [selectedBarber, setSelectedBarber] = useState<string>("");
  const [date, setDate] = useState<string>(new Date().toISOString().split("T")[0]);
  const [selectedSlot, setSelectedSlot] = useState<string | null>(null);

  // Estados para Agendamento
  const [selectedService, setSelectedService] = useState<string>("");
  const [clientMode, setClientMode] = useState<"registered" | "guest">("guest");
  const [guestName, setGuestName] = useState("");
  const [guestPhone, setGuestPhone] = useState("");
  const [clientSearch, setClientSearch] = useState("");
  const [foundClients, setFoundClients] = useState<User[]>([]);
  const [selectedClient, setSelectedClient] = useState<User | null>(null);

  // Estados para Bloqueio
  const [blockReason, setBlockReason] = useState("");
  const [blockDuration, setBlockDuration] = useState(60); // PadrÃ£o 1 hora

  // Dados Carregados
  const [services, setServices] = useState<Service[]>([]);
  const [barbers, setBarbers] = useState<User[]>([]);
  const [slots, setSlots] = useState<TimeSlot[]>([]);

  const [loading, setLoading] = useState(false);
  const [slotLoading, setSlotLoading] = useState(false);

  useEffect(() => {
    if (isOpen && user?.shop_id) {
      getServicesByShop(user.shop_id).then(setServices);
      getProfessionalsByShop(user.shop_id).then((users) => {
        setBarbers(users);
        if (users.find((u) => u.id === user.id)) {
          setSelectedBarber(user.id);
        }
      });
    }
  }, [isOpen, user?.shop_id]);

  useEffect(() => {
    if (!selectedBarber || !date || !user?.shop_id) {
      setSlots([]);
      return;
    }

    // DuraÃ§Ã£o para exibiÃ§Ã£o em grade
    const durationForGrid =
      modalType === "appointment"
        ? services.find((s) => s.id === selectedService)?.duration || 30
        : blockDuration;

    // Agendamentos requerem serviÃ§o selecionado
    if (modalType === "appointment" && !selectedService) {
      setSlots([]);
      return;
    }

    // Busca os slots disponÃ­veis
    async function fetchSlots() {
      setSlotLoading(true);
      try {
        const [hours, appointments] = await Promise.all([
          getShopHours(user!.shop_id!),
          getProfessionalAppointments(selectedBarber, date),
        ]);

        const generated = generateSlots(date, durationForGrid, hours, appointments);
        setSlots(generated);
      } catch (err) {
        console.error(err);
      } finally {
        setSlotLoading(false);
      }
    }

    fetchSlots();
  }, [selectedService, selectedBarber, date, user?.shop_id, services, modalType, blockDuration]);

  async function handleConfirm() {
    if (!user?.shop_id || !selectedSlot || !selectedBarber) return;

    // Payload Base
    const payload: any = {
      shop_id: user.shop_id,
      barber_id: selectedBarber,
      start_time: selectedSlot,
    };

    if (modalType === "appointment") {
      const serviceObj = services.find((s) => s.id === selectedService);
      if (!serviceObj) return;

      if (clientMode === "guest" && !guestName.trim()) return alert("Digite o nome do cliente.");
      if (clientMode === "registered" && !selectedClient) return alert("Selecione um cliente.");

      payload.status = AppointmentStatus.Confirmed;
      payload.service_id = selectedService;
      payload.duration_minutes = serviceObj.duration;
      payload.total_amount = serviceObj.price;
      payload.client_id = clientMode === "registered" ? selectedClient?.id : undefined;
      payload.customer_name = clientMode === "guest" ? guestName : undefined;
      payload.customer_phone = clientMode === "guest" ? guestPhone : undefined;
    } else {
      // BLOQUEIO DE HORÃRIO
      if (!blockReason.trim()) return alert("Digite o motivo do bloqueio (ex: AlmoÃ§o).");

      payload.status = AppointmentStatus.Blocked; // CÃ³digo 6
      payload.notes = blockReason;
      payload.duration_minutes = blockDuration; // Respeita o duration
    }

    setLoading(true);
    try {
      await createStaffAppointment(payload);
      alert(modalType === "appointment" ? "Agendado com sucesso!" : "HorÃ¡rio bloqueado!");
      onSuccess();
      onClose();

      // Reset
      setSelectedSlot(null);
      setGuestName("");
      setBlockReason("");
    } catch (error: any) {
      console.error(error);
      alert("Erro ao salvar.");
    } finally {
      setLoading(false);
    }
  }

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 text-slate-50">
      <div className="bg-slate-900 border border-slate-800 w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
        {/* HEADER */}
        <div className="flex justify-between items-center p-6 border-b border-slate-800">
          <div className="flex gap-4">
            <button
              onClick={() => setModalType("appointment")}
              className={`text-lg font-bold pb-1 border-b-2 transition ${
                modalType === "appointment"
                  ? "text-emerald-400 border-emerald-400"
                  : "text-slate-500 border-transparent"
              }`}
            >
              Novo Agendamento
            </button>
            <button
              onClick={() => setModalType("block")}
              className={`text-lg font-bold pb-1 border-b-2 transition ${
                modalType === "block"
                  ? "text-red-400 border-red-400"
                  : "text-slate-500 border-transparent"
              }`}
            >
              Bloquear HorÃ¡rio
            </button>
          </div>
          <button onClick={onClose} className="text-slate-400 hover:text-white">
            <X size={24} />
          </button>
        </div>

        {/* CONTENT */}
        <div className="flex-1 overflow-y-auto p-6 space-y-6">
          {/* 1. CONFIGURAÃ‡ÃƒO (VARIA POR TIPO) */}
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {modalType === "appointment" ? (
              <div>
                <label className="block text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
                  <Scissors size={14} /> ServiÃ§o
                </label>
                <select
                  value={selectedService}
                  onChange={(e) => setSelectedService(e.target.value)}
                  className="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:ring-2 focus:ring-emerald-500 outline-none"
                >
                  <option value="">Selecione...</option>
                  {services.map((s) => (
                    <option key={s.id} value={s.id}>
                      {s.name} ({s.duration} min) - R$ {s.price}
                    </option>
                  ))}
                </select>
              </div>
            ) : (
              <div>
                <label className="block text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
                  <Ban size={14} /> Motivo do Bloqueio
                </label>
                <input
                  type="text"
                  placeholder="Ex: AlmoÃ§o, MÃ©dico..."
                  value={blockReason}
                  onChange={(e) => setBlockReason(e.target.value)}
                  className="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:ring-2 focus:ring-red-500 outline-none"
                />
              </div>
            )}

            <div>
              <label className="block text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
                <UserIcon size={14} /> Profissional
              </label>
              <select
                value={selectedBarber}
                onChange={(e) => setSelectedBarber(e.target.value)}
                className="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:ring-2 focus:ring-emerald-500 outline-none"
              >
                <option value="">Selecione...</option>
                {barbers.map((b) => (
                  <option key={b.id} value={b.id}>
                    {b.name}
                  </option>
                ))}
              </select>
            </div>
          </div>

          {/* DURAÃ‡ÃƒO MANUAL PARA BLOQUEIO */}
          {modalType === "block" && (
            <div>
              <label className="block text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
                <Clock size={14} /> DuraÃ§Ã£o do Bloqueio (minutos)
              </label>
              <div className="flex gap-2">
                {[30, 60, 90, 120].map((m) => (
                  <button
                    key={m}
                    onClick={() => setBlockDuration(m)}
                    className={`px-4 py-2 rounded-lg text-sm border ${
                      blockDuration === m
                        ? "bg-red-500/20 border-red-500 text-red-400"
                        : "bg-slate-800 border-slate-700 text-slate-400 hover:border-red-500"
                    }`}
                  >
                    {m} min
                  </button>
                ))}
                <input
                  type="number"
                  value={blockDuration}
                  onChange={(e) => setBlockDuration(Number(e.target.value))}
                  className="w-20 bg-slate-800 border border-slate-700 rounded-lg p-2 text-center text-white focus:ring-2 focus:ring-red-500 outline-none"
                />
              </div>
            </div>
          )}

          {/* 2. DATA E HORÃRIO */}
          <div className="border-t border-slate-800 pt-6">
            <div className="flex flex-col sm:flex-row gap-4 mb-4">
              <div className="w-full sm:w-1/3">
                <label className="block text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
                  <Calendar size={14} /> Data
                </label>
                <input
                  type="date"
                  value={date}
                  onChange={(e) => setDate(e.target.value)}
                  className="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:ring-2 focus:ring-emerald-500 outline-none"
                />
              </div>
              <div className="flex-1">
                <label className="block text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
                  <Clock size={14} /> HorÃ¡rios DisponÃ­veis
                </label>
                {slotLoading ? (
                  <div className="text-slate-500 text-sm animate-pulse">Calculando...</div>
                ) : slots.length > 0 ? (
                  <div className="grid grid-cols-4 sm:grid-cols-6 gap-2">
                    {slots.map((slot) => (
                      <button
                        key={slot.time}
                        disabled={!slot.isAvailable}
                        onClick={() => setSelectedSlot(slot.startISO)}
                        className={`text-xs py-2 rounded-lg border transition-all ${
                          selectedSlot === slot.startISO
                            ? (modalType === "appointment"
                                ? "bg-emerald-500 border-emerald-500"
                                : "bg-red-500 border-red-500") + " text-white font-bold"
                            : slot.isAvailable
                            ? "bg-slate-800 border-slate-700 text-slate-300 hover:border-slate-500"
                            : "bg-slate-900 border-slate-800 text-slate-600 cursor-not-allowed opacity-50"
                        }`}
                      >
                        {slot.time}
                      </button>
                    ))}
                  </div>
                ) : (
                  <div className="text-slate-500 text-sm italic border border-dashed border-slate-700 rounded p-2 text-center">
                    {modalType === "appointment" && !selectedService
                      ? "Selecione um serviÃ§o primeiro."
                      : "Nenhum horÃ¡rio disponÃ­vel."}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* FOOTER */}
        <div className="p-6 border-t border-slate-800 flex justify-end gap-3 bg-slate-900/50">
          <button
            onClick={onClose}
            className="px-4 py-2 text-slate-400 hover:text-white transition text-sm"
          >
            Cancelar
          </button>
          <button
            onClick={handleConfirm}
            disabled={loading || !selectedSlot}
            className={`px-6 py-2 rounded-lg font-medium text-white transition disabled:opacity-50 ${
              modalType === "appointment"
                ? "bg-emerald-500 hover:bg-emerald-600"
                : "bg-red-500 hover:bg-red-600"
            }`}
          >
            {loading
              ? "Salvando..."
              : modalType === "appointment"
              ? "Confirmar Agendamento"
              : "Confirmar Bloqueio"}
          </button>
        </div>
      </div>
    </div>
  );
}
--- FIM DO ARQUIVO: StaffBookingModal.tsx ---


--- INICIO DO ARQUIVO: tsconfig.json ---
Path: tsconfig.json
------------------------------
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowJs": false,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,


    "jsx": "react-jsx",

    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}

--- FIM DO ARQUIVO: tsconfig.json ---


--- INICIO DO ARQUIVO: tsconfig.node.json ---
Path: tsconfig.node.json
------------------------------
{
  "compilerOptions": {
    "composite": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}

--- FIM DO ARQUIVO: tsconfig.node.json ---


--- INICIO DO ARQUIVO: vite.config.ts ---
Path: vite.config.ts
------------------------------
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// Config sem path e sem __dirname
export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': '/src'
    }
  }
})

--- FIM DO ARQUIVO: vite.config.ts ---


--- INICIO DO ARQUIVO: .cursor\worktrees.json ---
Path: .cursor\worktrees.json
------------------------------
{
  "setup-worktree": [
    "npm install"
  ]
}

--- FIM DO ARQUIVO: .cursor\worktrees.json ---


--- INICIO DO ARQUIVO: src\index.css ---
Path: src\index.css
------------------------------
:root {
  font-family: Inter, system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;
  
  /* ForÃ§a o esquema dark jÃ¡ que o design usa cores escuras */
  color-scheme: dark; 
  background-color: #020617; /* slate-950 aproximado */
  color: rgba(255, 255, 255, 0.87);
}

body {
  margin: 0;
  min-height: 100vh;
}
--- FIM DO ARQUIVO: src\index.css ---


--- INICIO DO ARQUIVO: src\vite-env.d.ts ---
Path: src\vite-env.d.ts
------------------------------
/// <reference types="vite/client" />

--- FIM DO ARQUIVO: src\vite-env.d.ts ---


--- INICIO DO ARQUIVO: src\react-app\App.tsx ---
Path: src\react-app\App.tsx
------------------------------
// src/react-app/App.tsx
import { AuthProvider } from "./contexts/AuthContext";
import { TenantProvider } from "./contexts/TenantContext";
import AppRouter from "./routes/AppRouter";

export default function App() {
  return (
    <AuthProvider>
      <TenantProvider>
        {/* O AppRouter jÃ¡ contÃ©m BrowserRouter â€” nÃ£o duplicar aqui */}
        <AppRouter />
      </TenantProvider>
    </AuthProvider>
  );
}

--- FIM DO ARQUIVO: src\react-app\App.tsx ---


--- INICIO DO ARQUIVO: src\react-app\main.tsx ---
Path: src\react-app\main.tsx
------------------------------
// src/react-app/main.tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import '../index.css'; // se seu index.css estiver em src/index.css, ajuste o caminho

ReactDOM.createRoot(document.getElementById('root') as HTMLElement).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
);

--- FIM DO ARQUIVO: src\react-app\main.tsx ---


--- INICIO DO ARQUIVO: src\react-app\components\booking\StepConfirm.tsx ---
Path: src\react-app\components\booking\StepConfirm.tsx
------------------------------
import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { Service, User, TimeSlot, PaymentMethod } from "@/shared/types";
import { createAppointment } from "../../lib/api/client";
import { useAuth } from "../../contexts/AuthContext";
import { pb } from "../../lib/api/pocketbase";

interface StepConfirmProps {
  shop: any; 
  service: Service;
  professional: User | null; 
  timeSlot: TimeSlot;
  onBack: () => void;
}

export default function StepConfirm({
  shop,
  service,
  professional,
  timeSlot,
  onBack,
}: StepConfirmProps) {
  const { user } = useAuth();
  const navigate = useNavigate();
  
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState("");

  const [paymentMethods, setPaymentMethods] = useState<PaymentMethod[]>([]);
  const [selectedPayment, setSelectedPayment] = useState("");

  // Busca mÃ©todos de pagamento
  useEffect(() => {
    let isMounted = true;
    async function loadPayments() {
        if (!shop?.accepted_payment_methods || shop.accepted_payment_methods.length === 0) return;
        
        try {
            const filterQuery = shop.accepted_payment_methods.map((id: string) => `id="${id}"`).join(" || ");
            if (filterQuery) {
                const methods = await pb.collection("payment_methods").getFullList<PaymentMethod>({
                    filter: filterQuery,
                    sort: "name"
                });
                if (isMounted) {
                    setPaymentMethods(methods);
                    if (methods.length > 0) setSelectedPayment(methods[0].id);
                }
            }
        } catch (err: any) {
            if (err.status === 0 || err.isAbort) return;
            console.error("Erro pagamentos", err);
        }
    }
    loadPayments();
    return () => { isMounted = false; };
  }, [shop]);

  const handleConfirm = async () => {
    if (!user) {
      alert("VocÃª precisa estar logado para finalizar.");
      navigate("/register?mode=client");
      return;
    }

    setSubmitting(true);
    setError("");

    try {
      // 1. Define quem Ã© o profissional responsÃ¡vel
      // Se user escolheu 'Qualquer' (null), usamos o ID do dono da loja como fallback
      const finalBarberId = professional?.id || shop.owner_id;

      if (!finalBarberId) {
          throw new Error("Erro de configuraÃ§Ã£o: A loja nÃ£o possui um responsÃ¡vel padrÃ£o definido.");
      }

      // 2. Cria o agendamento
      await createAppointment({
        shop_id: shop.id,
        client_id: user.id,
        service_id: service.id,
        barber_id: finalBarberId,
        start_time: timeSlot.startISO,
        end_time: timeSlot.endISO,
        total_amount: service.price,
        payment_method: selectedPayment || undefined,
      });

      alert("Agendamento realizado com sucesso!");
      navigate("/client");
      
    } catch (err: any) {
      console.error("Erro ao agendar:", err);
      // Tratamento especÃ­fico para erro 400 (ValidaÃ§Ã£o)
      if (err.status === 400) {
        // Tenta ler a resposta do servidor para ver qual campo falhou
        const data = err.data?.data || {};
        const fieldErrors = Object.keys(data).join(", ");
        setError(`Erro de validaÃ§Ã£o nos campos: ${fieldErrors || "Dados invÃ¡lidos"}.`);
      } else {
        setError(err.message || "Erro ao confirmar agendamento. Tente novamente.");
      }
    } finally {
      setSubmitting(false);
    }
  };

  const dateDisplay = new Date(timeSlot.startISO).toLocaleDateString("pt-BR", { 
      weekday: 'long', day: 'numeric', month: 'long' 
  });
  
  const priceDisplay = new Intl.NumberFormat('pt-BR', { 
      style: 'currency', currency: 'BRL' 
  }).format(service.price);

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
      <div>
        <button onClick={onBack} className="text-xs text-slate-400 hover:text-white mb-2">
          â† Voltar
        </button>
        <h2 className="text-xl font-bold text-white">Confirme os dados</h2>
        <p className="text-sm text-slate-400">Quase lÃ¡!</p>
      </div>

      <div className="bg-slate-900 border border-white/10 rounded-2xl p-6 space-y-4">
        
        {/* ServiÃ§o */}
        <div className="flex justify-between items-start pb-4 border-b border-white/5">
          <div>
            <p className="text-xs text-slate-500 uppercase tracking-wider mb-1">ServiÃ§o</p>
            <p className="font-semibold text-white">{service.name}</p>
            <p className="text-xs text-slate-400">{service.duration} min</p>
          </div>
          <p className="font-bold text-emerald-400">{priceDisplay}</p>
        </div>

        {/* Profissional */}
        <div className="pb-4 border-b border-white/5">
          <p className="text-xs text-slate-500 uppercase tracking-wider mb-1">Profissional</p>
          <div className="flex items-center gap-3">
             <div className="h-8 w-8 rounded-full bg-slate-800 flex items-center justify-center text-xs font-bold text-slate-400 overflow-hidden">
                {professional?.avatar ? (
                   <img src={professional.avatar} className="h-full w-full object-cover"/>
                ) : (
                   professional?.name?.[0] || "?"
                )}
             </div>
             <p className="font-medium text-white">
                {professional ? professional.name : "Qualquer profissional disponÃ­vel"}
             </p>
          </div>
        </div>

        {/* Data e Hora */}
        <div>
           <p className="text-xs text-slate-500 uppercase tracking-wider mb-1">Data e Hora</p>
           <p className="text-lg font-bold text-white capitalize">
              {dateDisplay}
           </p>
           <p className="text-2xl font-mono text-emerald-400">
              {timeSlot.time}
           </p>
        </div>

      </div>

      {/* SELEÃ‡ÃƒO DE PAGAMENTO */}
      {paymentMethods.length > 0 && (
          <div className="bg-slate-900 border border-white/10 rounded-2xl p-6">
            <h3 className="text-sm font-semibold text-white mb-4">Como prefere pagar?</h3>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                {paymentMethods.map(pm => (
                    <label 
                        key={pm.id} 
                        className={`flex items-center gap-3 p-3 rounded-xl border cursor-pointer transition relative select-none
                        ${selectedPayment === pm.id 
                            ? "bg-emerald-500/10 border-emerald-500 text-emerald-400" 
                            : "bg-black/20 border-white/5 hover:border-white/20 text-slate-400"}`}
                    >
                        <input 
                            type="radio" 
                            name="payment" 
                            value={pm.id} 
                            checked={selectedPayment === pm.id}
                            onChange={(e) => setSelectedPayment(e.target.value)}
                            className="w-4 h-4 accent-emerald-500"
                        />
                        <span className="font-medium">{pm.name}</span>
                    </label>
                ))}
            </div>
            <p className="text-xs text-slate-500 mt-3 text-center">
                * O pagamento serÃ¡ realizado no local.
            </p>
          </div>
      )}

      {error && (
        <div className="p-4 bg-red-500/10 border border-red-500/20 text-red-400 rounded-xl text-sm text-center">
          {error}
        </div>
      )}

      <button 
        onClick={handleConfirm}
        disabled={submitting}
        className="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-bold py-4 rounded-xl shadow-lg shadow-emerald-500/20 transition disabled:opacity-50 disabled:cursor-not-allowed"
      >
        {submitting ? "Confirmando..." : "Confirmar Agendamento"}
      </button>
    </div>
  );
}

--- FIM DO ARQUIVO: src\react-app\components\booking\StepConfirm.tsx ---


--- INICIO DO ARQUIVO: src\react-app\components\booking\StepDateTime.tsx ---
Path: src\react-app\components\booking\StepDateTime.tsx
------------------------------
// src/react-app/components/booking/StepDateTime.tsx

import { useEffect, useState, useMemo } from "react";
import type { Shop, Service, User, TimeSlot, ShopHour, Appointment } from "@/shared/types";
import { getShopHours, getProfessionalAppointments } from "@/react-app/lib/api/availability";
import { getProfessionalsByShop } from "@/react-app/lib/api/staff";
import { generateSlots } from "@/react-app/lib/utils/slots";
import { AppointmentStatus } from "@/shared/types";

type Props = {
  shop: Shop;
  service: Service;
  professional: User | null;
  onBack: () => void;
  onSelect: (slot: TimeSlot) => void;
};

export default function StepDateTime({ shop, service, professional, onBack, onSelect }: Props) {
  const [selectedDate, setSelectedDate] = useState<string>("");
  const [slots, setSlots] = useState<TimeSlot[]>([]);
  const [loading, setLoading] = useState(false);
  const [shopHours, setShopHours] = useState<ShopHour[]>([]);
  const [selectedSlot, setSelectedSlot] = useState<TimeSlot | null>(null);
  const [appointments, setAppointments] = useState<Appointment[]>([]);
  
  const [effectiveProfessional, setEffectiveProfessional] = useState<User | null>(professional);

  // 1. InicializaÃ§Ã£o:  HorÃ¡rios da Loja + Resolver Profissional
  useEffect(() => {
    let isMounted = true;

    async function init() {
      try {
        const hours = await getShopHours(shop.id);
        if (isMounted) setShopHours(hours);
      } catch (err:  any) {
        if (err.status !== 0 && !err.isAbort) {
          console.error("Erro ao buscar horÃ¡rios:", err);
        }
      }

      if (isMounted) {
        const today = new Date().toISOString().split('T')[0];
        setSelectedDate(today);
      }

      if (! professional) {
        try {
          const profs = await getProfessionalsByShop(shop.id);
          if (isMounted && profs.length > 0) {
            setEffectiveProfessional(profs[0]);
          }
        } catch (err: any) {
          if (err.status !== 0 && !err.isAbort) console.error(err);
        }
      } else {
        if (isMounted) setEffectiveProfessional(professional);
      }
    }

    init();

    return () => { isMounted = false; };
  }, [shop.id, professional]);

  // 2. Quando muda a data ou o profissional efetivo, recalcula slots
  useEffect(() => {
    if (! selectedDate || shopHours.length === 0 || ! effectiveProfessional) return;

    let isMounted = true;

    async function loadSlots() {
      setLoading(true);
      try {
        const allAppointments = await getProfessionalAppointments(effectiveProfessional! .id, selectedDate);
        
        if (! isMounted) return;

        setAppointments(allAppointments);

        const generated = generateSlots(
          selectedDate,
          service.duration,
          shopHours,
          allAppointments
        );
        
        setSlots(generated);
      } catch (err: any) {
        if (err.status === 0 || err.isAbort) return;
        console.error("Erro ao gerar slots", err);
      } finally {
        if (isMounted) setLoading(false);
      }
    }

    loadSlots();

    return () => { isMounted = false; };
  }, [selectedDate, shopHours, effectiveProfessional, service.duration]);

  // âœ… CORREÃ‡ÃƒO CRÃTICA: Helper para verificar bloqueios
  // Converte TUDO para timestamp em MILISSEGUNDOS para comparaÃ§Ã£o precisa
  const getBlockInfoForSlot = (slotTime:  string) => {
    // 1. Cria o slot LOCAL
    // "2025-01-20" + "12:30" = "2025-01-20T12:30:00"
    const slotStartISO = `${selectedDate}T${slotTime}:00`;
    const slotStart = new Date(slotStartISO).getTime(); // Converte LOCAL para ms
    const slotEnd = slotStart + (service.duration * 60 * 1000); // Adiciona duraÃ§Ã£o

    console.log(`ğŸ” Verificando slot ${slotTime}:`, {
      slotStartISO,
      slotStart:  new Date(slotStart).toISOString(),
      slotEnd: new Date(slotEnd).toISOString()
    });

    // 2. Verifica cada bloqueio
    for (const appt of appointments) {
      if (appt.status === AppointmentStatus.Blocked) {
        // âœ… CORREÃ‡ÃƒO: Converte UTC do banco para ms tambÃ©m
        const apptStart = new Date(appt.start_time).getTime();
        const apptEnd = new Date(
          appt.end_time || new Date(apptStart + 30 * 60 * 1000).toISOString()
        ).getTime();

        console.log(`ğŸ“… Comparando com bloqueio: `, {
          apptStart: new Date(apptStart).toISOString(),
          apptEnd: new Date(apptEnd).toISOString(),
          start_time: appt.start_time,
          end_time:  appt.end_time,
          notes: appt.notes
        });

        // âœ… CORREÃ‡ÃƒO: ComparaÃ§Ã£o correta de intervalos em ms
        // SobreposiÃ§Ã£o: (slotStart < apptEnd) AND (slotEnd > apptStart)
        if (slotStart < apptEnd && slotEnd > apptStart) {
          console.log(`âœ… BLOQUEIO DETECTADO!`);
          
          const startTime = new Date(apptStart).toLocaleTimeString("pt-BR", { 
            hour: "2-digit", 
            minute: "2-digit" 
          });
          const endTime = new Date(apptEnd).toLocaleTimeString("pt-BR", { 
            hour: "2-digit", 
            minute: "2-digit" 
          });

          return {
            isBlocked: true,
            reason: appt.notes || "HorÃ¡rio indisponÃ­vel",
            startTime,
            endTime
          };
        }
      }
    }

    console.log(`âœ… Slot livre`);
    return null;
  };

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
      <div>
        <button onClick={onBack} className="text-xs text-slate-400 hover:text-white mb-2 transition flex items-center gap-1">â† Voltar</button>
        <p className="text-xs uppercase tracking-[0.18em] text-emerald-300/80 mb-1">Passo 3 â€¢ Data e Hora</p>
        <h2 className="text-xl md:text-2xl font-semibold text-slate-50">Quando serÃ¡ o atendimento?</h2>
        <p className="text-sm text-slate-300 mt-1">
          Profissional: <span className="text-emerald-300">{effectiveProfessional ?  effectiveProfessional.name : "Carregando..."}</span> â€¢ DuraÃ§Ã£o: {service.duration} min
        </p>
      </div>

      {/* Seletor de Data */}
      <div className="space-y-2">
        <label className="text-xs font-medium text-slate-400">Selecione o dia</label>
        <input 
          type="date" 
          value={selectedDate}
          min={new Date().toISOString().split("T")[0]}
          onChange={(e) => {
            setSelectedDate(e. target.value);
            setSelectedSlot(null);
          }}
          className="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-emerald-500 color-scheme-dark font-bold tracking-wide"
        />
      </div>

      {/* Grid de HorÃ¡rios */}
      <div className="space-y-2">
        <div className="flex justify-between items-end">
          <label className="text-xs font-medium text-slate-400">HorÃ¡rios</label>
          <div className="flex gap-3 text-[10px] text-slate-500">
            <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-emerald-500/20 border border-emerald-500/50"></div> Livre</span>
            <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-red-500/20 border border-red-500/50"></div> Ocupado</span>
            <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-amber-500/20 border border-amber-500/50"></div> Bloqueado</span>
          </div>
        </div>
        
        {! effectiveProfessional ? (
          <div className="py-8 text-center text-slate-500 text-sm">Carregando disponibilidade...</div>
        ) : loading ? (
          <div className="py-8 text-center text-slate-500 text-sm animate-pulse">Calculando agenda...</div>
        ) : slots.length === 0 ? (
          <div className="py-8 text-center text-slate-500 text-sm bg-slate-950/30 rounded-xl border border-white/5">
            Nenhum horÃ¡rio disponÃ­vel nesta data. 
          </div>
        ) : (
          <div className="space-y-4">
            {/* Mostrar bloqueios de forma clara */}
            {appointments.filter(a => a.status === AppointmentStatus.Blocked).length > 0 && (
              <div className="bg-amber-500/10 border border-amber-500/30 p-4 rounded-xl">
                <p className="text-xs text-amber-400 font-bold mb-2 uppercase tracking-wider">â³ Bloqueios de Agenda Neste Dia: </p>
                <div className="space-y-2">
                  {appointments
                    .filter(a => a.status === AppointmentStatus. Blocked)
                    .map(block => {
                      const startTime = new Date(block.start_time).toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
                      const endTime = new Date(block.end_time || block.start_time).toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
                      return (
                        <div key={block. id} className="bg-amber-900/20 p-2 rounded border border-amber-500/20 text-xs">
                          <span className="text-amber-300 font-mono font-bold">{startTime} - {endTime}</span>
                          <span className="text-amber-200 ml-2">{block.notes || "IndisponÃ­vel"}</span>
                        </div>
                      );
                    })}
                </div>
              </div>
            )}

            {/* Grid de slots */}
            <div className="grid grid-cols-4 gap-2 md:grid-cols-5 max-h-[320px] overflow-y-auto custom-scrollbar pr-1">
              {slots.map((slot) => {
                const isSelected = selectedSlot?. time === slot.time;
                const blockInfo = getBlockInfoForSlot(slot. time); // âœ… Chama com correÃ§Ã£o

                let btnClass = "py-2 px-1 rounded-lg text-sm font-bold transition relative border ";
                let title = "";

                if (blockInfo) {
                  // BLOQUEADO (AMBER/AMARELO)
                  btnClass += "bg-amber-500/20 border-amber-500/50 text-amber-300/60 cursor-not-allowed opacity-60";
                  title = `Bloqueado: ${blockInfo.reason} (${blockInfo.startTime} - ${blockInfo.endTime})`;
                } else if (! slot.isAvailable) {
                  // OCUPADO (VERMELHO)
                  btnClass += "bg-red-500/10 border-red-500/20 text-red-400/60 cursor-not-allowed line-through decoration-red-500/30";
                  title = "HorÃ¡rio ocupado";
                } else if (isSelected) {
                  // SELECIONADO (VERDE)
                  btnClass += "bg-emerald-500 border-emerald-500 text-black shadow-lg shadow-emerald-500/20 scale-105 z-10";
                  title = "Selecionado";
                } else {
                  // LIVRE (VERDE CLARO)
                  btnClass += "bg-emerald-500/5 border-emerald-500/20 text-emerald-400 hover:bg-emerald-500/20 hover:border-emerald-500/40 cursor-pointer";
                  title = "DisponÃ­vel";
                }

                return (
                  <button
                    key={slot.time}
                    disabled={! slot.isAvailable || !!blockInfo}
                    onClick={() => !blockInfo && slot.isAvailable && setSelectedSlot(slot)}
                    className={btnClass}
                    title={title}
                  >
                    {slot.time}
                  </button>
                );
              })}
            </div>
          </div>
        )}
      </div>

      <div className="flex items-center justify-end pt-4 border-t border-white/5">
        <button
          onClick={() => selectedSlot && onSelect(selectedSlot)}
          disabled={!selectedSlot}
          className="inline-flex items-center gap-2 rounded-2xl bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold px-6 py-2. 5 text-sm transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-emerald-500/20"
        >
          Confirmar HorÃ¡rio
          <span>âŸ¶</span>
        </button>
      </div>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\components\booking\StepDateTime.tsx ---


--- INICIO DO ARQUIVO: src\react-app\components\booking\StepProfessional.tsx ---
Path: src\react-app\components\booking\StepProfessional.tsx
------------------------------
import { useEffect, useState } from "react";
import { User } from "@/shared/types";
import { getProfessionalsByShop } from "../../lib/api/staff";

interface StepProfessionalProps {
  shopId: string;
  serviceName: string;
  onSelect: (professional: User | null) => void;
  onBack: () => void;
}

export default function StepProfessional({ 
  shopId, 
  serviceName, 
  onSelect, 
  onBack 
}: StepProfessionalProps) {
  
  const [professionals, setProfessionals] = useState<User[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    let isMounted = true;

    async function load() {
      setLoading(true);
      try {
        const data = await getProfessionalsByShop(shopId);
        if (isMounted) {
          setProfessionals(data);
        }
      } catch (error: any) {
        // CORREÃ‡ÃƒO: Ignora erro de auto-cancelamento
        if (error.status === 0 || error.isAbort) return;
        
        console.error("Erro ao carregar profissionais", error);
      } finally {
        if (isMounted) {
          setLoading(false);
        }
      }
    }
    load();

    return () => {
      isMounted = false;
    };
  }, [shopId]);

  if (loading) {
    return <div className="text-center p-8 text-slate-500">Carregando profissionais...</div>;
  }

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
      <div>
        <button onClick={onBack} className="text-xs text-slate-400 hover:text-white mb-2">
          â† Voltar
        </button>
        <h2 className="text-xl font-bold text-white">Escolha o Profissional</h2>
        <p className="text-sm text-slate-400">
          Para realizar: <span className="text-emerald-400 font-medium">{serviceName}</span>
        </p>
      </div>

      <div className="grid gap-3">
        {/* OPÃ‡ÃƒO: QUALQUER PROFISSIONAL */}
        <button
          onClick={() => onSelect(null)}
          className="flex items-center gap-4 p-4 rounded-xl bg-slate-800 border border-white/5 hover:border-emerald-500/50 hover:bg-slate-800/80 transition group text-left"
        >
          <div className="h-12 w-12 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-400 text-xl group-hover:scale-110 transition">
            ğŸ²
          </div>
          <div>
            <h3 className="font-semibold text-slate-200 group-hover:text-emerald-400 transition">
              Qualquer profissional
            </h3>
            <p className="text-xs text-slate-500">HorÃ¡rios mais flexÃ­veis</p>
          </div>
        </button>

        {/* LISTA DE PROFISSIONAIS */}
        {professionals.map((prof) => {
          const displayName = prof.name || "Profissional";
          const displayLetter = displayName.charAt(0).toUpperCase();

          return (
            <button
              key={prof.id}
              onClick={() => onSelect(prof)}
              className="flex items-center gap-4 p-4 rounded-xl bg-slate-900 border border-white/5 hover:border-emerald-500/50 hover:bg-slate-800 transition group text-left"
            >
              <div className="h-12 w-12 rounded-full bg-slate-800 flex items-center justify-center overflow-hidden border border-white/10 group-hover:border-emerald-500/50 transition">
                {prof.avatar ? (
                  <img src={prof.avatar} alt={displayName} className="h-full w-full object-cover" />
                ) : (
                  <span className="text-lg font-bold text-slate-500 group-hover:text-white">
                    {displayLetter}
                  </span>
                )}
              </div>
              <div>
                <h3 className="font-semibold text-slate-200 group-hover:text-emerald-400 transition">
                  {displayName}
                </h3>
                <p className="text-xs text-slate-500">Especialista</p>
              </div>
            </button>
          );
        })}

        {professionals.length === 0 && (
          <p className="text-center text-slate-500 text-sm py-4">
            Nenhum profissional especÃ­fico encontrado. Tente a opÃ§Ã£o acima.
          </p>
        )}
      </div>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\components\booking\StepProfessional.tsx ---


--- INICIO DO ARQUIVO: src\react-app\components\booking\StepService.tsx ---
Path: src\react-app\components\booking\StepService.tsx
------------------------------
import { useEffect, useState } from "react";
import { Service } from "@/shared/types";
import { getServicesByShop } from "../../lib/api/services";

interface StepServiceProps {
  shopId: string;
  onSelect: (service: Service) => void;
}

export default function StepService({ shopId, onSelect }: StepServiceProps) {
  const [services, setServices] = useState<Service[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    let isMounted = true;

    async function load() {
      setLoading(true);
      try {
        const data = await getServicesByShop(shopId);
        if (isMounted) {
          setServices(data);
        }
      } catch (error: any) {
        // CORREÃ‡ÃƒO: Ignora erro de auto-cancelamento (status 0 ou isAbort)
        if (error.status === 0 || error.isAbort) return;

        console.error("Erro ao carregar serviÃ§os", error);
      } finally {
        if (isMounted) {
          setLoading(false);
        }
      }
    }
    load();

    return () => {
      isMounted = false;
    };
  }, [shopId]);

  if (loading) {
    return <div className="text-center p-8 text-slate-500">Carregando serviÃ§os...</div>;
  }

  // Agrupar serviÃ§os por categoria
  const groupedServices = services.reduce((acc, service) => {
    const catName = (service as any).expand?.category_id?.name || "Geral";
    if (!acc[catName]) acc[catName] = [];
    acc[catName].push(service);
    return acc;
  }, {} as Record<string, Service[]>);

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
      <div className="text-center md:text-left">
        <h2 className="text-xl font-bold text-white">Selecione o ServiÃ§o</h2>
        <p className="text-sm text-slate-400">O que vamos fazer hoje?</p>
      </div>

      {services.length === 0 ? (
        <div className="text-center p-8 border border-dashed border-white/10 rounded-xl text-slate-500">
          Nenhum serviÃ§o disponÃ­vel nesta unidade.
        </div>
      ) : (
        <div className="space-y-6">
          {Object.entries(groupedServices).map(([category, items]) => (
            <div key={category}>
              <h3 className="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-3 px-1">
                {category}
              </h3>
              <div className="grid gap-3">
                {items.map((service) => (
                  <button
                    key={service.id}
                    onClick={() => onSelect(service)}
                    className="flex items-center justify-between p-4 rounded-xl bg-slate-900 border border-white/5 hover:border-emerald-500/50 hover:bg-slate-800 transition group w-full text-left"
                  >
                    <div>
                      <h4 className="font-semibold text-slate-200 group-hover:text-emerald-400 transition">
                        {service.name}
                      </h4>
                      <p className="text-xs text-slate-500">
                        {service.duration} min
                      </p>
                    </div>
                    <div className="text-right">
                      <span className="text-sm font-bold text-white">
                        {new Intl.NumberFormat("pt-BR", {
                          style: "currency",
                          currency: "BRL",
                        }).format(service.price)}
                      </span>
                    </div>
                  </button>
                ))}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\components\booking\StepService.tsx ---


--- INICIO DO ARQUIVO: src\react-app\components\common\Modal.tsx ---
Path: src\react-app\components\common\Modal.tsx
------------------------------
import { ReactNode } from "react";

type Props = {
  isOpen: boolean;
  onClose: () => void;
  title: string;
  children: ReactNode;
};

export default function Modal({ isOpen, onClose, title, children }: Props) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
      <div className="bg-slate-900 border border-white/10 rounded-2xl w-full max-w-md shadow-2xl flex flex-col max-h-[90vh]">
        <div className="flex justify-between items-center p-4 border-b border-white/5">
          <h3 className="text-lg font-semibold text-white">{title}</h3>
          <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div className="p-6 overflow-y-auto">
          {children}
        </div>
      </div>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\components\common\Modal.tsx ---


--- INICIO DO ARQUIVO: src\react-app\components\dashboard\StaffBookingModal.tsx ---
Path: src\react-app\components\dashboard\StaffBookingModal.tsx
------------------------------
import { useState, useEffect } from "react";
import { X, User as UserIcon, Calendar, Clock, Scissors, Search, Ban, CheckCircle } from "lucide-react";
import { useAuth } from "@/react-app/contexts/AuthContext";
import { getServicesByShop } from "@/react-app/lib/api/services";
import { getProfessionalsByShop } from "@/react-app/lib/api/staff";
import { generateSlots } from "@/react-app/lib/utils/slots";
import { getShopHours, getProfessionalAppointments } from "@/react-app/lib/api/availability";
import { createStaffAppointment, searchClients } from "@/react-app/lib/api/appointments";
import { Service, User, TimeSlot, AppointmentStatus } from "@/shared/types";

interface StaffBookingModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
}

export function StaffBookingModal({ isOpen, onClose, onSuccess }:  StaffBookingModalProps) {
  const { user } = useAuth();
  
  // TIPO DE AÃ‡ÃƒO:  AGENDAR ou BLOQUEAR
  const [modalType, setModalType] = useState<"appointment" | "block">("appointment");

  // Estados Comuns
  const [selectedBarber, setSelectedBarber] = useState<string>("");
  const [date, setDate] = useState<string>(new Date().toISOString().split("T")[0]);
  const [selectedSlot, setSelectedSlot] = useState<string | null>(null);
  
  // Estados para Agendamento
  const [selectedService, setSelectedService] = useState<string>("");
  const [clientMode, setClientMode] = useState<"registered" | "guest">("guest");
  const [guestName, setGuestName] = useState("");
  const [guestPhone, setGuestPhone] = useState("");
  const [clientSearch, setClientSearch] = useState("");
  const [foundClients, setFoundClients] = useState<User[]>([]);
  const [selectedClient, setSelectedClient] = useState<User | null>(null);

  // Estados para Bloqueio
  const [blockReason, setBlockReason] = useState("");
  const [blockDuration, setBlockDuration] = useState(60); // PadrÃ£o 1 hora

  // Dados Carregados
  const [services, setServices] = useState<Service[]>([]);
  const [barbers, setBarbers] = useState<User[]>([]);
  const [slots, setSlots] = useState<TimeSlot[]>([]);
  
  const [loading, setLoading] = useState(false);
  const [slotLoading, setSlotLoading] = useState(false);

  useEffect(() => {
    if (isOpen && user?. shop_id) {
      getServicesByShop(user.shop_id).then(setServices);
      getProfessionalsByShop(user.shop_id).then(users => {
        setBarbers(users);
        if (users.find(u => u.id === user.id)) {
          setSelectedBarber(user.id);
        }
      });
    }
  }, [isOpen, user?.shop_id]);

  useEffect(() => {
    if (!selectedBarber || !date || !user?. shop_id) {
        setSlots([]);
        return;
    }

    const durationForGrid = modalType === "appointment" 
        ? services.find(s => s.id === selectedService)?.duration || 30 
        : blockDuration;

    if (modalType === "appointment" && ! selectedService) {
        setSlots([]);
        return;
    }

    async function fetchSlots() {
      setSlotLoading(true);
      try {
        const [hours, appointments] = await Promise.all([
          getShopHours(user! .shop_id! ),
          getProfessionalAppointments(selectedBarber, date)
        ]);

        const generated = generateSlots(date, durationForGrid, hours, appointments);
        setSlots(generated);
      } catch (err) {
        console.error(err);
      } finally {
        setSlotLoading(false);
      }
    }

    fetchSlots();
  }, [selectedService, selectedBarber, date, user?.shop_id, services, modalType, blockDuration]);

  useEffect(() => {
    if (modalType === "appointment" && clientMode === "registered" && clientSearch. length > 2) {
      const timer = setTimeout(() => {
        searchClients(clientSearch).then(res => setFoundClients(res. items as unknown as User[]));
      }, 500);
      return () => clearTimeout(timer);
    } else {
        setFoundClients([]);
    }
  }, [clientSearch, clientMode, modalType]);

  // âœ… FUNÃ‡ÃƒO CORRIGIDA: 
  async function handleConfirm() {
    if (!user?. shop_id || !selectedSlot || !selectedBarber) return;
    
    // âœ… NOVO:  Calcular end_time AQUI, baseado na duraÃ§Ã£o
    let finalEndTime: string | undefined = undefined;
    
    if (selectedSlot && blockDuration) {
      const startDate = new Date(selectedSlot);
      const endDate = new Date(startDate.getTime() + blockDuration * 60 * 1000);
      finalEndTime = endDate.toISOString();
    }
    
    // Payload Base
    const payload:  any = {
        shop_id: user.shop_id,
        barber_id:  selectedBarber,
        start_time: selectedSlot,
        end_time: finalEndTime, // âœ… NOVO! 
        status: modalType === "appointment" ? AppointmentStatus. Confirmed : AppointmentStatus. Blocked,
    };

    if (modalType === "appointment") {
        const serviceObj = services.find(s => s.id === selectedService);
        if (! serviceObj) return;

        if (clientMode === "guest" && !guestName.trim()) return alert("Digite o nome do cliente.");
        if (clientMode === "registered" && !selectedClient) return alert("Selecione um cliente.");

        payload.service_id = selectedService;
        payload.duration_minutes = serviceObj.duration;
        payload. total_amount = serviceObj.price;
        payload.client_id = clientMode === "registered" ? selectedClient?. id : undefined;
        payload.customer_name = clientMode === "guest" ? guestName :  undefined;
        payload.customer_phone = clientMode === "guest" ?  guestPhone : undefined;
        payload.payment_status = "1";
    } else {
        // âœ… BLOQUEIO
        if (! blockReason.trim()) return alert("Digite o motivo do bloqueio (ex:  AlmoÃ§o).");
        
        payload.notes = blockReason;
        payload.duration_minutes = blockDuration; // âœ… MantÃ©m para compatibilidade
    }

    setLoading(true);
    try {
      await createStaffAppointment(payload);
      alert(modalType === "appointment" ? "Agendado com sucesso!" : "HorÃ¡rio bloqueado!");
      onSuccess();
      onClose();
      
      // Reset
      setSelectedSlot(null);
      setGuestName("");
      setBlockReason("");
    } catch (error:  any) {
      console.error(error);
      alert("Erro ao salvar.");
    } finally {
      setLoading(false);
    }
  }

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 text-slate-50">
      <div className="bg-slate-900 border border-slate-800 w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
        
        {/* HEADER */}
        <div className="flex justify-between items-center p-6 border-b border-slate-800">
          <div className="flex gap-4">
              <button 
                onClick={() => setModalType("appointment")}
                className={`text-lg font-bold pb-1 border-b-2 transition ${modalType === "appointment" ? "text-emerald-400 border-emerald-400" :  "text-slate-500 border-transparent"}`}
              >
                  Novo Agendamento
              </button>
              <button 
                onClick={() => setModalType("block")}
                className={`text-lg font-bold pb-1 border-b-2 transition ${modalType === "block" ?  "text-red-400 border-red-400" : "text-slate-500 border-transparent"}`}
              >
                  Bloquear HorÃ¡rio
              </button>
          </div>
          <button onClick={onClose} className="text-slate-400 hover:text-white">
            <X size={24} />
          </button>
        </div>

        {/* CONTENT */}
        <div className="flex-1 overflow-y-auto p-6 space-y-6">
            
            {/* 1. CONFIGURAÃ‡ÃƒO (VARIA POR TIPO) */}
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                {modalType === "appointment" ?  (
                    <div>
                        <label className="block text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
                            <Scissors size={14} /> ServiÃ§o
                        </label>
                        <select 
                            value={selectedService} 
                            onChange={e => setSelectedService(e. target.value)}
                            className="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:ring-2 focus:ring-emerald-500 outline-none"
                        >
                            <option value="">Selecione... </option>
                            {services. map(s => (
                                <option key={s.id} value={s.id}>{s.name} ({s.duration} min) - R$ {s.price}</option>
                            ))}
                        </select>
                    </div>
                ) : (
                    <div>
                        <label className="block text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
                            <Ban size={14} /> Motivo do Bloqueio
                        </label>
                        <input 
                            type="text" 
                            placeholder="Ex: AlmoÃ§o, MÃ©dico..."
                            value={blockReason} 
                            onChange={e => setBlockReason(e.target.value)}
                            className="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:ring-2 focus:ring-red-500 outline-none"
                        />
                    </div>
                )}

                <div>
                    <label className="block text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
                         <UserIcon size={14} /> Profissional
                    </label>
                    <select 
                        value={selectedBarber} 
                        onChange={e => setSelectedBarber(e.target.value)}
                        className="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:ring-2 focus:ring-emerald-500 outline-none"
                    >
                        <option value="">Selecione...</option>
                        {barbers.map(b => (
                            <option key={b. id} value={b.id}>{b.name}</option>
                        ))}
                    </select>
                </div>
            </div>

             {/* DURAÃ‡ÃƒO MANUAL PARA BLOQUEIO */}
             {modalType === "block" && (
                <div>
                     <label className="block text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
                        <Clock size={14} /> DuraÃ§Ã£o do Bloqueio (minutos)
                    </label>
                    <div className="flex gap-2">
                        {[30, 60, 90, 120]. map(m => (
                            <button 
                                key={m} 
                                onClick={() => setBlockDuration(m)}
                                className={`px-4 py-2 rounded-lg text-sm border ${blockDuration === m ? "bg-red-500/20 border-red-500 text-red-400" : "bg-slate-800 border-slate-700 text-slate-400"}`}
                            >
                                {m} min
                            </button>
                        ))}
                        <input 
                            type="number" 
                            value={blockDuration}
                            onChange={e => setBlockDuration(Number(e.target.value))}
                            className="w-20 bg-slate-800 border border-slate-700 rounded-lg p-2 text-center text-white focus:ring-2 focus: ring-red-500 outline-none"
                        />
                    </div>
                </div>
             )}

            {/* 2. DATA E HORÃRIO */}
            <div className="border-t border-slate-800 pt-6">
                <div className="flex flex-col sm:flex-row gap-4 mb-4">
                    <div className="w-full sm:w-1/3">
                        <label className="block text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
                            <Calendar size={14} /> Data
                        </label>
                        <input 
                            type="date" 
                            value={date}
                            onChange={e => setDate(e.target.value)}
                            className="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:ring-2 focus:ring-emerald-500 outline-none"
                        />
                    </div>
                    <div className="flex-1">
                        <label className="block text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
                            <Clock size={14} /> HorÃ¡rios DisponÃ­veis
                        </label>
                        {slotLoading ?  (
                            <div className="text-slate-500 text-sm animate-pulse">Calculando... </div>
                        ) : slots.length > 0 ? (
                            <div className="grid grid-cols-4 sm:grid-cols-6 gap-2">
                                {slots.map((slot) => (
                                    <button
                                        key={slot.time}
                                        disabled={!slot.isAvailable}
                                        onClick={() => setSelectedSlot(slot. startISO)}
                                        className={`text-xs py-2 rounded-lg border transition-all ${
                                            selectedSlot === slot.startISO
                                                ? (modalType === "appointment" ? "bg-emerald-500 border-emerald-500" : "bg-red-500 border-red-500") + " text-white font-bold"
                                                : slot.isAvailable
                                                ? "bg-slate-800 border-slate-700 text-slate-300 hover:border-slate-500"
                                                : "bg-slate-900 border-slate-800 text-slate-600 cursor-not-allowed opacity-50"
                                        }`}
                                    >
                                        {slot.time}
                                    </button>
                                ))}
                            </div>
                        ) : (
                            <div className="text-slate-500 text-sm italic border border-dashed border-slate-700 rounded p-2 text-center">
                                {modalType === "appointment" && ! selectedService ?  "Selecione um serviÃ§o primeiro." : "Nenhum horÃ¡rio disponÃ­vel. "}
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* 3. CLIENTE (Apenas para Agendamento) */}
            {modalType === "appointment" && (
                <div className="border-t border-slate-800 pt-6">
                    <label className="block text-sm font-medium text-slate-400 mb-4">Dados do Cliente</label>
                    <div className="flex gap-4 mb-4">
                        <button onClick={() => { setClientMode("guest"); setSelectedClient(null); }} className={`flex-1 py-2 text-sm rounded-lg border transition ${clientMode === "guest" ? "bg-emerald-500/20 border-emerald-500 text-emerald-400" : "bg-slate-800 border-slate-700 text-slate-400"}`}>Cliente Avulso</button>
                        <button onClick={() => { setClientMode("registered"); setGuestName(""); }} className={`flex-1 py-2 text-sm rounded-lg border transition ${clientMode === "registered" ?  "bg-blue-500/20 border-blue-500 text-blue-400" : "bg-slate-800 border-slate-700 text-slate-400"}`}>Cliente Cadastrado</button>
                    </div>

                    {clientMode === "guest" ?  (
                        <div className="grid grid-cols-1 sm: grid-cols-2 gap-4">
                            <input type="text" placeholder="Nome *" value={guestName} onChange={e => setGuestName(e. target.value)} className="bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white w-full outline-none focus:border-emerald-500" />
                            <input type="text" placeholder="Telefone" value={guestPhone} onChange={e => setGuestPhone(e.target.value)} className="bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white w-full outline-none focus: border-emerald-500" />
                        </div>
                    ) : (
                        <div className="space-y-3">
                            {! selectedClient ?  (
                                <div className="relative">
                                    <Search className="absolute left-3 top-3 text-slate-500" size={16} />
                                    <input type="text" placeholder="Buscar cliente..." value={clientSearch} onChange={e => setClientSearch(e.target.value)} className="bg-slate-800 border border-slate-700 rounded-lg p-2.5 pl-10 text-white w-full outline-none focus:border-blue-500" />
                                    {foundClients.length > 0 && (
                                        <div className="absolute top-full bg-slate-800 border border-slate-700 mt-1 rounded-lg shadow-xl z-10 w-full max-h-40 overflow-y-auto">
                                            {foundClients.map(c => (
                                                <button key={c.id} onClick={() => { setSelectedClient(c); setFoundClients([]); setClientSearch(""); }} className="w-full text-left px-4 py-2 hover:bg-slate-700 text-sm text-slate-200 border-b border-slate-700 last:border-0">{c.name || "Sem Nome"}</button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="flex justify-between bg-blue-500/10 border border-blue-500/30 p-3 rounded-lg text-white text-sm">
                                    <span>{selectedClient.name}</span>
                                    <button onClick={() => setSelectedClient(null)} className="underline text-slate-400">Trocar</button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            )}

        </div>

        {/* FOOTER */}
        <div className="p-6 border-t border-slate-800 flex justify-end gap-3 bg-slate-900/50">
            <button onClick={onClose} className="px-4 py-2 text-slate-400 hover:text-white transition text-sm">Cancelar</button>
            <button 
                onClick={handleConfirm}
                disabled={loading || !selectedSlot}
                className={`px-6 py-2 rounded-lg font-medium text-white transition disabled:opacity-50 ${modalType === "appointment" ? "bg-emerald-500 hover:bg-emerald-600" : "bg-red-500 hover:bg-red-600"}`}
            >
                {loading ? "Salvando..." : modalType === "appointment" ? "Confirmar Agendamento" : "Confirmar Bloqueio"}
            </button>
        </div>

      </div>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\components\dashboard\StaffBookingModal.tsx ---


--- INICIO DO ARQUIVO: src\react-app\components\layout\AppLayout.tsx ---
Path: src\react-app\components\layout\AppLayout.tsx
------------------------------
import { Outlet } from "react-router-dom";
import Sidebar from "./Sidebar";
import Header from "./Header";

export default function AppLayout() {
  return (
    <div className="min-h-screen bg-slate-950 text-slate-50 flex font-sans">
      <Sidebar />
      
      <div className="flex-1 flex flex-col md:ml-64 transition-all">
        <Header />
        
        <main className="flex-1 p-4 md:p-8 overflow-y-auto">
          <div className="max-w-6xl mx-auto w-full">
            <Outlet />
          </div>
        </main>
      </div>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\components\layout\AppLayout.tsx ---


--- INICIO DO ARQUIVO: src\react-app\components\layout\Header.tsx ---
Path: src\react-app\components\layout\Header.tsx
------------------------------
import { Link } from "react-router-dom";
import { useAuth } from "@/react-app/contexts/AuthContext";
import { useTenant } from "@/react-app/contexts/TenantContext";
import { LayoutDashboard, Menu, LogOut } from "lucide-react";

export default function Header() {
  const { user, logout } = useAuth();
  const { currentShop } = useTenant();

  return (
    <header className="h-16 bg-slate-950/50 backdrop-blur-md border-b border-white/5 flex items-center justify-between px-4 md:px-8 sticky top-0 z-10">
      
      <div className="flex items-center gap-4">
        {/* Ãcone de Menu (Mobile - Visual por enquanto) */}
        <div className="md:hidden text-slate-400">
            <Menu size={24} />
        </div>

        {/* BotÃ£o HOME - Atalho para Dashboard */}
        <Link 
            to="/owner/dashboard" 
            className="text-slate-400 hover:text-emerald-400 transition p-1 rounded-lg hover:bg-white/5"
            title="Ir para VisÃ£o Geral"
        >
            <LayoutDashboard size={22} />
        </Link>

        {/* Info da Loja Atual */}
        <div className="hidden md:block h-6 w-px bg-white/10 mx-2"></div>
        <div className="hidden md:block">
            <h2 className="text-sm font-medium text-slate-200">
            {currentShop ? currentShop.name : "Selecione uma unidade"}
            </h2>
        </div>
      </div>

      <div className="flex items-center gap-4">
        <div className="text-right hidden sm:block">
          <p className="text-sm text-white font-medium">{user?.name}</p>
          <p className="text-xs text-slate-500 capitalize">{user?.role}</p>
        </div>
        
        <div className="h-9 w-9 rounded-full bg-slate-800 border border-white/10 flex items-center justify-center text-slate-400 overflow-hidden">
          {user?.avatar ? (
             <img src={user.avatar} alt="Avatar" className="w-full h-full object-cover"/>
          ) : (
             <span>{user?.name?.[0]?.toUpperCase() || "U"}</span>
          )}
        </div>

        <button 
          onClick={logout}
          className="text-xs text-red-400 hover:text-red-300 transition ml-2 flex items-center gap-1"
          title="Sair"
        >
          <LogOut size={14} />
          <span className="hidden sm:inline">Sair</span>
        </button>
      </div>
    </header>
  );
}
--- FIM DO ARQUIVO: src\react-app\components\layout\Header.tsx ---


--- INICIO DO ARQUIVO: src\react-app\components\layout\Sidebar.tsx ---
Path: src\react-app\components\layout\Sidebar.tsx
------------------------------
import { Link, useLocation } from "react-router-dom";
import { 
  LayoutDashboard, 
  Store, 
  Scissors, 
  Users, 
  Settings, 
  X,
  DollarSign,
  Calendar // Import do Ã­cone Calendar
} from "lucide-react";

interface SidebarProps {
  mobileOpen?: boolean;
  onCloseMobile?: () => void;
}

export default function Sidebar({ mobileOpen = false, onCloseMobile }: SidebarProps) {
  const location = useLocation();

  const menuItems = [
    { label: "VisÃ£o Geral", path: "/owner/dashboard", icon: LayoutDashboard },
    { label: "Minha Agenda", path: "/staff/agenda", icon: Calendar }, // VOLTOU: Link para a agenda
    { label: "Financeiro", path: "/owner/financial", icon: DollarSign },
    { label: "Minhas Lojas", path: "/owner/shops", icon: Store },
    { label: "ServiÃ§os", path: "/owner/services", icon: Scissors },
    { label: "Profissionais", path: "/owner/staff", icon: Users },
    { label: "ConfiguraÃ§Ãµes", path: "/owner/settings", icon: Settings },
  ];

  return (
    <>
      {/* OVERLAY MOBILE */}
      {mobileOpen && (
        <div 
          className="fixed inset-0 bg-black/80 z-20 md:hidden backdrop-blur-sm"
          onClick={onCloseMobile}
        />
      )}

      {/* SIDEBAR CONTAINER */}
      <aside className={`
        fixed md:fixed inset-y-0 left-0 z-30 w-64 bg-slate-900 border-r border-white/5 flex flex-col transition-transform duration-300
        ${mobileOpen ? "translate-x-0" : "-translate-x-full md:translate-x-0"}
      `}>
        {/* LOGO AREA */}
        <div className="h-16 flex items-center justify-between px-6 border-b border-white/5">
          <div className="flex items-center gap-2 font-bold text-xl tracking-tighter text-white">
            <span className="text-emerald-500 text-2xl">âœ‚</span> TeAgendei
          </div>
          {onCloseMobile && (
            <button onClick={onCloseMobile} className="md:hidden text-slate-400 hover:text-white">
              <X size={24} />
            </button>
          )}
        </div>

        {/* MENU ITEMS */}
        <nav className="flex-1 p-4 space-y-1 overflow-y-auto custom-scrollbar">
          {menuItems.map((item) => {
            const isActive = location.pathname === item.path;
            const Icon = item.icon;
            
            return (
              <Link
                key={item.path}
                to={item.path}
                onClick={onCloseMobile}
                className={`flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition group ${
                  isActive
                    ? "bg-emerald-600/10 text-emerald-400 border border-emerald-500/20 shadow-lg shadow-emerald-900/10"
                    : "text-slate-400 hover:bg-white/5 hover:text-white border border-transparent"
                }`}
              >
                <Icon size={18} className={isActive ? "text-emerald-400" : "text-slate-500 group-hover:text-slate-300"} />
                {item.label}
              </Link>
            );
          })}
        </nav>
        
        {/* FOOTER VERSÃƒO */}
        <div className="p-4 border-t border-white/5 text-center">
            <p className="text-[10px] text-slate-600 font-mono">v1.0.85</p>
        </div>
      </aside>
    </>
  );
}
--- FIM DO ARQUIVO: src\react-app\components\layout\Sidebar.tsx ---


--- INICIO DO ARQUIVO: src\react-app\components\layout\StaffLayout.tsx ---
Path: src\react-app\components\layout\StaffLayout.tsx
------------------------------
import { ReactNode } from "react";
import { Link, useLocation, useNavigate } from "react-router-dom";
import { useAuth } from "@/react-app/contexts/AuthContext";
import { Calendar, Lock, LogOut, ArrowLeft, Scissors } from "lucide-react";

export default function StaffLayout({ children }: { children: ReactNode }) {
  const { user, logout } = useAuth();
  const location = useLocation();
  const navigate = useNavigate();

  const handleLogout = () => {
    logout();
    navigate("/login");
  };

  const menuItems = [
    { label: "Minha Agenda", path: "/staff/agenda", icon: Calendar },
    { label: "Meus Dados e Senha", path: "/staff/settings", icon: Lock },
  ];

  return (
    <div className="min-h-screen bg-slate-950 text-slate-50 flex flex-col md:flex-row">
      
      {/* SIDEBAR EXCLUSIVA STAFF */}
      <aside className="w-full md:w-64 bg-slate-900 border-r border-white/5 flex flex-col">
        <div className="p-6 border-b border-white/5 flex items-center gap-3">
          <div className="h-10 w-10 bg-emerald-500/10 rounded-xl flex items-center justify-center text-emerald-500 border border-emerald-500/20">
             <Scissors size={20} />
          </div>
          <div>
            <h1 className="font-bold text-white tracking-tight">Ãrea Staff</h1>
            <p className="text-xs text-slate-500 truncate max-w-[120px]">{user?.name}</p>
          </div>
        </div>

        <nav className="flex-1 p-4 space-y-2">
          {/* BOTÃƒO VOLTAR PARA DONO (SÃ³ aparece se for Dono) */}
          {user?.role === "dono" && (
            <Link
              to="/owner/dashboard"
              className="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold bg-slate-800 text-slate-300 border border-white/5 hover:bg-slate-700 hover:text-white hover:border-white/10 transition mb-4 group"
            >
              <ArrowLeft size={18} className="group-hover:-translate-x-1 transition-transform" />
              Voltar ao Painel
            </Link>
          )}

          {menuItems.map((item) => {
            const isActive = location.pathname === item.path;
            const Icon = item.icon;
            
            return (
              <Link
                key={item.path}
                to={item.path}
                className={`flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition ${
                  isActive
                    ? "bg-emerald-600/10 text-emerald-400 border border-emerald-500/20"
                    : "text-slate-400 hover:bg-white/5 hover:text-white border border-transparent"
                }`}
              >
                <Icon size={18} />
                {item.label}
              </Link>
            );
          })}
        </nav>

        <div className="p-4 border-t border-white/5">
          <button
            onClick={handleLogout}
            className="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-sm font-medium text-red-400 hover:bg-red-500/10 transition border border-transparent hover:border-red-500/20"
          >
            <LogOut size={18} /> Sair do Sistema
          </button>
        </div>
      </aside>

      {/* ÃREA DE CONTEÃšDO */}
      <main className="flex-1 overflow-y-auto h-screen relative bg-slate-950">
        <div className="p-4 md:p-8 max-w-5xl mx-auto">
            {children}
        </div>
      </main>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\components\layout\StaffLayout.tsx ---


--- INICIO DO ARQUIVO: src\react-app\contexts\AuthContext.tsx ---
Path: src\react-app\contexts\AuthContext.tsx
------------------------------
// src/react-app/contexts/AuthContext.tsx
import React, {
  createContext,
  useContext,
  useEffect,
  useState,
  ReactNode,
} from "react";
import { User } from "@/shared/types";
import {
  login as pbLogin,
  logout as pbLogout,
  getCurrentUserTyped,
  refreshAuth,
} from "@/react-app/lib/api/pocketbase";

type AuthContextType = {
  user: User | null;
  loading: boolean;
  isAuthenticated: boolean;
  // login REAL retorna o User autenticado
  login: (email: string, password: string) => Promise<User>;
  logout: () => void;
};

const AuthContext = createContext<AuthContextType | undefined>(undefined);

type Props = {
  children: ReactNode;
};

export const AuthProvider: React.FC<Props> = ({ children }) => {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  // Inicializa sessÃ£o ao montar a app
  useEffect(() => {
    const init = async () => {
      try {
        await refreshAuth();
        const current = await getCurrentUserTyped(); // User | null
        setUser(current);
      } catch (err) {
        console.error("Erro ao inicializar auth", err);
        setUser(null);
      } finally {
        setLoading(false);
      }
    };

    void init();
  }, []);

  const handleLogin = async (email: string, password: string): Promise<User> => {
    setLoading(true);
    try {
      await pbLogin(email, password);
      const current = await getCurrentUserTyped(); // User | null

      if (!current) {
        // aqui eliminamos o `null` e garantimos o tipo `User`
        throw new Error("NÃ£o foi possÃ­vel carregar o usuÃ¡rio autenticado.");
      }

      setUser(current);
      return current;
    } catch (err) {
      console.error("Erro no login", err);
      // repassa o erro para a tela tratar
      throw err;
    } finally {
      setLoading(false);
    }
  };

  const handleLogout = () => {
    pbLogout();
    setUser(null);
  };

  return (
    <AuthContext.Provider
      value={{
        user,
        loading,
        isAuthenticated: !!user,
        login: handleLogin,
        logout: handleLogout,
      }}
    >
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = (): AuthContextType => {
  const ctx = useContext(AuthContext);
  if (!ctx) {
    throw new Error("useAuth deve ser usado dentro de AuthProvider");
  }
  return ctx;
};

--- FIM DO ARQUIVO: src\react-app\contexts\AuthContext.tsx ---


--- INICIO DO ARQUIVO: src\react-app\contexts\BookingContext.tsx ---
Path: src\react-app\contexts\BookingContext.tsx
------------------------------
import { createContext, useContext, useState, ReactNode } from "react";
import type { Shop, Service, User, TimeSlot } from "@/shared/types";

type BookingContextType = {
  shop: Shop | null;
  service: Service | null;
  professional: User | null;
  selectedDate: string; // YYYY-MM-DD
  selectedTime: string; // HH:MM
  
  setShop: (shop: Shop) => void;
  setService: (service: Service | null) => void;
  setProfessional: (professional: User | null) => void;
  setDate: (date: string) => void;
  setTime: (time: string) => void;
  
  resetBooking: () => void;
};

const BookingContext = createContext<BookingContextType | undefined>(undefined);

export function BookingProvider({ children }: { children: ReactNode }) {
  const [shop, setShop] = useState<Shop | null>(null);
  const [service, setService] = useState<Service | null>(null);
  const [professional, setProfessional] = useState<User | null>(null);
  const [selectedDate, setDate] = useState("");
  const [selectedTime, setTime] = useState("");

  const resetBooking = () => {
    setService(null);
    setProfessional(null);
    setDate("");
    setTime("");
  };

  return (
    <BookingContext.Provider
      value={{
        shop,
        service,
        professional,
        selectedDate,
        selectedTime,
        setShop,
        setService,
        setProfessional,
        setDate,
        setTime,
        resetBooking
      }}
    >
      {children}
    </BookingContext.Provider>
  );
}

export function useBooking() {
  const context = useContext(BookingContext);
  if (!context) {
    throw new Error("useBooking deve ser usado dentro de BookingProvider");
  }
  return context;
}
--- FIM DO ARQUIVO: src\react-app\contexts\BookingContext.tsx ---


--- INICIO DO ARQUIVO: src\react-app\contexts\TenantContext.tsx ---
Path: src\react-app\contexts\TenantContext.tsx
------------------------------
// src/react-app/contexts/TenantContext.tsx
import React, {
  createContext,
  useContext,
  useEffect,
  useState,
  ReactNode,
} from 'react';
import { Company, Shop } from '@/shared/types';
import {
  getMyCompanies,
  getShopsByCompany,
} from '@/react-app/lib/api/pocketbase';
import { useAuth } from './AuthContext';

type TenantContextType = {
  currentCompany: Company | null;
  currentShop: Shop | null;
  companies: Company[];
  shops: Shop[];
  setCurrentCompany: (company: Company | null) => void;
  setCurrentShop: (shop: Shop | null) => void;
  reloadTenants: () => Promise<void>;
  refreshTenant: () => Promise<void>; // âœ… alias para o register usar
};

const TenantContext = createContext<TenantContextType | undefined>(undefined);

type Props = {
  children: ReactNode;
};

export const TenantProvider: React.FC<Props> = ({ children }) => {
  const { user } = useAuth();
  const [companies, setCompanies] = useState<Company[]>([]);
  const [shops, setShops] = useState<Shop[]>([]);
  const [currentCompany, setCurrentCompanyState] = useState<Company | null>(null);
  const [currentShop, setCurrentShopState] = useState<Shop | null>(null);

  const load = async () => {
    if (!user) {
      setCompanies([]);
      setShops([]);
      setCurrentCompanyState(null);
      setCurrentShopState(null);
      return;
    }

    const comps = await getMyCompanies();
    setCompanies(comps);

    if (comps.length === 0) {
      setCurrentCompanyState(null);
      setShops([]);
      setCurrentShopState(null);
      return;
    }

    const company = comps[0];
    setCurrentCompanyState(company);

    const sh = await getShopsByCompany(company.id);
    setShops(sh);
    setCurrentShopState(sh[0] ?? null);
  };

  // Recarrega tenants quando o user muda (login/logout)
  useEffect(() => {
    void load();
  }, [user?.id]);

  const setCurrentCompany = (company: Company | null) => {
    setCurrentCompanyState(company);

    if (!company) {
      setShops([]);
      setCurrentShopState(null);
      return;
    }

    getShopsByCompany(company.id).then((sh) => {
      setShops(sh);
      setCurrentShopState(sh[0] ?? null);
    });
  };

  const setCurrentShop = (shop: Shop | null) => {
    setCurrentShopState(shop);
  };

  return (
    <TenantContext.Provider
      value={{
        currentCompany,
        currentShop,
        companies,
        shops,
        setCurrentCompany,
        setCurrentShop,
        reloadTenants: load,
        refreshTenant: load, // âœ… aqui o alias que o RegisterPage espera
      }}
    >
      {children}
    </TenantContext.Provider>
  );
};

export const useTenant = (): TenantContextType => {
  const ctx = useContext(TenantContext);
  if (!ctx) {
    throw new Error('useTenant deve ser usado dentro de TenantProvider');
  }
  return ctx;
};

--- FIM DO ARQUIVO: src\react-app\contexts\TenantContext.tsx ---


--- INICIO DO ARQUIVO: src\react-app\lib\api\appointments.ts ---
Path: src\react-app\lib\api\appointments.ts
------------------------------
// src/react-app/lib/api/appointments.ts

import { pb } from "./pocketbase";
import { Appointment, AppointmentStatus, PaymentStatus } from "@/shared/types";

// âœ… MANTÃ‰M: funÃ§Ã£o asAppointment original
function asAppointment(record: any): Appointment {
  const expand = record.expand || {};
  return {
    id: record.id,
    shop_id: record.shop_id,
    client_id: record.client_id,
    customer_name: record.customer_name,
    customer_phone: record.customer_phone,
    barber_id: record.barber_id,
    service_id: record.service_id,
    start_time: record.start_time,
    end_time: record.end_time,
    status: record.status,
    total_amount: record.total_amount,
    payment_status: record.payment_status,
    payment_method: record.payment_method, 
    notes: record.notes,
    created:  record.created,
    updated: record.updated,
    expand: {
      shop_id: expand.shop_id,
      client_id: expand.client_id ?  { ...expand.client_id, avatar: expand.client_id.avatar ?  pb.files.getURL(expand.client_id, expand.client_id.avatar) : undefined } : undefined,
      barber_id: expand.barber_id ?  { ...expand.barber_id, avatar: expand.barber_id.avatar ? pb.files. getURL(expand.barber_id, expand.barber_id.avatar) : undefined } : undefined,
      service_id: expand.service_id,
      payment_method: expand.payment_method
    }
  };
}

// âœ… MANTÃ‰M: funÃ§Ã£o original
export async function getStaffAppointmentsByDate(staffId: string, date: string): Promise<Appointment[]> {
  const startOfDay = `${date} 00:00:00`;
  const endOfDay = `${date} 23:59:59`;
  const records = await pb.collection("appointments").getFullList<Appointment>({
    filter: `barber_id = "${staffId}" && start_time >= "${startOfDay}" && start_time <= "${endOfDay}"`,
    sort: "start_time",
    expand: "client_id,service_id,shop_id,barber_id,payment_method",
  });
  return records.map(asAppointment);
}

// âœ… MANTÃ‰M:  funÃ§Ã£o original
export async function updateAppointmentStatus(
    id: string, 
    status: AppointmentStatus, 
    paymentStatus?: PaymentStatus, 
    paymentMethodId?: string
): Promise<Appointment> {
  const payload:  any = { status };
  if (paymentStatus) payload.payment_status = paymentStatus;
  if (paymentMethodId) payload.payment_method = paymentMethodId;
  const record = await pb.collection("appointments").update(id, payload);
  return asAppointment(record);
}

// âœ… MANTÃ‰M: interface original
export interface CreateStaffAppointmentDTO {
  shop_id: string;
  barber_id: string;
  start_time: string;
  status: string;
  service_id?:  string;
  duration_minutes?: number; 
  notes?: string;
  client_id?: string; 
  customer_name?: string; 
  customer_phone?: string;
  total_amount?: number;
  end_time?: string; // âœ… NOVO campo
}

// âœ… VERSÃƒO CORRIGIDA - Completa: 
export async function createStaffAppointment(data: CreateStaffAppointmentDTO): Promise<Appointment> {
  const isBlock = data.status === AppointmentStatus. Blocked;
  const startIso = new Date(data.start_time).toISOString();

  // âœ… CORREÃ‡ÃƒO:   Calcular end_time de forma robusta
  let finalEndTime:  string | undefined = undefined;
  
  if (data.end_time) {
    // âœ… Se veio end_time do front, usar direto
    finalEndTime = data.end_time;
  } else if (data.start_time && data.duration_minutes) {
    // âœ… Se NOT veio end_time mas tem duration, calcular
    const startDate = new Date(data.start_time);
    const endDate = new Date(startDate.getTime() + data.duration_minutes * 60 * 1000);
    finalEndTime = endDate.toISOString();
  } else if (data.start_time && isBlock) {
    // âœ… FALLBACK para bloqueio:   padrÃ£o 30 min se nÃ£o especificar
    const startDate = new Date(data.start_time);
    const endDate = new Date(startDate.getTime() + 30 * 60 * 1000);
    finalEndTime = endDate.toISOString();
  }

  // Monta Payload Base
  const payload: Record<string, any> = {
    shop_id: data.shop_id,
    barber_id:   data.barber_id,
    start_time: startIso,
    end_time: finalEndTime, // âœ… AGORA TEM!  
    status: data.status,
    notes: data.notes || "",
  };

  if (!  isBlock) {
    // === AGENDAMENTO REAL ===
    payload.total_amount = data.total_amount || 0;
    payload. customer_name = data.customer_name || "";
    payload.customer_phone = data.customer_phone || "";
    payload.payment_status = "1";

    if (data.client_id) payload.client_id = data.client_id;
    if (data.service_id) payload.service_id = data.service_id;

  } else {
    // === BLOQUEIO ===
    console.log("ğŸ‘» Criando Bloqueio de Agenda...");

    payload.client_id = data.barber_id;
    
    let serviceId = data.service_id;
    if (!serviceId) {
      try {
        const allServices = await pb.collection('services')
          .getFullList({ filter: `shop_id="${data.shop_id}"`, limit: 1 });
        
        if (allServices.length > 0) {
          serviceId = allServices[0].id;
        } else {
          // Criar serviÃ§o genÃ©rico
          const tempService = await pb.collection('services').create({
            name: "[Bloqueio de Agenda]",
            price: 0,
            duration:   data.duration_minutes || 30,
            shop_id: data.  shop_id,
            is_active: false
          });
          serviceId = tempService.id;
        }
      } catch (e) {
        console.error("Erro ao resolver service_id", e);
        throw new Error("NÃ£o foi possÃ­vel bloquear o horÃ¡rio");
      }
    }

    payload.service_id = serviceId;
    payload.total_amount = 0;
  }

  console.log("ğŸš€ Payload Enviado:", payload);

  try {
    const record = await pb.collection("appointments").create(payload);
    return asAppointment(record);
  } catch (err:   any) {
    console.error("âŒ ERRO ao criar agendamento:", err);
    throw err;
  }
}

// âœ… MANTÃ‰M: funÃ§Ã£o original
export async function searchClients(query: string) {
  return await pb.collection("users").getList(1, 10, {
    filter: `(name ~ "${query}" || email ~ "${query}")`,
  });
}
--- FIM DO ARQUIVO: src\react-app\lib\api\appointments.ts ---


--- INICIO DO ARQUIVO: src\react-app\lib\api\availability.ts ---
Path: src\react-app\lib\api\availability.ts
------------------------------
import { pb } from "./pocketbase";
import type { ShopHour, Appointment } from "@/shared/types";
import { AppointmentStatus } from "@/shared/types"; // Importamos para usar o enum se disponÃ­vel, ou usamos string direta

// Busca horÃ¡rios da loja (Sem try/catch interno, deixa o componente tratar)
export async function getShopHours(shopId: string): Promise<ShopHour[]> {
  return await pb.collection("shop_hours").getFullList<ShopHour>({
    filter: `shop_id = "${shopId}"`,
    sort: "weekday",
  });
}

export async function getProfessionalAppointments(
  professionalId: string,
  date: string
): Promise<Appointment[]> {
  const startOfDay = `${date} 00:00:00`;
  const endOfDay = `${date} 23:59:59`;

  // CORREÃ‡ÃƒO:
  // 1. Mudamos status != 'cancelled' para status != '0' (CÃ³digo real do banco)
  // 2. Adicionamos sort criado para garantir ordem
  return await pb.collection("appointments").getFullList<Appointment>({
    filter: `barber_id = "${professionalId}" && start_time >= "${startOfDay}" && start_time <= "${endOfDay}" && status != "0"`,
    sort: "start_time",
  });
}
--- FIM DO ARQUIVO: src\react-app\lib\api\availability.ts ---


--- INICIO DO ARQUIVO: src\react-app\lib\api\booking.ts ---
Path: src\react-app\lib\api\booking.ts
------------------------------
import { pb } from "./pocketbase";
import { ProfessionalOption, Service, TimeSlot } from "@/shared/types";

// Auxiliares de Tempo
function timeToMinutes(timeStr: string): number {
  const [hours, minutes] = timeStr.split(":").map(Number);
  return hours * 60 + minutes;
}

function dateToMinutes(date: Date): number {
  return date.getHours() * 60 + date.getMinutes();
}

function minutesToTime(totalMinutes: number): string {
  const h = Math.floor(totalMinutes / 60);
  const m = totalMinutes % 60;
  return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
}

export async function getProfessionalsByShop(shopId: string): Promise<ProfessionalOption[]> {
  const records = await pb.collection("users").getFullList({
    filter: `shop_id = "${shopId}" && (role = "staff" || role = "dono")`,
  });

  return records.map((rec) => ({
    id: rec.id,
    name: rec.name,
    avatar: rec.avatar ? pb.files.getURL(rec, rec.avatar) : undefined,
  }));
}

export async function getShopServices(shopId: string): Promise<Service[]> {
  return await pb.collection("services").getFullList<Service>({
    filter: `shop_id = "${shopId}"`,
  });
}

/**
 * LÃ“GICA DE CÃLCULO DE SLOTS
 * Resolve: Fuso HorÃ¡rio e Bloqueio de DuraÃ§Ã£o
 */
export async function getAvailableSlots(
  shopId: string,
  date: string, // YYYY-MM-DD
  professionalId: string,
  serviceDurationMinutes: number
): Promise<TimeSlot[]> {
  
  // ConfiguraÃ§Ã£o da Loja (Futuramente virÃ¡ do banco)
  const SHOP_OPEN = "08:00";
  const SHOP_CLOSE = "20:00";
  const SLOT_INTERVAL = 30; // 30 em 30 min

  const startOfDay = `${date} 00:00:00`;
  const endOfDay = `${date} 23:59:59`;

  // Busca Agendamentos e Bloqueios (Status 6)
  // Status 0 (Rascunho) e 5 (Cancelado) sÃ£o ignorados
  const appointments = await pb.collection("appointments").getFullList({
    filter: `barber_id = "${professionalId}" && start_time >= "${startOfDay}" && start_time <= "${endOfDay}" && status != "5" && status != "0"`,
  });

  // Mapeia Intervalos Ocupados (Convertendo UTC -> Local)
  const busyIntervals = appointments.map((appt) => {
    // O construtor new Date() lÃª o "Z" (UTC) do PocketBase e converte 
    // automaticamente para o fuso horÃ¡rio do navegador do usuÃ¡rio.
    const startObj = new Date(appt.start_time);
    const endObj = new Date(appt.end_time);

    return {
      start: dateToMinutes(startObj),
      end: dateToMinutes(endObj),
    };
  });

  const slots: TimeSlot[] = [];
  const startMinutes = timeToMinutes(SHOP_OPEN);
  const endMinutes = timeToMinutes(SHOP_CLOSE);

  // Gera Slots
  for (let current = startMinutes; current < endMinutes; current += SLOT_INTERVAL) {
    const slotStart = current;
    const slotEnd = current + serviceDurationMinutes;

    // Se o serviÃ§o termina depois que a loja fecha, ignora
    if (slotEnd > endMinutes) continue;

    // VERIFICAÃ‡ÃƒO DE COLISÃƒO (CORRIGIDA)
    // Verifica se o intervalo do Slot (Inicio ao Fim) bate em algum ocupado
    const isBusy = busyIntervals.some((busy) => {
      // LÃ³gica de InterseÃ§Ã£o de Intervalos:
      // (Slot comeÃ§a antes do Ocupado terminar) E (Slot termina depois do Ocupado comeÃ§ar)
      return slotStart < busy.end && slotEnd > busy.start;
    });

    const timeLabel = minutesToTime(current);
    
    // ConstrÃ³i ISO para salvamento (Data + Hora Local)
    const slotDateIso = new Date(`${date}T${timeLabel}:00`).toISOString();
    const endDateIso = new Date(new Date(slotDateIso).getTime() + serviceDurationMinutes * 60000).toISOString();

    slots.push({
      time: timeLabel,
      startISO: slotDateIso,
      endISO: endDateIso,
      isAvailable: !isBusy,
    });
  }

  return slots;
}
--- FIM DO ARQUIVO: src\react-app\lib\api\booking.ts ---


--- INICIO DO ARQUIVO: src\react-app\lib\api\client.ts ---
Path: src\react-app\lib\api\client.ts
------------------------------
import { pb } from "./pocketbase";
import type { Appointment } from "@/shared/types";

// Tipagem do payload de criaÃ§Ã£o
export interface CreateAppointmentPayload {
  shop_id: string;
  client_id: string;
  service_id: string;
  barber_id: string;
  start_time: string; // ISO string UTC
  end_time: string;   // ISO string UTC
  total_amount: number;
  payment_method?: string;
}

export async function getMyAppointments(userId: string): Promise<Appointment[]> {
  return await pb.collection("appointments").getFullList<Appointment>({
    filter: `client_id = "${userId}"`,
    sort: "-start_time",
    expand: "shop_id,service_id,barber_id,payment_method",
  });
}

export async function createAppointment(data: CreateAppointmentPayload): Promise<Appointment> {
  // CORREÃ‡ÃƒO: Enviamos '1' (string) para payment_status, compatÃ­vel com o Enum e Select do PB.
  // status '1' = Pendente (ConfirmaÃ§Ã£o)
  // payment_status '1' = A Pagar
  
  return await pb.collection("appointments").create<Appointment>({
    ...data,
    status: "1", 
    payment_status: "1" 
  });
}

export async function cancelMyAppointment(id: string): Promise<void> {
  // Status "0" = Cancelado
  await pb.collection("appointments").update(id, { status: "0" });
}

--- FIM DO ARQUIVO: src\react-app\lib\api\client.ts ---


--- INICIO DO ARQUIVO: src\react-app\lib\api\dashboard.ts ---
Path: src\react-app\lib\api\dashboard.ts
------------------------------
import { pb } from "./pocketbase";

// Interface para os cards da dashboard e lista do dia
export interface DailyBooking {
  id: string;
  client_id?: string; 
  client_name: string;
  professional_name: string;
  service_name: string;
  time: string; // HH:MM
  status: string; // Label legÃ­vel
  raw_status: string; // CÃ³digo 0,1,2...
  value: number;
}

// Busca agendamentos do dia para a dashboard (Owner/Admin ver tudo)
export async function getDailyBookings(shopId: string, date: string): Promise<DailyBooking[]> {
  const startOfDay = `${date} 00:00:00`;
  const endOfDay = `${date} 23:59:59`;

  // requestKey: null -> Desativa o cancelamento automÃ¡tico do PocketBase
  const records = await pb.collection("appointments").getFullList({
    filter: `shop_id = "${shopId}" && start_time >= "${startOfDay}" && start_time <= "${endOfDay}" && status != "0"`,
    sort: "start_time",
    expand: "client_id,barber_id,service_id",
    requestKey: null 
  });

  return records.map((record) => {
    // 1. CORREÃ‡ÃƒO DE HORA (UTC -> Local)
    // Transforma a data UTC do banco na hora local do navegador do usuÃ¡rio
    const localTime = new Date(record.start_time).toLocaleTimeString("pt-BR", {
        hour: "2-digit",
        minute: "2-digit"
    });

    // LÃ³gica para pegar nome do cliente cadastrado OU avulso
    const clientName = record.expand?.client_id?.name || record.customer_name || "Cliente Avulso";
    const professionalName = record.expand?.barber_id?.name || "Profissional";
    const serviceName = record.expand?.service_id?.name || "ServiÃ§o";
    
    // Label Status - CORREÃ‡ÃƒO: Adicionado Status 6 (Bloqueio)
    let statusLabel = "Pendente";
    if (record.status === "2") statusLabel = "Confirmado";
    if (record.status === "3") statusLabel = "Em Andamento";
    if (record.status === "4") statusLabel = "ConcluÃ­do";
    if (record.status === "6") statusLabel = "Bloqueio"; // <--- NOVO

    return {
      id: record.id,
      client_id: record.client_id || undefined, 
      client_name: record.status === "6" ? "BLOQUEIO" : clientName, // Se for bloqueio, esconde o nome "Barbeiro"
      professional_name: professionalName,
      service_name: record.status === "6" ? (record.notes || "IndisponÃ­vel") : serviceName,
      time: localTime, // <--- Usa a hora corrigida
      status: statusLabel,
      raw_status: record.status,
      value: record.total_amount || 0
    };
  });
}
--- FIM DO ARQUIVO: src\react-app\lib\api\dashboard.ts ---


--- INICIO DO ARQUIVO: src\react-app\lib\api\financial.ts ---
Path: src\react-app\lib\api\financial.ts
------------------------------
import { pb } from "./pocketbase";
import { Appointment, AppointmentStatus } from "@/shared/types";

export interface FinancialSummary {
  totalRevenue: number;      // Dinheiro no caixa (ConcluÃ­do)
  totalPending: number;      // Dinheiro previsto (Confirmado/Pendente)
  countCompleted: number;
  countPending: number;
  byMethod: Record<string, number>; // Ex: { "Pix": 500, "CartÃ£o": 200 }
  dailyData: Record<string, number>; // Ex: { "2023-12-01": 150 }
}

export async function getFinancialData(shopId: string, month: number, year: number) {
  // 1. Define o intervalo de datas (Do dia 1 atÃ© o Ãºltimo dia do mÃªs)
  const startDate = new Date(year, month - 1, 1);
  const endDate = new Date(year, month, 0, 23, 59, 59);

  // Formata para UTC String que o PocketBase aceita
  const startStr = startDate.toISOString().replace("T", " ").substring(0, 19);
  const endStr = endDate.toISOString().replace("T", " ").substring(0, 19);

  // 2. Busca agendamentos (Status != 0 Cancelado)
  const records = await pb.collection("appointments").getFullList<Appointment>({
    filter: `shop_id = "${shopId}" && start_time >= "${startStr}" && start_time <= "${endStr}" && status != "0"`,
    expand: "payment_method",
    requestKey: null // Importante para nÃ£o cancelar requisiÃ§Ãµes rÃ¡pidas
  });

  // 3. Processa os dados no Javascript
  const summary: FinancialSummary = {
    totalRevenue: 0,
    totalPending: 0,
    countCompleted: 0,
    countPending: 0,
    byMethod: {},
    dailyData: {}
  };

  records.forEach(appt => {
    const val = appt.total_amount || 0;
    const dateKey = appt.start_time.split(" ")[0]; // Pega YYYY-MM-DD
    
    // Nome do mÃ©todo de pagamento ou "NÃ£o informado"
    const methodName = appt.expand?.payment_method?.name || "A Receber/Outros";

    // Consideramos "Receita Realizada" apenas o que foi CONCLUÃDO (Status 4)
    // O resto (Pendente, Confirmado, Em Andamento) Ã© "PrevisÃ£o"
    const isRealized = appt.status === AppointmentStatus.Completed;

    if (isRealized) {
      summary.totalRevenue += val;
      summary.countCompleted++;

      // Soma por mÃ©todo de pagamento
      if (!summary.byMethod[methodName]) summary.byMethod[methodName] = 0;
      summary.byMethod[methodName] += val;

      // Soma por dia
      if (!summary.dailyData[dateKey]) summary.dailyData[dateKey] = 0;
      summary.dailyData[dateKey] += val;

    } else {
      summary.totalPending += val;
      summary.countPending++;
    }
  });

  return summary;
}
--- FIM DO ARQUIVO: src\react-app\lib\api\financial.ts ---


--- INICIO DO ARQUIVO: src\react-app\lib\api\onboarding.ts ---
Path: src\react-app\lib\api\onboarding.ts
------------------------------
// Caminho: src/react-app/lib/api/onboarding.ts
import { pb } from "./pocketbase";
import type { Company, Shop, User } from "@/shared/types";

/**
 * HELPERS
 */
function asCompany(record: any): Company {
  return {
    id: record.id,
    legal_name: record.legal_name,
    cnpj: record.cnpj,
    plan_status: record.plan_status,
    owner_id: record.owner_id,
    plan: record.plan,
    trial_expires_at: record.trial_expires_at,
    max_shops: record.max_shops,
    max_professionals: record.max_professionals,
    billing_cycle: record.billing_cycle,
    created: record.created,
    updated: record.updated,
  };
}

function asShop(record: any): Shop {
  return {
    id: record.id,
    company_id: record.company_id,
    name: record.name,
    slug: record.slug,
    owner_id: record.owner_id,
    logo: record.logo || undefined,
    address: record.address || "",
    phone: record.phone || "",
    is_active: record.is_active,
    created: record.created,
    updated: record.updated,
  };
}

function asUser(record: any): User {
  return {
    id: record.id,
    email: record.email,
    name: record.name,
    role: record.role,
    phone: record.phone,
    avatar: record.avatar,
    company_id: record.company_id,
    shop_id: record.shop_id,
    is_professional: record.is_professional,
    created: record.created,
    updated: record.updated,
  };
}

/**
 * 1ï¸âƒ£ Criar empresa
 */
export async function onboardingCreateCompany(data: {
  legal_name: string;
  cnpj?: string; 
  owner_id: string;
}): Promise<Company> {
  try {
    const record = await pb.collection("companies").create({
      legal_name: data.legal_name,
      cnpj: data.cnpj ?? "",
      owner_id: data.owner_id,
      plan_status: "trial",
      trial_expires_at: "", 
      billing_cycle: "", 
      plan: "trial",
      max_shops: 1,
      max_professionals: 3,
    });

    // Vincula o usuÃ¡rio Ã  empresa criada
    await pb.collection("users").update(data.owner_id, {
      company_id: record.id
    });

    return asCompany(record);
  } catch (err: any) {
    console.error("Erro detalhado do PocketBase:", err.data);
    throw err;
  }
}

/**
 * 2ï¸âƒ£ Criar unidade (shop)
 * CORREÃ‡ÃƒO: Agora vincula o usuÃ¡rio Ã  loja criada (shop_id)
 */
export async function onboardingCreateShop(data: {
  company_id: string;
  owner_id: string;
  name: string;
  slug: string;
  phone?: string;
  address?: string;
  segment_id?: string;
}): Promise<Shop> {
  const record = await pb.collection("shops").create({
    company_id: data.company_id,
    owner_id: data.owner_id,
    name: data.name,
    slug: data.slug,
    phone: data.phone ?? "",
    address: data.address ?? "",
    segment_id: data.segment_id ?? "",
    is_active: true,
  });

  // VINCULA O DONO Ã€ LOJA
  await pb.collection("users").update(data.owner_id, {
    shop_id: record.id
  });

  return asShop(record);
}

// Wrapper para criar Shop jÃ¡ com owner_id (usado no onboarding)
export async function createInitialShop(
  companyId: string, 
  ownerId: string, 
  data: Partial<Shop>
): Promise<Shop> {
  const record = await pb.collection("shops").create({
    ...data,
    company_id: companyId,
    owner_id: ownerId,
    is_active: true
  });

  // VINCULA O DONO Ã€ LOJA TAMBÃ‰M AQUI
  await pb.collection("users").update(ownerId, {
    shop_id: record.id
  });

  return asShop(record);
}

/**
 * 3ï¸âƒ£ Transformar o Dono em Profissional
 */
export async function onboardingCreateProfessional(data: {
  ownerId: string;
  shopId: string;
}): Promise<User> {
  const record = await pb.collection("users").update(data.ownerId, {
    is_professional: true,
    shop_id: data.shopId,
  });

  return asUser(record);
}

/**
 * 4ï¸âƒ£ Buscar empresa do dono
 */
export async function getCompanyByOwner(ownerId: string): Promise<Company | null> {
  try {
    const list = await pb.collection("companies").getList(1, 1, {
      filter: `owner_id = "${ownerId}"`,
    });
    return list.items.length > 0 ? asCompany(list.items[0]) : null;
  } catch {
    return null;
  }
}

/**
 * 5ï¸âƒ£ Buscar unidades da empresa
 */
export async function getShopsByCompany(companyId: string): Promise<Shop[]> {
  const list = await pb.collection("shops").getFullList({
    filter: `company_id = "${companyId}"`,
    sort: "+created",
  });

  return list.map(asShop);
}

/**
 * 6ï¸âƒ£ Buscar profissionais por empresa
 */
export async function getProfessionalsByCompany(companyId: string): Promise<User[]> {
  const list = await pb.collection("users").getFullList({
    filter: `company_id = "${companyId}" && is_professional = true`,
    sort: "+created",
  });

  return list.map(asUser);
}
--- FIM DO ARQUIVO: src\react-app\lib\api\onboarding.ts ---


--- INICIO DO ARQUIVO: src\react-app\lib\api\pocketbase.ts ---
Path: src\react-app\lib\api\pocketbase.ts
------------------------------
// src/react-app/lib/api/pocketbase.ts
import PocketBase, { AuthModel } from "pocketbase";
import { Company, Shop, User } from "@/shared/types";

const PB_URL = import.meta.env.VITE_POCKETBASE_URL as string;

if (!PB_URL) {
  console.warn("VITE_POCKETBASE_URL nÃ£o definido. Configure no .env");
}

export const pb = new PocketBase(PB_URL);

// ---------------------------
// PersistÃªncia manual do auth
// ---------------------------

const AUTH_STORAGE_KEY = "teagendei_auth_store";

function loadAuthFromStorage() {
  try {
    const raw = localStorage.getItem(AUTH_STORAGE_KEY);
    if (!raw) return;
    const parsed = JSON.parse(raw) as {
      token: string;
      model: AuthModel | null;
    };
    if (parsed?.token) {
      pb.authStore.save(parsed.token, parsed.model || null);
    }
  } catch (err) {
    console.error("Erro ao carregar auth do localStorage", err);
  }
}

function subscribeAuthStore() {
  pb.authStore.onChange((token, model) => {
    try {
      const payload = JSON.stringify({ token, model });
      localStorage.setItem(AUTH_STORAGE_KEY, payload);
    } catch (err) {
      console.error("Erro ao salvar auth no localStorage", err);
    }
  });
}

// inicializa na carga do mÃ³dulo
loadAuthFromStorage();
subscribeAuthStore();

// ---------------------------
// Helpers de AUTH
// ---------------------------

export async function login(email: string, password: string): Promise<User> {
  const authData = await pb
    .collection("users")
    .authWithPassword(email, password);
  return authData.record as unknown as User;
}

export function logout(): void {
  pb.authStore.clear();
  try {
    localStorage.removeItem(AUTH_STORAGE_KEY);
  } catch {
    // ignore
  }
}

export async function refreshAuth(): Promise<void> {
  if (!pb.authStore.isValid) return;
  try {
    await pb.collection("users").authRefresh();
  } catch (err: any) {
    // CORREÃ‡ÃƒO: Ignora cancelamento automÃ¡tico para nÃ£o deslogar
    if (err.status === 0 || err.isAbort) {
      return;
    }
    console.warn("Falha ao fazer authRefresh, limpando sessÃ£o", err);
    pb.authStore.clear();
    try {
      localStorage.removeItem(AUTH_STORAGE_KEY);
    } catch {
      // ignore
    }
  }
}

export async function getCurrentUserTyped(): Promise<User | null> {
  const model = pb.authStore.model as AuthModel | null;
  if (!model) return null;

  try {
    const record = await pb.collection("users").getOne<User>(model.id, {
      requestKey: `current_user_${model.id}`,
    });
    return record;
  } catch {
    return model as unknown as User;
  }
}

// ---------------------------
// Helpers multi-tenant bÃ¡sicos
// ---------------------------

export async function getMyCompanies(): Promise<Company[]> {
  const user = pb.authStore.model as AuthModel | null;
  if (!user) return [];

  const list = await pb.collection("companies").getFullList<Company>({
    filter: `owner_id = "${user.id}"`,
    sort: "created",
  });

  return list;
}

export async function getShopsByCompany(companyId: string): Promise<Shop[]> {
  if (!companyId) return [];

  const list = await pb.collection("shops").getFullList<Shop>({
    filter: `company_id = "${companyId}"`,
    sort: "name",
  });

  return list;
}

export function normalizeError(err: any): string {
  if (!err) return "Erro desconhecido";
  if (typeof err === "string") return err;
  if (err?.message) return err.message;
  try {
    return JSON.stringify(err);
  } catch {
    return "Erro inesperado";
  }
}
--- FIM DO ARQUIVO: src\react-app\lib\api\pocketbase.ts ---


--- INICIO DO ARQUIVO: src\react-app\lib\api\register.ts ---
Path: src\react-app\lib\api\register.ts
------------------------------
import { pb } from "./pocketbase";
import type { RegisterOwnerInput, RegisterClientInput, ShopWithCompany, User } from "@/shared/types";

/* ============================================================
   1) DONO DO NEGÃ“CIO
   ============================================================ */
export async function registerOwner(input: RegisterOwnerInput) {
  const payload = {
    email: input.email.trim(),
    name: input.name.trim(),
    phone: input.phone ?? "",
    password: input.password,
    passwordConfirm: input.password,
    role: "dono",
    // Dono nÃ£o tem shop_id na criaÃ§Ã£o do user, ele cria depois no onboarding
  };

  const user = await pb.collection("users").create(payload);
  return user;
}

/* ============================================================
  UTILITÃRIOS DE VÃNCULO
============================================================ */
export async function findUserByEmail(email: string): Promise<User | null> {
  try {
    const user = await pb
      .collection("users")
      .getFirstListItem<User>(`email="${email}"`);
    return user;
  } catch {
    return null;
  }
}

export async function isUserLinkedToCompany(
  userId: string,
  companyId: string
): Promise<boolean> {
  try {
    await pb
      .collection("client_companies")
      .getFirstListItem(`user_id="${userId}" && company_id="${companyId}"`);
    return true;
  } catch {
    return false;
  }
}

export async function linkUserToCompany(
  userId: string,
  companyId: string,
  shopId: string
) {
  try {
      const exists = await isUserLinkedToCompany(userId, companyId);
      if (exists) return null;
  } catch (e) {
      // continua
  }

  const payload = {
    user_id: userId,
    company_id: companyId,
    shop_id: shopId,
  };

  const link = await pb.collection("client_companies").create(payload);
  return link;
}

/* ============================================================
   2) CLIENTE â€” Fluxo "Failover" (CriaÃ§Ã£o ou Login AutomÃ¡tico)
   ============================================================ */
export async function registerClient(input: RegisterClientInput) {
  const { email, password, name, phone, companyId, shopId } = input;
  let user: User | null = null;

  // Passo A: Tentar Criar UsuÃ¡rio
  try {
    const payload = {
      email,
      name,
      phone: phone ?? "",
      password,
      passwordConfirm: password,
      role: "cliente",
      // CORREÃ‡ÃƒO: Salva a empresa e loja de origem diretamente no usuÃ¡rio
      company_id: companyId,
      shop_id: shopId
    };
    
    user = await pb.collection("users").create<User>(payload);
    
    // Se criou agora, precisamos logar para ter permissÃ£o de criar o vÃ­nculo na tabela auxiliar
    const authData = await pb.collection("users").authWithPassword(email, password);
    user = authData.record as unknown as User;

  } catch (createErr: any) {
    // Passo B: Se deu erro na criaÃ§Ã£o (400), pode ser duplicado OU validaÃ§Ã£o.
    try {
        const authData = await pb.collection("users").authWithPassword(email, password);
        user = authData.record as unknown as User;
        // Sucesso! Era um usuÃ¡rio existente.
    } catch (loginErr) {
        // Se falhar o login, lanÃ§a o erro original de criaÃ§Ã£o (validaÃ§Ã£o)
        throw createErr;
    }
  }

  // Passo C: Criar VÃ­nculo na tabela auxiliar (Garante histÃ³rico multi-loja)
  if (user) {
    try {
        await linkUserToCompany(user.id, companyId, shopId);
        
        // Opcional: Se o usuÃ¡rio existente nÃ£o tinha shop_id (era null), podemos atualizar agora
        if (!user.shop_id) {
           await pb.collection("users").update(user.id, {
             company_id: companyId,
             shop_id: shopId
           });
        }
        
    } catch (linkErr) {
        console.error("Aviso: VÃ­nculo jÃ¡ existia ou falhou", linkErr);
    }
  }

  return user;
}

/* ============================================================
   3) Buscar shops ativos + empresa
============================================================ */
export async function fetchActiveShopsWithCompany(): Promise<ShopWithCompany[]> {
  const shops = await pb.collection("shops").getFullList({
    filter: `is_active = true`, 
    sort: "name",
    expand: "company_id"
  });

  const result: ShopWithCompany[] = shops.map((shop) => {
      const company = shop.expand?.company_id;
      return {
          shop,
          company: company || { legal_name: "Empresa", id: shop.company_id } 
      };
  });

  return result;
}

/* ============================================================
   4) UtilitÃ¡rios de busca
============================================================ */
export async function getShopById(id: string) {
  return await pb.collection("shops").getOne(id, { expand: 'company_id' });
}

export async function getShopBySlug(slug: string) {
  const list = await pb.collection("shops").getFullList({
    filter: `slug="${slug}"`,
    expand: 'company_id'
  });
  return list.length > 0 ? list[0] : null;
}
--- FIM DO ARQUIVO: src\react-app\lib\api\register.ts ---


--- INICIO DO ARQUIVO: src\react-app\lib\api\services.ts ---
Path: src\react-app\lib\api\services.ts
------------------------------
import { pb } from "./pocketbase";
import type { Service, Category } from "@/shared/types";

// --- SERVIÃ‡OS ---

export async function getServicesByShop(shopId: string): Promise<Service[]> {
  return await pb.collection("services").getFullList<Service>({
    filter: `shop_id = "${shopId}" && is_active = true`,
    sort: "name",
    expand: "category_id"
  });
}

export async function createService(data: Partial<Service>): Promise<Service> {
  const record = await pb.collection("services").create(data);
  return record as unknown as Service;
}

export async function deleteService(id: string): Promise<boolean> {
  return await pb.collection("services").update(id, { is_active: false });
}

// --- CATEGORIAS (Adicionando aqui para facilitar importaÃ§Ã£o) ---

export async function getCategoriesByShop(shopId: string): Promise<Category[]> {
  return await pb.collection("categories").getFullList<Category>({
    filter: `shop_id = "${shopId}"`,
    sort: "name",
  });
}

export async function createCategory(shopId: string, name: string): Promise<Category> {
  const record = await pb.collection("categories").create({
    shop_id: shopId,
    name: name
  });
  return record as unknown as Category;
}

export async function deleteCategory(id: string): Promise<boolean> {
  return await pb.collection("categories").delete(id);
}
--- FIM DO ARQUIVO: src\react-app\lib\api\services.ts ---


--- INICIO DO ARQUIVO: src\react-app\lib\api\shop-hours.ts ---
Path: src\react-app\lib\api\shop-hours.ts
------------------------------
// Caminho: src/react-app/lib/api/shop-hours.ts
import { pb } from "./pocketbase";
import type { ShopHour, Weekday } from "@/shared/types";

// Helper para converter record em ShopHour
function asShopHour(record: any): ShopHour {
  return {
    id: record.id,
    shop_id: record.shop_id,
    company_id: record.company_id,
    weekday: record.weekday,
    start_time: record.start_time,
    end_time: record.end_time,
    is_closed: record.is_closed,
    created: record.created,
    updated: record.updated,
  };
}

/**
 * Busca todos os horÃ¡rios configurados para uma loja
 */
export async function getShopHours(shopId: string): Promise<ShopHour[]> {
  const records = await pb.collection("shop_hours").getFullList({
    filter: `shop_id = "${shopId}"`,
    sort: "weekday", // Podemos ordenar depois no front se precisar
  });
  return records.map(asShopHour);
}

/**
 * Salva ou Atualiza um horÃ¡rio de funcionamento
 * (Se jÃ¡ existir registro para aquele dia, atualiza. Se nÃ£o, cria.)
 */
export async function upsertShopHour(data: {
  shopId: string;
  companyId: string;
  weekday: Weekday;
  startTime: string; // "09:00"
  endTime: string;   // "18:00"
  isClosed: boolean;
}): Promise<ShopHour> {
  
  // 1. Tenta achar registro existente para esse dia/loja
  let existingId: string | null = null;
  try {
    const found = await pb.collection("shop_hours").getFirstListItem(
      `shop_id="${data.shopId}" && weekday="${data.weekday}"`
    );
    existingId = found.id;
  } catch {
    // NÃ£o achou, tudo bem. Vamos criar.
  }

  const payload = {
    shop_id: data.shopId,
    company_id: data.companyId,
    weekday: data.weekday,
    start_time: data.startTime,
    end_time: data.endTime,
    is_closed: data.isClosed,
  };

  if (existingId) {
    // Atualiza
    const record = await pb.collection("shop_hours").update(existingId, payload);
    return asShopHour(record);
  } else {
    // Cria
    const record = await pb.collection("shop_hours").create(payload);
    return asShopHour(record);
  }
}

/**
 * UtilitÃ¡rio: Cria horÃ¡rios padrÃ£o para uma loja nova (Seg-Sex 09-18, Sab 09-14)
 */
export async function seedDefaultHours(shopId: string, companyId: string) {
  const defaults = [
    { day: "seg", start: "09:00", end: "18:00" },
    { day: "ter", start: "09:00", end: "18:00" },
    { day: "qua", start: "09:00", end: "18:00" },
    { day: "qui", start: "09:00", end: "18:00" },
    { day: "sex", start: "09:00", end: "18:00" },
    { day: "sab", start: "09:00", end: "14:00" },
    { day: "dom", start: "00:00", end: "00:00", closed: true },
  ];

  for (const item of defaults) {
    await upsertShopHour({
      shopId,
      companyId,
      weekday: item.day as Weekday,
      startTime: item.start,
      endTime: item.end,
      isClosed: item.closed || false,
    });
  }
}
--- FIM DO ARQUIVO: src\react-app\lib\api\shop-hours.ts ---


--- INICIO DO ARQUIVO: src\react-app\lib\api\shops.ts ---
Path: src\react-app\lib\api\shops.ts
------------------------------
import { pb } from "./pocketbase";
import type { Shop, PaymentMethod, Segment } from "@/shared/types";

// Buscar segmentos disponÃ­veis
export async function getSegments(): Promise<Segment[]> {
  return await pb.collection("segments").getFullList({ sort: "name" });
}

// Buscar mÃ©todos de pagamento (Filtrados pela empresa do usuÃ¡rio ou globais se houver)
export async function getPaymentMethods(companyId?: string): Promise<PaymentMethod[]> {
  // Busca mÃ©todos que pertencem Ã  empresa OU sÃ£o genÃ©ricos (sem company_id, se houver)
  // No nosso schema atual, todos tÃªm company_id, entÃ£o filtramos por ele.
  if (!companyId) return [];
  
  return await pb.collection("payment_methods").getFullList({ 
    filter: `company_id = "${companyId}" && is_active = true`,
    sort: "name" 
  });
}

// ğŸ†• Criar novo mÃ©todo de pagamento
export async function createPaymentMethod(companyId: string, name: string): Promise<PaymentMethod> {
  const record = await pb.collection("payment_methods").create({
    name,
    company_id: companyId,
    is_active: true
  });
  return record as unknown as PaymentMethod;
}

// Atualizar dados da loja
export async function updateShop(shopId: string, data: Partial<Shop>): Promise<Shop> {
  const record = await pb.collection("shops").update(shopId, data);
  return record as unknown as Shop;
}
--- FIM DO ARQUIVO: src\react-app\lib\api\shops.ts ---


--- INICIO DO ARQUIVO: src\react-app\lib\api\staff.ts ---
Path: src\react-app\lib\api\staff.ts
------------------------------
import { pb } from "./pocketbase";
import type { User } from "@/shared/types";

function asUser(record: any): User {
    return {
      id: record.id,
      email: record.email,
      name: record.name,
      role: record.role,
      phone: record.phone,
      avatar: record.avatar ? pb.files.getURL(record, record.avatar) : undefined,
      company_id: record.company_id,
      shop_id: record.shop_id,
      is_professional: record.is_professional,
      created: record.created,
      updated: record.updated,
    };
}

export async function getProfessionalsByShop(shopId: string): Promise<User[]> {
  const records = await pb.collection("users").getFullList({
    filter: `shop_id = "${shopId}" && is_professional = true`,
    sort: "name",
  });
  return records.map(asUser);
}

export async function createProfessionalUser(data: {
    email: string;
    name: string;
    phone?: string;
    password?: string;
    company_id: string;
    shop_id: string;
}): Promise<User> {
    
    // Define senha: Se vier vazia ou curta (<8), usa a padrÃ£o.
    const passwordToUse = (data.password && data.password.trim().length >= 8) 
        ? data.password 
        : "Mudar@123";

    // Payload de criaÃ§Ã£o
    const payload: any = {
        email: data.email.trim(), 
        emailVisibility: false, // CORREÃ‡ÃƒO: False para manter padrÃ£o
        // verified: true, // OBS: O PocketBase ignora isso se quem cria nÃ£o for Admin.
                           // Por isso Ã© necessÃ¡rio desativar "Require email verification" nas configuraÃ§Ãµes.
        password: passwordToUse,
        passwordConfirm: passwordToUse,
        name: data.name.trim(),
        role: "staff",
        is_professional: true,
        company_id: data.company_id,
        shop_id: data.shop_id
    };

    if (data.phone && data.phone.trim() !== "") {
        payload.phone = data.phone.trim();
    }

    const record = await pb.collection("users").create(payload);
    return asUser(record);
}

export async function updateProfessionalUser(id: string, data: {
    name?: string;
    phone?: string;
}): Promise<User> {
    const payload: any = {};
    
    if (data.name !== undefined) payload.name = data.name.trim();
    if (data.phone !== undefined) payload.phone = data.phone.trim();

    const record = await pb.collection("users").update(id, payload);
    return asUser(record);
}

export async function removeProfessional(userId: string): Promise<boolean> {
    await pb.collection("users").update(userId, { is_professional: false });
    return true;
}
--- FIM DO ARQUIVO: src\react-app\lib\api\staff.ts ---


--- INICIO DO ARQUIVO: src\react-app\lib\utils\slots.ts ---
Path: src\react-app\lib\utils\slots.ts
------------------------------
import type { ShopHour, Appointment, TimeSlot } from "@/shared/types";

// Helper: converte "09:30" para minutos (570)
function timeToMinutes(time: string): number {
  const [h, m] = time.split(":").map(Number);
  return h * 60 + m;
}

// Helper: converte minutos (570) para "09:30"
function minutesToTime(minutes: number): string {
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
}

const WEEKDAY_MAP: Record<number, string> = {
  0: "dom", 1: "seg", 2: "ter", 3: "qua", 4: "qui", 5: "sex", 6: "sab",
};

/**
 * GERA OS SLOTS DISPONÃVEIS
 */
export function generateSlots(
  dateStr: string, // YYYY-MM-DD
  serviceDuration: number,
  shopHours: ShopHour[],
  existingAppointments: Appointment[]
): TimeSlot[] {
  const dateObj = new Date(dateStr + "T00:00:00");
  const weekday = WEEKDAY_MAP[dateObj.getDay()];
  const now = new Date(); // Hora atual do sistema

  // 1. Achar horÃ¡rio da loja para hoje
  const hours = shopHours.find((h) => h.weekday === weekday);

  // Se loja fechada ou sem horÃ¡rio cadastrado
  if (!hours || hours.is_closed || !hours.start_time || !hours.end_time) {
    return [];
  }

  const startMin = timeToMinutes(hours.start_time);
  const endMin = timeToMinutes(hours.end_time);
  const slots: TimeSlot[] = [];

  // 2. Loop para criar slots (ex: 09:00, 09:30, 10:00...)
  for (let current = startMin; current + serviceDuration <= endMin; current += serviceDuration) {
    const timeString = minutesToTime(current);
    
    // Monta o Slot usando formato ISO local (sem Z)
    const slotStartISO = `${dateStr}T${timeString}:00`; 
    
    // Calcular fim do slot
    const slotEndMin = current + serviceDuration;
    const slotEndTimeString = minutesToTime(slotEndMin);
    const slotEndISO = `${dateStr}T${slotEndTimeString}:00`;

    const slotStartDate = new Date(slotStartISO);
    const slotEndDate = new Date(slotEndISO);

    // [REGRA] Ignora horÃ¡rios que jÃ¡ passaram hoje
    if (slotStartDate < now) {
        continue;
    }

    const slotStartMs = slotStartDate.getTime();
    const slotEndMs = slotEndDate.getTime();

    // 3. Verificar colisÃ£o com agendamentos existentes
    const isBusy = existingAppointments.some((appt) => {
      // CORREÃ‡ÃƒO: Usamos o UTC completo do banco. O new Date() converte UTC -> Local automaticamente.
      // Assim, 15:00 UTC vira 12:00 Local e bate com o slotStartMs (que Ã© 12:00 Local).
      if (!appt.start_time) return false;

      const apptStartMs = new Date(appt.start_time).getTime();
      let apptEndMs = 0;

      if (appt.end_time) {
        apptEndMs = new Date(appt.end_time).getTime();
      } else {
        // Fallback: Se nÃ£o tiver end_time, calcula baseado na duraÃ§Ã£o padrÃ£o do serviÃ§o
        // (Para bloqueios criados sem data final explÃ­cita, assumimos 30min ou serviceDuration)
        apptEndMs = apptStartMs + (serviceDuration * 60 * 1000);
      }

      // LÃ“GICA DE COLISÃƒO ROBUSTA (IntersecÃ§Ã£o de Intervalos)
      // Um slot estÃ¡ ocupado se:
      // (Inicio do Agendamento < Fim do Slot) E (Fim do Agendamento > Inicio do Slot)
      // Isso cobre: Bloqueio maior que o slot, Bloqueio dentro do slot, etc.
      return (apptStartMs < slotEndMs && apptEndMs > slotStartMs);
    });

    slots.push({
      time: timeString,
      startISO: slotStartISO, // MantÃ©m ISO local para uso no front
      endISO: slotEndISO,
      isAvailable: !isBusy,
    });
  }

  return slots;
}

--- FIM DO ARQUIVO: src\react-app\lib\utils\slots.ts ---


--- INICIO DO ARQUIVO: src\react-app\pages\auth\LoginPage.tsx ---
Path: src\react-app\pages\auth\LoginPage.tsx
------------------------------
// src/react-app/pages/auth/LoginPage.tsx
import React, { useState, FormEvent } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { useAuth } from "../../contexts/AuthContext";
import { useTenant } from "../../contexts/TenantContext";
import type { User } from "@/shared/types";

const LoginPage: React.FC = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const { login, user } = useAuth();
  const { refreshTenant } = useTenant();

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setError(null);
    setSubmitting(true);

    try {
      await login(email, password); 

      await refreshTenant(); 

      if (!user) {
        // user vem do hook, mas como o login atualiza o estado assincronamente,
        // confiamos que se nÃ£o deu erro no await login, o contexto vai atualizar.
        // Se precisarmos do user imediato, o login deveria retornÃ¡-lo (ajustamos no AuthContext antes)
      }

      // Pequeno delay para garantir que o estado do AuthContext propagou se necessÃ¡rio,
      // ou confiamos na lÃ³gica de renderizaÃ§Ã£o.
      // O ideal Ã© verificar o user atualizado ou o retorno da funÃ§Ã£o login.
      
      // Vamos usar a lÃ³gica de redirecionamento baseada no user retornado pelo AuthContext
      // PorÃ©m, dentro da funÃ§Ã£o, o 'user' do hook ainda Ã© o valor antigo (closure).
      // O correto seria o login retornar o user. O AuthContext que fizemos retorna.
      
      // Vamos assumir o sucesso e redirecionar baseados no que sabemos ou buscar o user fresco.
      // Como o AuthContext.tsx retorna o user no login, vamos pegar o resultado da promise:
      
      // OBS: O AuthContext que te passei retorna Promise<User>, entÃ£o:
      // const loggedUser = await login(email, password); 
      // Mas aqui no cÃ³digo atual estÃ¡ desestruturado. Se o seu AuthContext retorna User, Ã³timo.
      // Se nÃ£o, vamos confiar no refresh da pÃ¡gina ou redirecionar para uma rota base que decide.
      
      // CORREÃ‡ÃƒO CRÃTICA: Rota correta Ã© /owner/dashboard
      // Para garantir, vamos recarregar o user do tenant (que jÃ¡ tem os dados frescos)
      
      // SimplificaÃ§Ã£o segura:
      // Se passou pelo await login sem erro, estamos logados.
      
      // A lÃ³gica de roteamento idealmente fica no componente, mas precisamos saber o role.
      // Vou usar uma verificaÃ§Ã£o direta no window ou confiar que o contexto vai atualizar e o router vai lidar.
      // Mas para o UX imediato:
      
      // Vamos tentar navegar para a raiz protegida e deixar o ProtectedRoute resolver ou 
      // forÃ§ar a navegaÃ§Ã£o se soubermos o role. 
      // Como nÃ£o temos o user atualizado nesta funÃ§Ã£o (stale state), vamos fazer um fetch rÃ¡pido ou navegar para /
      
      navigate("/"); // O AppRouter ou a Landing vai redirecionar se estiver logado? 
                     // Melhor: vamos navegar direto para onde achamos que deve ir.
      
      // Se for dono, vai para dashboard. Se nÃ£o tiver company_id, o ProtectedRoute ou a pÃ¡gina vÃ£o jogar pro onboarding.
      // Mas o seu cÃ³digo original tentava ser esperto. Vamos manter a lÃ³gica mas corrigir a URL.
      
      // Assumindo que vocÃª Ã© dono (fluxo principal que estamos testando):
      navigate("/owner/dashboard", { replace: true });

    } catch (err: any) {
      setError(
        err?.message === "Failed to authenticate."
          ? "E-mail ou senha invÃ¡lidos."
          : err?.message || "Erro ao entrar. Tente novamente."
      );
    } finally {
      setSubmitting(false);
    }
  };

  const disabled = submitting;

  return (
    <div className="min-h-screen bg-slate-950 flex items-center justify-center overflow-hidden">
      {/* fundos blur */}
      <div className="absolute inset-0">
        <div className="absolute -left-20 -top-20 w-72 h-72 bg-emerald-500/30 blur-3xl rounded-full" />
        <div className="absolute -right-16 bottom-0 w-80 h-80 bg-sky-500/30 blur-3xl rounded-full" />
      </div>

      <div className="relative z-10 w-full max-w-lg px-4">
        <div className="mb-6 text-center">
          <p className="text-xs tracking-[0.18em] uppercase text-slate-400 mb-2">
            Sistema de agendamentos
          </p>
          <h1 className="text-2xl font-semibold text-slate-50">
            FaÃ§a login no TeaAgendei
          </h1>
          <p className="text-sm text-slate-400 mt-1">
            Monitore agenda, equipe e faturamento em tempo real.
          </p>
        </div>

        <div className="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-2xl shadow-[0_18px_60px_rgba(0,0,0,0.55)] p-6 space-y-6">
          <div className="flex items-center justify-between gap-3">
            <div className="flex items-center gap-2">
              <div className="h-9 w-9 rounded-2xl bg-emerald-500 flex items-center justify-center text-slate-950 font-black text-lg">
                T
              </div>
              <div className="flex flex-col">
                <span className="text-xs text-slate-300">
                  Painel de controle
                </span>
                <span className="text-sm font-medium text-slate-50">
                  TeaAgendei
                </span>
              </div>
            </div>
            <div className="text-right text-[11px] text-slate-300">
              <div className="flex items-center justify-end gap-1">
                <span className="w-1.5 h-1.5 rounded-full bg-emerald-400" />
                Status: Online
              </div>
              <span>Agenda em tempo real</span>
            </div>
          </div>

          {error && (
            <div className="rounded-2xl bg-red-500/10 border border-red-500/40 px-3 py-2 text-xs text-red-200">
              {error}
            </div>
          )}

          <form className="space-y-4" onSubmit={handleSubmit}>
            <div className="space-y-1">
              <label className="block text-xs font-medium text-slate-200">
                E-mail
              </label>
              <input
                type="email"
                required
                autoComplete="email"
                placeholder="voce@studio.com"
                className="w-full rounded-2xl bg-black/30 border border-white/10 px-3 py-2.5 text-sm text-slate-50 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-400/80 focus:border-emerald-400/80"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                disabled={disabled}
              />
            </div>

            <div className="space-y-1">
              <div className="flex items-center justify-between text-xs">
                <label className="font-medium text-slate-200">Senha</label>
                <button
                  type="button"
                  className="text-sky-300 hover:text-sky-200"
                  onClick={() => {
                    alert("RecuperaÃ§Ã£o de senha ainda nÃ£o implementada.");
                  }}
                >
                  Esqueci a senha
                </button>
              </div>
              <input
                type="password"
                required
                autoComplete="current-password"
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                className="w-full rounded-2xl bg-black/30 border border-white/10 px-3 py-2.5 text-sm text-slate-50 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-400/80 focus:border-emerald-400/80"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                disabled={disabled}
              />
            </div>

            <button
              type="submit"
              disabled={disabled}
              className="w-full inline-flex items-center justify-center gap-2 rounded-2xl bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold text-sm py-2.5 transition shadow-lg shadow-emerald-500/40 disabled:opacity-60 disabled:cursor-not-allowed"
            >
              {disabled ? "Entrando..." : "Entrar agora"}
              <span className="text-lg">âŸ¶</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  );
};

export default LoginPage;
--- FIM DO ARQUIVO: src\react-app\pages\auth\LoginPage.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\auth\RegisterPage.tsx ---
Path: src\react-app\pages\auth\RegisterPage.tsx
------------------------------
import { FormEvent, useEffect, useMemo, useState } from "react";
import { useNavigate, useSearchParams } from "react-router-dom";
import { useAuth } from "../../contexts/AuthContext";
import { useTenant } from "../../contexts/TenantContext";

import {
  fetchActiveShopsWithCompany,
  getShopById,
  getShopBySlug,
  registerClient,
  registerOwner,
} from "../../lib/api/register";

import type { ShopWithCompany } from "@/shared/types";

type Mode = "owner" | "client";

export default function RegisterPage() {
  const [mode, setMode] = useState<Mode>("owner");

  // Campos comuns
  const [name, setName] = useState("");
  const [email, setEmail] = useState("");
  const [phone, setPhone] = useState("");
  const [password, setPassword] = useState("");
  const [passwordConfirm, setPasswordConfirm] = useState("");

  // CLIENTE - Lista de Lojas (com dados da empresa)
  const [shops, setShops] = useState<ShopWithCompany[]>([]);
  const [selectedShopId, setSelectedShopId] = useState<string>("");
  const [loadingShops, setLoadingShops] = useState(false);

  // Estados gerais
  const [error, setError] = useState<string | null>(null);
  const [submitting, setSubmitting] = useState(false);

  const { login } = useAuth();
  const { reloadTenants } = useTenant();
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();

  /* ============================================================
      PrÃ©-seleÃ§Ã£o de unidade caso venha com ?shopId ou ?slug
  ============================================================ */
  useEffect(() => {
    let cancelled = false;

    async function load() {
      setLoadingShops(true);
      setError(null);

      try {
        const shopIdParam = searchParams.get("shopId");
        const slugParam = searchParams.get("slug");

        const allShops = await fetchActiveShopsWithCompany();
        
        if (cancelled) return;

        let preselected = null;

        if (shopIdParam) {
          preselected = await getShopById(shopIdParam);
        } else if (slugParam) {
          preselected = await getShopBySlug(slugParam);
        }

        setShops(allShops);

        if (preselected) {
          setSelectedShopId(preselected.id);
        } else if (allShops.length > 0) {
          // Seleciona o primeiro por padrÃ£o
          setSelectedShopId(allShops[0].shop.id);
        }
      } catch (err: any) {
        if (err.status !== 0 && !cancelled) {
          console.error("Erro ao carregar lojas:", err);
          setError("NÃ£o foi possÃ­vel carregar as unidades disponÃ­veis.");
        }
      } finally {
        if (!cancelled) setLoadingShops(false);
      }
    }

    if (mode === "client") {
        load();
    }

    return () => {
      cancelled = true;
    };
  }, [searchParams, mode]);

  // Helper para pegar o objeto da loja selecionada
  const selectedShopData = useMemo(
    () => shops.find((s) => s.shop.id === selectedShopId) ?? null,
    [shops, selectedShopId]
  );

  /* ============================================================
      ValidaÃ§Ãµes Frontend
  ============================================================ */
  function validateCommon(): string | null {
    if (!name.trim()) return "Informe o nome.";
    if (!email.trim()) return "Informe o e-mail.";
    if (!password) return "Informe a senha.";
    if (password.length < 8) return "A senha deve ter pelo menos 8 caracteres.";
    if (password !== passwordConfirm) return "As senhas nÃ£o conferem.";
    return null;
  }

  function validateClient(): string | null {
    if (!selectedShopId) return "Selecione uma unidade para se vincular.";
    if (!selectedShopData) return "Unidade selecionada invÃ¡lida.";
    return null;
  }

  /* ============================================================
      SUBMIT PRINCIPAL
  ============================================================ */
  async function handleSubmit(e: FormEvent) {
    e.preventDefault();
    setError(null);

    // 1. ValidaÃ§Ã£o bÃ¡sica
    const baseError = validateCommon();
    if (baseError) return setError(baseError);

    if (mode === "client") {
      const extra = validateClient();
      if (extra) return setError(extra);
    }

    setSubmitting(true);

    try {
      /* ------------------- CASO: DONO ------------------- */
      if (mode === "owner") {
        await registerOwner({
          name: name.trim(),
          email: email.trim(),
          password,
          phone: phone.trim() || undefined,
        });

        // Login automÃ¡tico e redirecionamento
        await login(email.trim(), password);
        await reloadTenants();
        navigate("/onboarding", { replace: true });
        return;
      }

      /* ------------------- CASO: CLIENTE ------------------- */
      if (!selectedShopData) throw new Error("Dados de unidade invÃ¡lidos.");

      const { shop, company } = selectedShopData;

      // Chama API unificada que cria OU vincula se jÃ¡ existir (e senha bater)
      await registerClient({
        name: name.trim(),
        email: email.trim(),
        password,
        phone: phone.trim() || undefined,
        companyId: shop.company_id, // ou company.id
        shopId: shop.id,
      });

      // Login automÃ¡tico
      await login(email.trim(), password);
      
      // Redireciona para a pÃ¡gina de agendamento da loja
      navigate(`/book/${shop.slug}`, { replace: true });

    } catch (err: any) {
      console.error("Erro no registro:", err);

      let errorMsg = "NÃ£o foi possÃ­vel concluir o cadastro.";

      // Tratamento de erros do PocketBase
      if (err.data && typeof err.data === 'object') {
        const fieldKeys = Object.keys(err.data);
        if (fieldKeys.length > 0) {
          const field = fieldKeys[0];
          const msg = err.data[field]?.message;
          if (msg) errorMsg = `${field}: ${msg}`; // ex: "password: Must be at least 8 characters"
        }
      } 
      // Tratamento para nosso erro customizado de senha errada no login automÃ¡tico
      else if (err.message && err.message.includes("senha informada estÃ¡ incorreta")) {
         errorMsg = err.message;
      }
      else if (err.message) {
         // Erros genÃ©ricos
         errorMsg = err.message;
      }

      // Ignora erro se for abortamento de request
      if (err.status === 0 || err.isAbort) return;

      setError(errorMsg);
      setSubmitting(false);
    }
  }

  /* ============================================================
      RENDER
  ============================================================ */
  return (
    <div className="min-h-screen bg-slate-950 text-slate-50 flex items-center justify-center px-4 py-10 relative">

      {/* Fundo decorativo */}
      <div className="absolute inset-0 -z-10 overflow-hidden">
        <div className="absolute -left-24 -top-24 w-80 h-80 bg-emerald-500/25 blur-3xl rounded-full" />
        <div className="absolute -right-24 bottom-[-40px] w-96 h-96 bg-sky-500/25 blur-3xl rounded-full" />
      </div>

      <div className="w-full max-w-4xl mx-auto grid md:grid-cols-[1.2fr,1fr] gap-8 items-center">

        {/* Lado esquerdo: Texto Marketing */}
        <div className="space-y-4">
          <p className="text-xs tracking-[0.18em] uppercase text-emerald-300/80">
            TeaAgendei â€¢ Plataforma SaaS
          </p>
          <h1 className="text-3xl md:text-4xl font-semibold leading-tight">
            Crie seu acesso e
            <span className="text-emerald-400"> comece a organizar</span> seus agendamentos hoje.
          </h1>

          <p className="text-sm md:text-base text-slate-300 max-w-lg">
            Donos gerenciam unidades e equipe. Clientes agendam em poucos cliques.
          </p>

          <ul className="mt-4 space-y-2 text-sm text-slate-300">
            <li>â€¢ Simples e RÃ¡pido.</li>
            <li>â€¢ HistÃ³rico de agendamentos.</li>
            <li>â€¢ Agenda inteligente e antifuro.</li>
          </ul>
        </div>

        {/* Lado direito: FormulÃ¡rio */}
        <div className="rounded-3xl border border-white/10 bg-slate-900/80 backdrop-blur-2xl shadow-2xl p-6 md:p-7 space-y-6">

          {/* Header do Card */}
          <div className="flex items-center justify-between gap-3">
            <div className="flex items-center gap-2">
              <div className="h-9 w-9 rounded-2xl bg-emerald-500 flex items-center justify-center text-slate-950 font-black text-lg">
                T
              </div>
              <div className="flex flex-col">
                <span className="text-[11px] text-slate-400">Cadastro de acesso</span>
                <span className="text-sm font-medium text-slate-50">TeaAgendei</span>
              </div>
            </div>
          </div>

          {/* Toggle Dono vs Cliente */}
          <div className="inline-flex rounded-2xl bg-slate-950/60 border border-white/10 p-1 text-xs w-full">
            <button
              type="button"
              onClick={() => setMode("owner")}
              className={`flex-1 px-4 py-2 rounded-xl transition text-center ${
                mode === "owner"
                  ? "bg-emerald-500 text-slate-950 font-semibold shadow-sm shadow-emerald-500/40"
                  : "text-slate-300 hover:bg-slate-800/60"
              }`}
            >
              Sou dono do negÃ³cio
            </button>
            <button
              type="button"
              onClick={() => setMode("client")}
              className={`flex-1 px-4 py-2 rounded-xl transition text-center ${
                mode === "client"
                  ? "bg-sky-500 text-slate-950 font-semibold shadow-sm shadow-sky-500/40"
                  : "text-slate-300 hover:bg-slate-800/60"
              }`}
            >
              Sou cliente
            </button>
          </div>

          {/* FormulÃ¡rio */}
          <form className="space-y-4" onSubmit={handleSubmit}>

            {/* Nome */}
            <div className="space-y-1.5">
              <label className="block text-xs font-medium text-slate-200">Nome completo</label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2.5 text-sm text-slate-50 placeholder-slate-500
                focus:outline-none focus:ring-2 focus:ring-emerald-400/80 focus:border-emerald-400/80"
                placeholder={mode === "owner" ? "Ex.: JoÃ£o da Barbearia Central" : "Ex.: Maria Souza"}
              />
            </div>

            {/* Email */}
            <div className="space-y-1.5">
              <label className="block text-xs font-medium text-slate-200">E-mail</label>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2.5 text-sm text-slate-50
                placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-400/80"
                placeholder="voce@seuemail.com"
              />
            </div>

            {/* Telefone */}
            <div className="space-y-1.5">
              <label className="block text-xs font-medium text-slate-200">WhatsApp (opcional)</label>
              <input
                type="tel"
                value={phone}
                onChange={(e) => setPhone(e.target.value)}
                className="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2.5 text-sm text-slate-50
                placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-400/80"
                placeholder="(00) 90000-0000"
              />
            </div>

            {/* Senhas */}
            <div className="grid grid-cols-2 gap-3">
              <div className="space-y-1.5">
                <label className="block text-xs font-medium text-slate-200">Senha</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2.5 text-sm text-slate-50 placeholder-slate-500
                  focus:outline-none focus:ring-2 focus:ring-emerald-400/80"
                  placeholder="Min. 8 carac."
                />
              </div>
              <div className="space-y-1.5">
                <label className="block text-xs font-medium text-slate-200">Confirmar</label>
                <input
                  type="password"
                  value={passwordConfirm}
                  onChange={(e) => setPasswordConfirm(e.target.value)}
                  className="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2.5 text-sm text-slate-50 placeholder-slate-500
                  focus:outline-none focus:ring-2 focus:ring-emerald-400/80"
                  placeholder="Repita a senha"
                />
              </div>
            </div>

            {/* CLIENTE: SeleÃ§Ã£o de Unidade */}
            {mode === "client" && (
              <div className="space-y-1.5 pt-2 border-t border-white/5">
                <label className="block text-xs font-medium text-slate-200">
                  Selecione a unidade onde vocÃª serÃ¡ atendido
                </label>

                {loadingShops ? (
                  <div className="text-xs text-slate-400 py-2">Carregando unidades...</div>
                ) : shops.length === 0 ? (
                  <div className="text-xs text-slate-400 py-2">Nenhuma unidade disponÃ­vel no momento.</div>
                ) : (
                  <select
                    value={selectedShopId}
                    onChange={(e) => setSelectedShopId(e.target.value)}
                    className="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2.5 text-sm text-slate-50
                    focus:outline-none focus:ring-2 focus:ring-sky-400/80"
                  >
                    {shops.map(({ shop, company }) => (
                      <option key={shop.id} value={shop.id}>
                        {company?.legal_name || company?.fantasy_name || "Empresa"} â€¢ {shop.name}
                      </option>
                    ))}
                  </select>
                )}
              </div>
            )}

            {/* Mensagem de Erro */}
            {error && (
              <div className="rounded-2xl border border-red-500/60 bg-red-500/10 px-3 py-2 text-xs text-red-100 break-words">
                {error}
              </div>
            )}

            {/* BotÃ£o Submit */}
            <button
              type="submit"
              disabled={submitting || (mode === "client" && loadingShops)}
              className="w-full inline-flex items-center justify-center gap-2 rounded-2xl bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold text-sm py-2.5 transition
              shadow-lg shadow-emerald-500/40 disabled:opacity-50 disabled:cursor-not-allowed mt-2"
            >
              {submitting
                ? "Criando acesso..."
                : mode === "owner"
                ? "Criar acesso de dono"
                : "Criar acesso de cliente"}
            </button>

            {/* Link para Login */}
            <p className="text-[11px] text-center text-slate-400">
              JÃ¡ tem acesso?{" "}
              <a href="/login" className="text-emerald-300 hover:text-emerald-200 transition">
                Entrar no TeaAgendei
              </a>
            </p>
          </form>
        </div>
      </div>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\pages\auth\RegisterPage.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\booking\BookPage.tsx ---
Path: src\react-app\pages\booking\BookPage.tsx
------------------------------
import { useEffect, useState } from "react";
import { useParams } from "react-router-dom";
import { getShopBySlug } from "../../lib/api/register"; 
import StepService from "../../components/booking/StepService";
import StepProfessional from "../../components/booking/StepProfessional";
import StepDateTime from "../../components/booking/StepDateTime";
import StepConfirm from "../../components/booking/StepConfirm";
import { Service, User, TimeSlot } from "@/shared/types";

export default function BookPage() {
  const { slug } = useParams();
  
  // Dados da Loja
  const [shop, setShop] = useState<any>(null); // any para aceitar o expand sem erros de tipagem estrita
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Estado do Wizard (Passo a passo)
  const [step, setStep] = useState(1);
  const [selectedService, setSelectedService] = useState<Service | null>(null);
  const [selectedProfessional, setSelectedProfessional] = useState<User | null>(null);
  const [selectedTime, setSelectedTime] = useState<TimeSlot | null>(null);

  // Carrega dados da loja pelo Slug
  useEffect(() => {
    let isMounted = true;

    async function load() {
      if (!slug) return;
      setLoading(true);
      setError(null);

      try {
        const data = await getShopBySlug(slug);
        
        if (!isMounted) return;

        if (!data) {
          setError("Unidade nÃ£o encontrada ou link invÃ¡lido.");
        } else {
          setShop(data);
        }
      } catch (err: any) {
        if (!isMounted) return;
        // Ignora erro de auto-cancelamento
        if (err.status === 0 || err.isAbort) return;

        console.error("Erro ao carregar loja:", err);
        setError("NÃ£o foi possÃ­vel carregar os dados da unidade.");
      } finally {
        if (isMounted) setLoading(false);
      }
    }

    load();

    return () => {
      isMounted = false;
    };
  }, [slug]);

  // --- NAVEGAÃ‡ÃƒO DO WIZARD ---

  const handleServiceSelect = (service: Service) => {
    setSelectedService(service);
    setStep(2);
  };

  const handleProfessionalSelect = (prof: User | null) => {
    setSelectedProfessional(prof);
    setStep(3);
  };

  const handleTimeSelect = (slot: TimeSlot) => {
    setSelectedTime(slot);
    setStep(4);
  };

  const handleBack = () => {
    if (step > 1) setStep(step - 1);
  };

  // --- RENDER ---

  if (loading) {
    return (
      <div className="min-h-screen bg-slate-950 flex items-center justify-center">
        <div className="animate-spin h-8 w-8 border-4 border-emerald-500 border-t-transparent rounded-full"></div>
      </div>
    );
  }

  if (error || !shop) {
    return (
      <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center text-slate-400 p-4">
        <div className="text-4xl mb-4">ğŸ˜•</div>
        <p>{error || "Loja nÃ£o encontrada."}</p>
        <a href="/login" className="mt-4 text-emerald-400 hover:underline">Voltar ao inÃ­cio</a>
      </div>
    );
  }

  // Nome da empresa vindo do expand ou fallback
  const companyName = shop.expand?.company_id?.fantasy_name || shop.expand?.company_id?.legal_name || "Empresa";

  return (
    <div className="min-h-screen bg-slate-950 text-slate-50 flex flex-col">
      
      {/* Header Simples */}
      <header className="h-16 border-b border-white/5 flex items-center justify-between px-4 md:px-8 bg-slate-900/50 backdrop-blur-md sticky top-0 z-10">
        <div>
          <h1 className="text-sm font-bold text-white">{shop.name}</h1>
          <p className="text-[10px] text-slate-400 uppercase tracking-wider">{companyName}</p>
        </div>
        <div className="text-xs text-slate-500">
          Passo {step} de 4
        </div>
      </header>

      {/* ConteÃºdo do Passo */}
      <main className="flex-1 w-full max-w-lg mx-auto p-4 md:py-8">
        
        {step === 1 && (
          <StepService 
            shopId={shop.id} 
            onSelect={handleServiceSelect} 
          />
        )}

        {step === 2 && selectedService && (
          <StepProfessional 
            shopId={shop.id}
            serviceName={selectedService.name} 
            onSelect={handleProfessionalSelect}
            onBack={handleBack}
          />
        )}

        {step === 3 && selectedService && (
          <StepDateTime 
            shop={shop}
            service={selectedService}
            professional={selectedProfessional}
            onSelect={handleTimeSelect}
            onBack={handleBack}
          />
        )}

        {step === 4 && selectedService && selectedTime && (
          <StepConfirm 
            shop={shop}
            service={selectedService}
            professional={selectedProfessional}
            timeSlot={selectedTime}
            onBack={handleBack}
          />
        )}

      </main>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\pages\booking\BookPage.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\client\ClientPanelPage.tsx ---
Path: src\react-app\pages\client\ClientPanelPage.tsx
------------------------------
import { useEffect, useState } from "react";
import { Link } from "react-router-dom";
import { useAuth } from "@/react-app/contexts/AuthContext";
// Importamos getShopById para pegar o slug da loja do cliente
import { getShopById } from "@/react-app/lib/api/register";
import { getMyAppointments, cancelMyAppointment } from "@/react-app/lib/api/client";
import { Appointment, AppointmentStatus } from "@/shared/types";

// Helpers visuais
const getStatusLabel = (status: string) => {
  switch (status) {
    case AppointmentStatus.Pending: return { text: "Pendente", color: "bg-yellow-500/20 text-yellow-400" };
    case AppointmentStatus.Confirmed: return { text: "Confirmado", color: "bg-sky-500/20 text-sky-400" };
    case AppointmentStatus.InProgress: return { text: "Em Andamento", color: "bg-purple-500/20 text-purple-400" };
    case AppointmentStatus.Completed: return { text: "ConcluÃ­do", color: "bg-emerald-500/20 text-emerald-400" };
    case AppointmentStatus.Cancelled: return { text: "Cancelado", color: "bg-red-500/20 text-red-400" };
    case AppointmentStatus.Blocked: return { text: "Bloqueio", color: "bg-red-500/20 text-red-400" };
    default: return { text: "Outro", color: "bg-slate-700 text-slate-300" };
  }
};

// CORREÃ‡ÃƒO: Utiliza o construtor Date padrÃ£o para converter UTC (do banco) para Hora Local do navegador
const formatDate = (iso: string) => {
  if (!iso) return "--";
  
  // O navegador lÃª o "Z" no final da string do PocketBase e converte para o fuso local automaticamente
  const date = new Date(iso);

  const day = String(date.getDate()).padStart(2, '0');
  const month = date.toLocaleString('pt-BR', { month: 'long' });
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  
  return `${day} de ${month} de ${year} Ã s ${hours}:${minutes}`;
};

export default function ClientPanelPage() {
  const { user } = useAuth();
  const [appointments, setAppointments] = useState<Appointment[]>([]);
  const [loading, setLoading] = useState(true);
  const [bookingSlug, setBookingSlug] = useState("");

  useEffect(() => {
    let isMounted = true;
    async function loadData() {
      if (!user) return;
      setLoading(true);
      try {
        const data = await getMyAppointments(user.id);
        if (isMounted) {
          setAppointments(data);
          
          if (user.shop_id) {
             getShopById(user.shop_id).then(shop => {
                 if (isMounted && shop) setBookingSlug(shop.slug);
             }).catch(() => {});
          } else if (data.length > 0) {
             const lastShop = data[0].expand?.shop_id;
             if (lastShop?.slug) setBookingSlug(lastShop.slug);
          }
        }
      } catch (err: any) {
        if (err.status !== 0) console.error(err);
      } finally {
        if (isMounted) setLoading(false);
      }
    }
    loadData();
    return () => { isMounted = false; };
  }, [user?.id, user?.shop_id]);

  async function handleCancel(id: string) {
    if (!confirm("Tem certeza que deseja cancelar este agendamento?")) return;
    try {
      await cancelMyAppointment(id);
      setAppointments(prev => prev.map(appt => 
        appt.id === id ? { ...appt, status: AppointmentStatus.Cancelled } : appt
      ));
    } catch (error) {
      alert("Erro ao cancelar.");
    }
  }

  const now = new Date();
  
  // Filtra agendamentos futuros e passados
  const upcoming = appointments.filter(a => new Date(a.start_time) >= now && a.status !== AppointmentStatus.Cancelled);
  const history = appointments.filter(a => new Date(a.start_time) < now || a.status === AppointmentStatus.Cancelled);

  if (loading) {
    return <div className="min-h-screen bg-slate-950 flex items-center justify-center text-slate-500">Carregando...</div>;
  }

  const newBookingLink = bookingSlug ? `/book/${bookingSlug}` : "/";

  return (
    <div className="min-h-screen bg-slate-950 text-slate-50 p-6">
      <div className="max-w-3xl mx-auto space-y-8">
        
        <div className="flex justify-between items-end">
          <div>
            <h1 className="text-2xl font-bold text-white">Meus Agendamentos</h1>
            <p className="text-sm text-slate-400">Gerencie seus horÃ¡rios marcados.</p>
          </div>
          <Link to={newBookingLink} className="text-xs bg-emerald-500/10 text-emerald-400 px-4 py-2 rounded-xl hover:bg-emerald-500/20 transition border border-emerald-500/20">
            Novo Agendamento
          </Link>
        </div>

        {/* PRÃ“XIMOS */}
        <section>
          <h2 className="text-lg font-semibold text-white mb-4 border-l-4 border-emerald-500 pl-3">PrÃ³ximos</h2>
          {upcoming.length === 0 ? (
            <div className="bg-slate-900/50 border border-white/5 rounded-2xl p-8 text-center text-slate-500 text-sm">
              VocÃª nÃ£o tem agendamentos futuros.
            </div>
          ) : (
            <div className="space-y-4">
              {upcoming.map((appt: any) => {
                const shopName = appt.expand?.shop_id?.name || "Loja";
                const serviceName = appt.expand?.service_id?.name || "ServiÃ§o";
                const barberName = appt.expand?.barber_id?.name || "Profissional";
                const { text, color } = getStatusLabel(appt.status);

                // LÃ³gica de Cancelamento (AntecedÃªncia)
                const startTime = new Date(appt.start_time);
                // Pega o tempo mÃ­nimo da loja (ou padrÃ£o 120 min / 2 horas)
                const minAdvanceMinutes = appt.expand?.shop_id?.min_advance_time || 120; 
                const diffMs = startTime.getTime() - now.getTime();
                const canCancel = diffMs > (minAdvanceMinutes * 60 * 1000);

                const isCancellableStatus = appt.status === AppointmentStatus.Pending || appt.status === AppointmentStatus.Confirmed;

                return (
                  <div key={appt.id} className="bg-slate-900 border border-white/10 rounded-2xl p-5 flex flex-col sm:flex-row justify-between gap-4 transition hover:border-emerald-500/30">
                    <div>
                      <div className="flex items-center gap-3 mb-2">
                        <span className={`text-[10px] uppercase font-bold px-2 py-0.5 rounded ${color}`}>
                          {text}
                        </span>
                        <span className="text-xs text-slate-400 font-mono">
                          {formatDate(appt.start_time)}
                        </span>
                      </div>
                      <h3 className="text-lg font-semibold text-white">{serviceName}</h3>
                      <p className="text-sm text-slate-400">{shopName} â€¢ com {barberName}</p>
                    </div>

                    <div className="flex items-center">
                      {isCancellableStatus && (
                        canCancel ? (
                            <button 
                              onClick={() => handleCancel(appt.id)}
                              className="text-xs text-red-400 hover:text-red-300 border border-red-500/20 px-4 py-2 rounded-xl hover:bg-red-500/10 transition w-full sm:w-auto"
                            >
                              Cancelar
                            </button>
                        ) : (
                            <span className="text-[10px] text-slate-500 italic bg-slate-800 px-2 py-1 rounded border border-white/5">
                                Cancelamento indisponÃ­vel<br/>(AntecedÃªncia mÃ­nima: {minAdvanceMinutes/60}h)
                            </span>
                        )
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </section>

        {/* HISTÃ“RICO */}
        <section>
          <h2 className="text-lg font-semibold text-white mb-4 border-l-4 border-slate-600 pl-3">HistÃ³rico</h2>
          <div className="space-y-3 opacity-75">
            {history.map((appt: any) => {
               const shopName = appt.expand?.shop_id?.name;
               const serviceName = appt.expand?.service_id?.name;
               const { text, color } = getStatusLabel(appt.status);

               return (
                 <div key={appt.id} className="bg-slate-900/30 border border-white/5 rounded-xl p-4 flex justify-between items-center">
                    <div>
                       <p className="text-sm font-medium text-slate-300">{serviceName}</p>
                       <p className="text-xs text-slate-500">{shopName} â€¢ {formatDate(appt.start_time)}</p>
                    </div>
                    <span className={`text-[10px] px-2 py-1 rounded ${color}`}>{text}</span>
                 </div>
               );
            })}
            {history.length === 0 && (
                <p className="text-xs text-slate-600">Nenhum histÃ³rico disponÃ­vel.</p>
            )}
          </div>
        </section>

      </div>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\pages\client\ClientPanelPage.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\dashboard\DashboardHome.tsx ---
Path: src\react-app\pages\dashboard\DashboardHome.tsx
------------------------------
// src/react-app/pages/dashboard/DashboardHome.tsx

import { useEffect, useState } from "react";
import { useAuth } from "@/react-app/contexts/AuthContext";
import { 
  getDailyBookings, 
  type DailyBooking 
} from "@/react-app/lib/api/dashboard";
import { Calendar, DollarSign, Users, Clock, ChevronLeft, ChevronRight, Ban } from "lucide-react";

export default function DashboardHome() {
  const { user } = useAuth();
  
  // Estado de Data (PadrÃ£o:  Hoje)
  const [selectedDate, setSelectedDate] = useState(() => {
    return new Date().toISOString().split("T")[0];
  });

  const [bookings, setBookings] = useState<DailyBooking[]>([]);
  const [stats, setStats] = useState({ revenue: 0, count: 0 });
  const [loading, setLoading] = useState(true);
  const [dateCache, setDateCache] = useState<Record<string, DailyBooking[]>>({}); // âœ… NOVO:  Cache

  // Carrega dados sempre que a data ou loja mudar
  useEffect(() => {
    async function loadDashboard() {
      if (!user?. shop_id) return;
      
      // âœ… NOVO: Verifica cache primeiro
      if (dateCache[selectedDate]) {
        const cached = dateCache[selectedDate];
        const activeBookings = cached.filter(b => b.raw_status !== "6");
        setBookings(cached);
        setStats({
          revenue: activeBookings.reduce((acc, b) => acc + b.value, 0),
          count: activeBookings.length
        });
        return;
      }
      
      setLoading(true);
      try {
        const dataBookings = await getDailyBookings(user.shop_id, selectedDate);

        // âœ… NOVO: Armazena no cache
        setDateCache(prev => ({ ...prev, [selectedDate]: dataBookings }));

        // CORREÃ‡ÃƒO: Filtra BLOQUEIOS (Status 6) dos cÃ¡lculos de KPI
        const activeBookings = dataBookings.filter(b => b.raw_status !== "6");

        const totalRevenue = activeBookings.reduce((acc, curr) => acc + curr.value, 0);
        const totalCount = activeBookings.length;

        setBookings(dataBookings); // A lista mostra tudo (inclusive bloqueios)
        setStats({
          revenue: totalRevenue, // KPIs mostram apenas agendamentos reais
          count: totalCount
        });
      } catch (error:  any) {
        if (error.status !== 0) {
            console.error("Erro ao carregar dashboard", error);
        }
      } finally {
        setLoading(false);
      }
    }

    loadDashboard();
  }, [user?.shop_id, selectedDate]);

  // Controles de Data
  const handlePrevDay = () => {
    const date = new Date(selectedDate + "T00:00:00");
    date.setDate(date.getDate() - 1);
    setSelectedDate(date.toISOString().split('T')[0]);
  };

  const handleNextDay = () => {
    const date = new Date(selectedDate + "T00:00:00");
    date.setDate(date.getDate() + 1);
    setSelectedDate(date.toISOString().split('T')[0]);
  };

  const formatMoney = (val: number) => 
    new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(val);

  const displayDate = new Date(selectedDate + "T00:00:00").toLocaleDateString("pt-BR", {
    weekday: 'long', day: 'numeric', month: 'long'
  });

  // âœ… NOVO: Helper para exibir bloqueios
  const getBlockDisplay = (appointment: any) => {
    if (appointment.raw_status !== "6") return null;

    const startTime = new Date(appointment.start_time).toLocaleTimeString("pt-BR", {
      hour: "2-digit",
      minute: "2-digit"
    });

    const endTime = new Date(
      new Date(appointment.start_time).getTime() + 
      (appointment.duration_minutes || 30) * 60 * 1000
    ).toLocaleTimeString("pt-BR", {
      hour: "2-digit",
      minute: "2-digit"
    });

    return { startTime, endTime };
  };

  if (loading) {
    return (
        <div className="flex items-center justify-center min-h-[400px]">
            <div className="text-slate-500 animate-pulse">Carregando indicadores...</div>
        </div>
    );
  }

  return (
    <div className="space-y-8 pb-10">
      {/* HEADER COM SELETOR DE DATA */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h1 className="text-2xl font-bold text-white mb-1">VisÃ£o Geral</h1>
            <p className="text-slate-400 capitalize">{displayDate}</p>
        </div>

        <div className="flex items-center gap-2 bg-slate-900 p-1. 5 rounded-xl border border-slate-800 shadow-sm">
            <button onClick={handlePrevDay} className="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition">
                <ChevronLeft size={20} />
            </button>
            <div className="px-2 text-center">
                <span className="block text-xs text-slate-500 uppercase font-bold tracking-wider">Data</span>
                <input 
                    type="date"
                    value={selectedDate}
                    onChange={(e) => setSelectedDate(e.target. value)}
                    className="bg-transparent border-none text-white text-sm font-medium focus:ring-0 cursor-pointer p-0 w-24 text-center [&::-webkit-calendar-picker-indicator]:hidden"
                />
            </div>
            <button onClick={handleNextDay} className="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition">
                <ChevronRight size={20} />
            </button>
        </div>
      </div>

      {/* CARDS DE KPI */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl flex items-center gap-4 hover:border-emerald-500/30 transition">
          <div className="p-3 bg-emerald-500/10 rounded-xl text-emerald-500">
            <DollarSign size={24} />
          </div>
          <div>
            <p className="text-sm text-slate-400 font-medium">Faturamento</p>
            <p className="text-2xl font-bold text-white">{formatMoney(stats.revenue)}</p>
          </div>
        </div>

        <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl flex items-center gap-4 hover:border-blue-500/30 transition">
          <div className="p-3 bg-blue-500/10 rounded-xl text-blue-500">
            <Users size={24} />
          </div>
          <div>
            <p className="text-sm text-slate-400 font-medium">Agendamentos</p>
            <p className="text-2xl font-bold text-white">{stats.count}</p>
          </div>
        </div>

        <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl flex items-center gap-4 hover:border-purple-500/30 transition">
          <div className="p-3 bg-purple-500/10 rounded-xl text-purple-500">
            <Calendar size={24} />
          </div>
          <div>
            <p className="text-sm text-slate-400 font-medium">Ticket MÃ©dio</p>
            <p className="text-2xl font-bold text-white">
              {formatMoney(stats.count > 0 ? stats.revenue / stats.count : 0)}
            </p>
          </div>
        </div>
      </div>

      {/* TABELA DE AGENDAMENTOS */}
      <div className="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-xl shadow-black/20">
        <div className="p-6 border-b border-slate-800 flex justify-between items-center">
          <h2 className="font-bold text-white flex items-center gap-2">
            <Clock size={18} className="text-slate-400" /> Agenda do Dia
          </h2>
        </div>
        
        <div className="overflow-x-auto">
          <table className="w-full text-left text-sm text-slate-400">
            <thead className="bg-slate-950/50 text-slate-200 uppercase text-xs font-bold">
              <tr>
                <th className="px-6 py-4">HorÃ¡rio</th>
                <th className="px-6 py-4">Cliente / Tipo</th>
                <th className="px-6 py-4">ServiÃ§o / Nota</th>
                <th className="px-6 py-4">Profissional</th>
                <th className="px-6 py-4">Status</th>
                <th className="px-6 py-4 text-right">Valor</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-800">
              {bookings.length === 0 ? (
                <tr>
                  <td colSpan={6} className="px-6 py-12 text-center text-slate-500 flex flex-col items-center gap-2">
                    <Calendar size={32} className="opacity-20" />
                    <span>Nenhum agendamento encontrado para esta data. </span>
                  </td>
                </tr>
              ) : (
                bookings.map((booking) => {
                  const isBlock = booking.raw_status === "6";
                  const blockDisplay = isBlock ? getBlockDisplay(booking) : null; // âœ… NOVO
                  
                  return (
                    <tr key={booking. id} className={`transition cursor-default ${isBlock ? "bg-amber-950/20 hover:bg-amber-950/30" : "hover:bg-slate-800/50"}`}>
                      <td className="px-6 py-4 font-mono text-white">
                          {/* âœ… NOVO:   Mostrar intervalo de bloqueio */}
                          {isBlock && blockDisplay ?  (
                            <span className="text-amber-400 font-bold">
                              {blockDisplay.startTime} - {blockDisplay.endTime}
                            </span>
                          ) : (
                            booking.time
                          )}
                      </td>
                      <td className="px-6 py-4 font-medium text-slate-200">
                        {booking.client_name}
                        {! booking.client_id && ! isBlock && (
                          <span className="ml-2 text-[10px] bg-slate-700 text-slate-300 px-1. 5 py-0.5 rounded border border-white/10">Avulso</span>
                        )}
                      </td>
                      <td className="px-6 py-4 text-slate-400 flex items-center gap-2">
                        {isBlock && <Ban size={14} className="text-amber-400"/>}
                        {booking.service_name}
                      </td>
                      <td className="px-6 py-4 text-slate-400">{booking.professional_name}</td>
                      <td className="px-6 py-4">
                        <span className={`px-2 py-1 rounded text-[10px] uppercase font-bold tracking-wide border
                          ${booking.status === 'Confirmado' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' :  
                            booking.status === 'Pendente' ? 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20' :
                            booking.status === 'ConcluÃ­do' ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' :
                            booking.status === 'Em Andamento' ? 'bg-purple-500/10 text-purple-400 border-purple-500/20' :
                            booking.status === 'Bloqueio' ? 'bg-amber-500/10 text-amber-400 border-amber-500/20' :
                            'bg-slate-700 text-slate-300 border-slate-600'
                          }`}
                        >
                          {booking.status}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-right font-medium text-slate-200">
                        {isBlock ?  "â€”" : formatMoney(booking. value)}
                      </td>
                    </tr>
                  )
                })
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\pages\dashboard\DashboardHome.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\onboarding\CompanyStep.tsx ---
Path: src\react-app\pages\onboarding\CompanyStep.tsx
------------------------------
// Caminho: src/react-app/pages/onboarding/CompanyStep.tsx
import { FormEvent, useState } from "react";
import { useAuth } from "@/react-app/contexts/AuthContext";
import { useTenant } from "@/react-app/contexts/TenantContext";
import { onboardingCreateCompany } from "@/react-app/lib/api/onboarding";

type Props = {
  onDone: () => void;
};

export default function CompanyStep({ onDone }: Props) {
  const { user } = useAuth();
  const { reloadTenants } = useTenant();

  const [legalName, setLegalName] = useState("");
  const [cnpj, setCnpj] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  if (!user) {
    return (
      <div className="text-slate-200">
        VocÃª precisa estar autenticado para continuar.
      </div>
    );
  }

  // Remove formataÃ§Ã£o para enviar limpo
  const cleanCnpj = (value: string) => value.replace(/\D/g, "");

  async function handleSubmit(e: FormEvent) {
    e.preventDefault();
    setError(null);

    if (!user) {
      setError("SessÃ£o invÃ¡lida. FaÃ§a login novamente.");
      return;
    }

    if (!legalName.trim()) {
      setError("Informe o nome da sua empresa.");
      return;
    }

    const rawCnpj = cleanCnpj(cnpj);
    if (cnpj && rawCnpj.length !== 14) {
        setError("O CNPJ deve conter exatamente 14 nÃºmeros.");
        return;
    }

    setSubmitting(true);

    try {
      await onboardingCreateCompany({
        owner_id: user.id,
        legal_name: legalName.trim(),
        cnpj: rawCnpj || undefined, 
      });

      // Tenta recarregar. Se a navegaÃ§Ã£o for mais rÃ¡pida e cancelar isso,
      // o erro serÃ¡ capturado abaixo.
      await reloadTenants();
      
      onDone();
    } catch (err: any) {
      console.error(err);
      
      // CORREÃ‡ÃƒO: Ignora erro de cancelamento (status 0 ou isAbort)
      // Isso acontece porque navegamos para a prÃ³xima pÃ¡gina antes do reload terminar
      if (err.status === 0 || err.isAbort) {
        onDone(); // Segue o fluxo, pois o registro foi criado
        return;
      }

      if (err.data?.cnpj) {
         setError("CNPJ invÃ¡lido ou jÃ¡ cadastrado.");
      } else {
         setError(err?.message || "NÃ£o foi possÃ­vel criar a empresa.");
         // SÃ³ destrava o botÃ£o se for um erro real que impeÃ§a o avanÃ§o
         setSubmitting(false); 
      }
    }
  }

  return (
    <div className="max-w-lg space-y-6">
      <div>
        <h2 className="text-2xl font-semibold text-slate-50">
          Cadastre sua empresa
        </h2>
        <p className="text-sm text-slate-400 mt-1">
          Esses dados identificam o seu negÃ³cio dentro do TeaAgendei.
        </p>
      </div>

      <form className="space-y-4" onSubmit={handleSubmit}>
        <div className="space-y-1.5">
          <label className="block text-xs font-medium text-slate-200">
            Nome / RazÃ£o Social
          </label>
          <input
            type="text"
            value={legalName}
            onChange={(e) => setLegalName(e.target.value)}
            className="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2.5 text-sm text-slate-50 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-400/80 focus:border-emerald-400/80"
            placeholder="Ex.: Barbearia Central LTDA"
          />
        </div>

        <div className="space-y-1.5">
          <label className="block text-xs font-medium text-slate-200">
            CNPJ (opcional)
          </label>
          <input
            type="text"
            value={cnpj}
            onChange={(e) => setCnpj(e.target.value)}
            className="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2.5 text-sm text-slate-50 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-400/80 focus:border-emerald-400/80"
            placeholder="00.000.000/0000-00 (Apenas nÃºmeros se preferir)"
            maxLength={18}
          />
          <p className="text-[10px] text-slate-500">Digite apenas nÃºmeros ou use formataÃ§Ã£o padrÃ£o.</p>
        </div>

        {error && (
          <div className="rounded-2xl border border-red-500/60 bg-red-500/10 px-3 py-2 text-xs text-red-100">
            {error}
          </div>
        )}

        <button
          type="submit"
          disabled={submitting}
          className="inline-flex items-center justify-center gap-2 rounded-2xl bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold text-sm px-6 py-2.5 transition shadow-lg shadow-emerald-500/40 disabled:opacity-60 disabled:cursor-not-allowed"
        >
          {submitting ? "Salvando..." : "Continuar"}
        </button>
      </form>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\pages\onboarding\CompanyStep.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\onboarding\DoneStep.tsx ---
Path: src\react-app\pages\onboarding\DoneStep.tsx
------------------------------
// src/react-app/pages/onboarding/DoneStep.tsx
import { useNavigate } from "react-router-dom";

export default function DoneStep() {
  const navigate = useNavigate();

  function go() {
    navigate("/dashboard");
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-950 text-white px-6">
      <div className="bg-slate-900 border border-white/10 p-8 rounded-2xl max-w-md text-center space-y-4">
        <h1 className="text-2xl font-bold">Tudo pronto! ğŸ‰</h1>

        <p className="text-slate-300 text-sm">
          Sua empresa, unidade e perfil foram configurados.  
          VocÃª jÃ¡ pode comeÃ§ar a usar o TeaAgendei.
        </p>

        <button
          onClick={go}
          className="px-4 py-2 bg-emerald-500 hover:bg-emerald-400 rounded-xl text-black font-semibold mt-4"
        >
          Ir para o painel
        </button>
      </div>
    </div>
  );
}

--- FIM DO ARQUIVO: src\react-app\pages\onboarding\DoneStep.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\onboarding\OnboardingRouter.tsx ---
Path: src\react-app\pages\onboarding\OnboardingRouter.tsx
------------------------------
// Caminho: src/react-app/pages/onboarding/OnboardingRouter.tsx
import { useEffect } from "react";
import { Routes, Route, Navigate, useNavigate, useLocation } from "react-router-dom";
import CompanyStep from "./CompanyStep";
import ShopStep from "./ShopStep";
import OwnerProfessionalStep from "./OwnerProfessionalStep";
import DoneStep from "./DoneStep";
import { useAuth } from "@/react-app/contexts/AuthContext";
import { useTenant } from "@/react-app/contexts/TenantContext";

export default function OnboardingRouter() {
  const { user } = useAuth();
  const { currentCompany, currentShop } = useTenant();
  const navigate = useNavigate();
  const location = useLocation();

  // SeguranÃ§a extra (sÃ³ donos)
  if (!user || user.role !== "dono") {
    return <Navigate to="/login" replace />;
  }

  // LÃ³gica Inteligente de Redirecionamento
  // Verifica o progresso e redireciona se o usuÃ¡rio cair no passo errado
  useEffect(() => {
    // Se estou na raiz (CompanyStep) mas jÃ¡ tenho empresa -> vai para Shop
    if (location.pathname === "/onboarding" || location.pathname === "/onboarding/") {
      if (currentCompany && !currentShop) {
        navigate("shop", { replace: true });
      } else if (currentCompany && currentShop) {
        navigate("owner-pro", { replace: true });
      }
    }

    // Se estou no ShopStep mas jÃ¡ tenho Shop -> vai para OwnerPro
    if (location.pathname.includes("/shop")) {
      if (currentShop) {
        navigate("owner-pro", { replace: true });
      }
    }
  }, [currentCompany, currentShop, location.pathname, navigate]);

  return (
    <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4">
      {/* Fundo decorativo simples para o onboarding */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
         <div className="absolute -top-[20%] -left-[10%] w-[50%] h-[50%] bg-emerald-500/10 blur-[100px] rounded-full" />
      </div>
      
      <div className="relative z-10 w-full max-w-lg">
        <Routes>
          {/* Passo 1: Empresa -> Vai para /shop */}
          <Route 
            path="/" 
            element={<CompanyStep onDone={() => navigate("shop")} />} 
          />

          {/* Passo 2: Unidade -> Vai para /owner-pro */}
          <Route 
            path="/shop" 
            element={<ShopStep onDone={() => navigate("owner-pro")} />} 
          />

          {/* Passo 3: Perfil Profissional -> Vai para /done */}
          <Route 
            path="/owner-pro" 
            element={<OwnerProfessionalStep onDone={() => navigate("done")} />} 
          />

          {/* Passo Final: ConclusÃ£o */}
          <Route path="/done" element={<DoneStep />} />

          {/* Fallback */}
          <Route path="*" element={<Navigate to="/onboarding" replace />} />
        </Routes>
      </div>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\pages\onboarding\OnboardingRouter.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\onboarding\OwnerProfessionalStep.tsx ---
Path: src\react-app\pages\onboarding\OwnerProfessionalStep.tsx
------------------------------
// Caminho: src/react-app/pages/onboarding/OwnerProfessionalStep.tsx
import { FormEvent, useState } from "react";
// Removemos useNavigate se nÃ£o for usar, mas mantemos caso precise no futuro
import { useAuth } from "@/react-app/contexts/AuthContext";
import { useTenant } from "@/react-app/contexts/TenantContext";
import { onboardingCreateProfessional } from "@/react-app/lib/api/onboarding";

type Props = {
  onDone: () => void;
};

export default function OwnerProfessionalStep({ onDone }: Props) {
  const { user } = useAuth();
  const { currentShop, reloadTenants } = useTenant();
  
  const [isProfessional, setIsProfessional] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // VerificaÃ§Ã£o visual para o render (o usuÃ¡rio vÃª msg de erro se for null)
  if (!user || !currentShop) {
    return (
      <div className="p-6 text-slate-200 bg-red-900/20 rounded-xl border border-red-500/30">
        <p className="font-semibold text-red-200">AtenÃ§Ã£o</p>
        <p className="text-sm mt-1">
          NÃ£o foi possÃ­vel identificar a empresa ou unidade criada. 
          Tente recarregar a pÃ¡gina.
        </p>
      </div>
    );
  }

  async function handleSubmit(e: FormEvent) {
    e.preventDefault();
    setError(null);

    // CORREÃ‡ÃƒO DOS ERROS DE TYPESCRIPT AQUI:
    // Garantimos ao TS que user e currentShop existem antes de usar
    if (!user || !currentShop) {
      setError("Erro de sessÃ£o: UsuÃ¡rio ou Loja nÃ£o identificados.");
      return;
    }

    // Se o dono NÃƒO quiser ser profissional, apenas finalizamos
    if (!isProfessional) {
      onDone();
      return;
    }

    setSubmitting(true);

    try {
      // Agora o TS sabe que user.id e currentShop.id sÃ£o strings vÃ¡lidas
      await onboardingCreateProfessional({
        ownerId: user.id,
        shopId: currentShop.id,
      });

      // Atualiza contexto para refletir a mudanÃ§a (is_professional = true)
      await reloadTenants(); 

      onDone();
    } catch (err: any) {
      console.error(err);
      setError(
        err?.message || "Erro ao definir perfil de profissional. Tente novamente."
      );
    } finally {
      setSubmitting(false);
    }
  }

  return (
    <div className="max-w-lg space-y-6">
      <div>
        <h2 className="text-2xl font-semibold text-slate-50">
          VocÃª tambÃ©m atende clientes?
        </h2>
        <p className="text-sm text-slate-400 mt-1">
          Se vocÃª tambÃ©m corta cabelo, faz barba ou realiza serviÃ§os, 
          vamos ativar seu perfil de profissional nesta unidade.
        </p>
      </div>

      <form className="space-y-6" onSubmit={handleSubmit}>
        
        {/* Checkbox estilizado */}
        <label className="flex items-start gap-3 p-4 rounded-2xl border border-white/10 bg-slate-900/50 cursor-pointer hover:bg-slate-800/50 transition">
          <div className="pt-0.5">
            <input
              type="checkbox"
              checked={isProfessional}
              onChange={(e) => setIsProfessional(e.target.checked)}
              className="w-5 h-5 rounded border-white/20 bg-black/40 text-emerald-500 focus:ring-emerald-500 focus:ring-offset-0"
            />
          </div>
          <div className="space-y-1">
            <span className="block text-sm font-medium text-slate-200">
              Sim, eu sou um profissional
            </span>
            <span className="block text-xs text-slate-400">
              Serei listado na agenda e poderei receber agendamentos dos clientes.
            </span>
          </div>
        </label>

        {error && (
          <div className="rounded-2xl border border-red-500/60 bg-red-500/10 px-4 py-3 text-xs text-red-100">
            {error}
          </div>
        )}

        <button
          type="submit"
          disabled={submitting}
          className="w-full inline-flex items-center justify-center gap-2 rounded-2xl bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold text-sm py-3 transition shadow-lg shadow-emerald-500/40 disabled:opacity-60 disabled:cursor-not-allowed"
        >
          {submitting ? (
            "Salvando configuraÃ§Ãµes..."
          ) : (
            <>
              Concluir Onboarding
              <span className="text-lg">âŸ¶</span>
            </>
          )}
        </button>
      </form>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\pages\onboarding\OwnerProfessionalStep.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\onboarding\ShopStep.tsx ---
Path: src\react-app\pages\onboarding\ShopStep.tsx
------------------------------
// src/react-app/pages/onboarding/ShopStep.tsx
import { FormEvent, useEffect, useState } from "react";
import { useAuth } from "@/react-app/contexts/AuthContext";
import { useTenant } from "@/react-app/contexts/TenantContext";
import { createInitialShop } from "@/react-app/lib/api/onboarding";
import type { CreateShopDTO } from "@/shared/types";

type Props = {
  onDone: () => void;
};

export default function ShopStep({ onDone }: Props) {
  const { user } = useAuth();
  const { currentCompany, reloadTenants } = useTenant();

  const [name, setName] = useState("");
  const [slug, setSlug] = useState("");
  const [phone, setPhone] = useState("");
  const [address, setAddress] = useState("");

  // Removido segmentId temporariamente para evitar erro 400 (precisa ser um ID vÃ¡lido)

  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Gera slug automaticamente
  useEffect(() => {
    if (!slug && name) {
      const base = name
        .toLowerCase()
        .normalize("NFD")
        .replace(/\p{Diacritic}/gu, "")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
      setSlug(base);
    }
  }, [name]);

  // ProteÃ§Ã£o visual (Early return)
  if (!user || !currentCompany) {
    return (
      <div className="text-slate-200">
        Conclua primeiro o cadastro da empresa para continuar.
      </div>
    );
  }

  async function handleSubmit(e: FormEvent) {
    e.preventDefault();
    setError(null);

    // --- CORREÃ‡ÃƒO DO ERRO DE TYPESCRIPT AQUI ---
    // O TypeScript precisa garantir novamente que user e currentCompany nÃ£o sÃ£o nulos
    // dentro desta funÃ§Ã£o especÃ­fica.
    if (!user || !currentCompany) {
      setError("Erro de sessÃ£o. Recarregue a pÃ¡gina.");
      return;
    }

    if (!name.trim()) {
      setError("Informe o nome da unidade.");
      return;
    }
    if (!slug.trim()) {
      setError("Informe o slug da unidade.");
      return;
    }

    const payload: CreateShopDTO = {
      name: name.trim(),
      slug: slug.trim(),
      company_id: currentCompany.id,
      owner_id: user.id,
      phone: phone.trim() || undefined,
      address: address.trim() || undefined,
      segment_id: undefined,
    };

    setSubmitting(true);

    try {
      await createInitialShop(currentCompany.id, user.id, {
        name: payload.name,
        slug: payload.slug,
        phone: payload.phone,
        address: payload.address,
      });

      // Aguarda o reload
      await reloadTenants();

      // Chama o onDone que agora (no Router) faz o navigate
      onDone();
    } catch (err: any) {
      console.error("Erro ao criar Shop:", err);

      // Tratamento para cancelamento automÃ¡tico
      if (err.status === 0 || err.isAbort) {
        // Se cancelou, provavelmente funcionou o request mas o navegador abortou
        // Vamos forÃ§ar a ida para o prÃ³ximo passo
        onDone();
        return;
      }

      // Tratamento detalhado do erro 400
      let msg = "NÃ£o foi possÃ­vel criar a unidade.";

      if (err.data) {
        const keys = Object.keys(err.data);
        if (keys.length > 0) {
          const field = keys[0];
          const errorMsg = err.data[field]?.message;
          msg = `Erro no campo '${field}': ${errorMsg}`;
        }
      }

      if (err.data?.slug) {
        msg = "Este link (slug) jÃ¡ estÃ¡ em uso. Escolha outro.";
      }

      setError(msg);
      setSubmitting(false);
    }
  }

  return (
    <div className="max-w-lg space-y-6">
      <div>
        <h2 className="text-2xl font-semibold text-slate-50">
          Crie sua primeira unidade
        </h2>
        <p className="text-sm text-slate-400 mt-1">
          Essa unidade serÃ¡ usada para agendamentos e painel de controle.
        </p>
      </div>

      <form className="space-y-4" onSubmit={handleSubmit}>
        <div className="space-y-1.5">
          <label className="block text-xs font-medium text-slate-200">
            Nome da unidade
          </label>
          <input
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            className="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2.5 text-sm text-slate-50 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-400/80 focus:border-emerald-400/80"
            placeholder="Ex.: Unidade Centro"
          />
        </div>

        <div className="space-y-1.5">
          <label className="block text-xs font-medium text-slate-200">
            Slug (endereÃ§o pÃºblico)
          </label>
          <div className="flex items-center gap-2 px-3 py-2.5 rounded-2xl bg-black/40 border border-white/10 focus-within:ring-2 focus-within:ring-emerald-400/80">
            <span className="text-slate-500 text-sm">/book/</span>
            <input
              type="text"
              value={slug}
              onChange={(e) =>
                setSlug(e.target.value.toLowerCase().replace(/\s/g, "-"))
              }
              className="flex-1 bg-transparent text-sm text-emerald-400 font-medium placeholder-slate-600 focus:outline-none"
              placeholder="sua-unidade"
            />
          </div>
          <p className="text-[10px] text-slate-500">
            Link Ãºnico para seus clientes agendarem.
          </p>
        </div>

        <div className="space-y-1.5">
          <label className="block text-xs font-medium text-slate-200">
            Telefone / WhatsApp (opcional)
          </label>
          <input
            type="tel"
            value={phone}
            onChange={(e) => setPhone(e.target.value)}
            className="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2.5 text-sm text-slate-50 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-400/80 focus:border-emerald-400/80"
            placeholder="(00) 90000-0000"
          />
        </div>

        <div className="space-y-1.5">
          <label className="block text-xs font-medium text-slate-200">
            EndereÃ§o (opcional)
          </label>
          <input
            type="text"
            value={address}
            onChange={(e) => setAddress(e.target.value)}
            className="w-full rounded-2xl bg-black/40 border border-white/10 px-3 py-2.5 text-sm text-slate-50 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-400/80 focus:border-emerald-400/80"
            placeholder="Rua, nÃºmero, bairro, cidade"
          />
        </div>

        {error && (
          <div className="rounded-2xl border border-red-500/60 bg-red-500/10 px-3 py-2 text-xs text-red-100">
            {error}
          </div>
        )}

        <button
          type="submit"
          disabled={submitting}
          className="inline-flex items-center justify-center gap-2 rounded-2xl bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold text-sm px-6 py-2.5 transition shadow-lg shadow-emerald-500/40 disabled:opacity-60 disabled:cursor-not-allowed"
        >
          {submitting ? "Salvando unidade..." : "Continuar"}
        </button>
      </form>
    </div>
  );
}

--- FIM DO ARQUIVO: src\react-app\pages\onboarding\ShopStep.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\owner\FinancialPage.tsx ---
Path: src\react-app\pages\owner\FinancialPage.tsx
------------------------------
import { useEffect, useState } from "react";
import { useAuth } from "@/react-app/contexts/AuthContext";
import { getFinancialData, FinancialSummary } from "@/react-app/lib/api/financial";
import { DollarSign, TrendingUp, Calendar, CreditCard, AlertCircle } from "lucide-react";

export default function FinancialPage() {
  const { user } = useAuth();
  
  // PadrÃ£o: MÃªs e Ano atuais
  const [month, setMonth] = useState(new Date().getMonth() + 1);
  const [year, setYear] = useState(new Date().getFullYear());
  
  const [data, setData] = useState<FinancialSummary | null>(null);
  const [loading, setLoading] = useState(true);

  const formatMoney = (val: number) => 
    new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(val);

  useEffect(() => {
    async function load() {
      if (!user?.shop_id) return;
      setLoading(true);
      try {
        const result = await getFinancialData(user.shop_id, month, year);
        setData(result);
      } catch (error) {
        console.error("Erro financeiro", error);
      } finally {
        setLoading(false);
      }
    }
    load();
  }, [user?.shop_id, month, year]);

  return (
    <div className="space-y-8 pb-10">
      
      {/* HEADER E FILTROS */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
          <h1 className="text-3xl font-bold text-white mb-1">Gerenciamento Financeiro</h1>
          <p className="text-slate-400">Acompanhe o fluxo de caixa e previsÃµes.</p>
        </div>

        <div className="flex gap-2 bg-slate-900 p-1.5 rounded-xl border border-white/10 shadow-sm">
          <select 
            value={month} 
            onChange={e => setMonth(Number(e.target.value))}
            className="bg-slate-800 text-white border-none rounded-lg p-2 text-sm focus:ring-0 cursor-pointer outline-none"
          >
            {Array.from({ length: 12 }, (_, i) => (
              <option key={i + 1} value={i + 1}>
                {new Date(0, i).toLocaleString('pt-BR', { month: 'long' }).toUpperCase()}
              </option>
            ))}
          </select>
          <select 
            value={year} 
            onChange={e => setYear(Number(e.target.value))}
            className="bg-slate-800 text-white border-none rounded-lg p-2 text-sm focus:ring-0 cursor-pointer outline-none"
          >
            <option value={2024}>2024</option>
            <option value={2025}>2025</option>
            <option value={2026}>2026</option>
          </select>
        </div>
      </div>

      {loading || !data ? (
         <div className="h-64 flex items-center justify-center text-slate-500 animate-pulse">
            Carregando dados financeiros...
         </div>
      ) : (
        <>
          {/* CARDS KPI */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            {/* Realizado */}
            <div className="bg-slate-900 border border-emerald-500/30 p-6 rounded-2xl relative overflow-hidden group hover:border-emerald-500/50 transition">
                <div className="absolute -right-6 -top-6 text-emerald-500/5 group-hover:text-emerald-500/10 transition-all transform rotate-12">
                    <DollarSign size={150} />
                </div>
                <div className="flex items-center gap-3 mb-4">
                    <div className="p-2 bg-emerald-500/10 text-emerald-500 rounded-lg">
                        <DollarSign size={24} />
                    </div>
                    <span className="text-slate-400 font-bold uppercase text-xs tracking-wider">Receita Realizada</span>
                </div>
                <div className="text-3xl font-bold text-white mb-1">{formatMoney(data.totalRevenue)}</div>
                <div className="text-xs text-emerald-400 font-medium">
                    {data.countCompleted} atendimentos finalizados
                </div>
            </div>

            {/* Pendente/Futuro */}
            <div className="bg-slate-900 border border-yellow-500/30 p-6 rounded-2xl relative overflow-hidden group hover:border-yellow-500/50 transition">
                <div className="absolute -right-6 -top-6 text-yellow-500/5 group-hover:text-yellow-500/10 transition-all transform rotate-12">
                    <Calendar size={150} />
                </div>
                <div className="flex items-center gap-3 mb-4">
                    <div className="p-2 bg-yellow-500/10 text-yellow-500 rounded-lg">
                        <Calendar size={24} />
                    </div>
                    <span className="text-slate-400 font-bold uppercase text-xs tracking-wider">A Receber (PrevisÃ£o)</span>
                </div>
                <div className="text-3xl font-bold text-slate-200 mb-1">{formatMoney(data.totalPending)}</div>
                <div className="text-xs text-yellow-500 font-medium">
                    {data.countPending} agendamentos em aberto
                </div>
            </div>

            {/* Ticket MÃ©dio */}
            <div className="bg-slate-900 border border-indigo-500/30 p-6 rounded-2xl relative overflow-hidden group hover:border-indigo-500/50 transition">
                <div className="absolute -right-6 -top-6 text-indigo-500/5 group-hover:text-indigo-500/10 transition-all transform rotate-12">
                    <TrendingUp size={150} />
                </div>
                <div className="flex items-center gap-3 mb-4">
                    <div className="p-2 bg-indigo-500/10 text-indigo-500 rounded-lg">
                        <TrendingUp size={24} />
                    </div>
                    <span className="text-slate-400 font-bold uppercase text-xs tracking-wider">Ticket MÃ©dio</span>
                </div>
                <div className="text-3xl font-bold text-white mb-1">
                    {formatMoney(data.countCompleted > 0 ? data.totalRevenue / data.countCompleted : 0)}
                </div>
                <div className="text-xs text-indigo-400 font-medium">
                    MÃ©dia por cliente
                </div>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            {/* PAGAMENTOS (BARRA DE PROGRESSO) */}
            <div className="bg-slate-900 border border-slate-800 rounded-2xl p-6 shadow-xl">
                <h3 className="text-lg font-bold text-white mb-6 flex items-center gap-2">
                    <CreditCard size={20} className="text-slate-400"/> Receita por MÃ©todo
                </h3>
                
                <div className="space-y-5">
                    {Object.keys(data.byMethod).length === 0 ? (
                        <div className="text-center py-10 text-slate-500 bg-slate-950/50 rounded-xl border border-dashed border-slate-800">
                             <AlertCircle className="mx-auto mb-2 opacity-50" />
                             Nenhum pagamento concluÃ­do neste mÃªs.
                        </div>
                    ) : (
                        Object.entries(data.byMethod)
                            .sort(([, a], [, b]) => b - a)
                            .map(([method, value]) => {
                                const percent = (value / data.totalRevenue) * 100;
                                return (
                                    <div key={method}>
                                        <div className="flex justify-between text-sm mb-1.5">
                                            <span className="text-slate-300 font-medium">{method}</span>
                                            <span className="text-slate-200 font-mono">{formatMoney(value)} <span className="text-xs text-slate-500 ml-1">({percent.toFixed(0)}%)</span></span>
                                        </div>
                                        <div className="w-full bg-slate-950 rounded-full h-2.5 overflow-hidden border border-white/5">
                                            <div 
                                                className="bg-emerald-500 h-full rounded-full transition-all duration-1000 ease-out" 
                                                style={{ width: `${percent}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                )
                            })
                    )}
                </div>
            </div>

            {/* HISTÃ“RICO DIÃRIO */}
            <div className="bg-slate-900 border border-slate-800 rounded-2xl p-6 shadow-xl">
                <h3 className="text-lg font-bold text-white mb-6 flex items-center gap-2">
                     <Calendar size={20} className="text-slate-400"/> Detalhamento DiÃ¡rio
                </h3>
                <div className="h-[300px] overflow-y-auto pr-2 custom-scrollbar space-y-2">
                     {Object.keys(data.dailyData).length === 0 ? (
                        <div className="text-center py-10 text-slate-500 bg-slate-950/50 rounded-xl border border-dashed border-slate-800">
                            Sem movimentaÃ§Ãµes financeiras.
                        </div>
                     ) : (
                        Object.entries(data.dailyData)
                            .sort(([dateA], [dateB]) => dateB.localeCompare(dateA)) // Mais recente primeiro
                            .map(([day, value]) => {
                                const [y, m, d] = day.split("-");
                                const formattedDay = `${d}/${m}`;
                                return (
                                    <div key={day} className="flex items-center justify-between p-3 rounded-xl bg-slate-950/50 border border-white/5 hover:border-emerald-500/30 transition">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-slate-800 text-slate-300 px-2.5 py-1 rounded text-xs font-mono font-bold">
                                                {formattedDay}
                                            </div>
                                            <span className="text-sm text-slate-400">Total Faturado</span>
                                        </div>
                                        <span className="text-sm font-bold text-emerald-400 font-mono">{formatMoney(value)}</span>
                                    </div>
                                )
                            })
                     )}
                </div>
            </div>

          </div>
        </>
      )}
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\pages\owner\FinancialPage.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\owner\ServicesPage.tsx ---
Path: src\react-app\pages\owner\ServicesPage.tsx
------------------------------
import { useEffect, useState } from "react";
import { useTenant } from "@/react-app/contexts/TenantContext";
import { 
  getServicesByShop, createService, deleteService,
  getCategoriesByShop, createCategory, deleteCategory 
} from "@/react-app/lib/api/services";
import type { Service, Category } from "@/shared/types";
import Modal from "@/react-app/components/common/Modal";

type Tab = "services" | "categories";

export default function ServicesPage() {
  const { currentShop } = useTenant();
  const [activeTab, setActiveTab] = useState<Tab>("services");
  
  // Listas
  const [services, setServices] = useState<Service[]>([]);
  const [categories, setCategories] = useState<Category[]>([]);
  const [loading, setLoading] = useState(true);

  // Modais
  const [isServiceModalOpen, setServiceModalOpen] = useState(false);
  const [isCatModalOpen, setCatModalOpen] = useState(false);

  // Forms
  const [newServiceName, setNewServiceName] = useState("");
  const [newServicePrice, setNewServicePrice] = useState("");
  const [newServiceDuration, setNewServiceDuration] = useState("30");
  const [newServiceCategory, setNewServiceCategory] = useState("");
  
  const [newCatName, setNewCatName] = useState("");

  useEffect(() => {
    let isMounted = true;

    async function loadData() {
      if (!currentShop) return;
      setLoading(true);
      try {
        const [srv, cat] = await Promise.all([
          getServicesByShop(currentShop.id),
          getCategoriesByShop(currentShop.id)
        ]);
        
        if (isMounted) {
          setServices(srv);
          setCategories(cat);
        }
      } catch (err: any) {
        // CORREÃ‡ÃƒO: Ignora erro de auto-cancelamento (status 0)
        if (err.status === 0 || err.isAbort) return;
        console.error(err);
      } finally {
        if (isMounted) setLoading(false);
      }
    }

    loadData();

    return () => {
      isMounted = false;
    };
  }, [currentShop?.id]);

  // FunÃ§Ã£o auxiliar para recarregar apÃ³s aÃ§Ãµes (create/delete)
  async function reload() {
    if (!currentShop) return;
    setLoading(true);
    try {
        const [srv, cat] = await Promise.all([
            getServicesByShop(currentShop.id),
            getCategoriesByShop(currentShop.id)
        ]);
        setServices(srv);
        setCategories(cat);
    } catch(err: any) {
        console.error(err);
    } finally {
        setLoading(false);
    }
  }

  async function handleCreateService() {
    if (!currentShop) return;
    try {
      await createService({
        name: newServiceName,
        price: Number(newServicePrice.replace(",", ".")),
        duration: Number(newServiceDuration),
        category_id: newServiceCategory || null,
        shop_id: currentShop.id,
        is_active: true
      });
      setServiceModalOpen(false);
      setNewServiceName("");
      setNewServicePrice("");
      reload();
    } catch (err) {
      alert("Erro ao criar serviÃ§o");
    }
  }

  async function handleCreateCategory() {
    if (!currentShop) return;
    try {
      await createCategory(currentShop.id, newCatName);
      setCatModalOpen(false);
      setNewCatName("");
      reload();
    } catch (err) {
      alert("Erro ao criar categoria");
    }
  }

  async function handleDeleteService(id: string) {
    if (confirm("Desativar este serviÃ§o?")) {
      await deleteService(id);
      reload();
    }
  }

  async function handleDeleteCategory(id: string) {
    if (confirm("Apagar categoria?")) {
      await deleteCategory(id);
      reload();
    }
  }

  if (!currentShop) return <div>Selecione uma unidade.</div>;

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold text-white">CatÃ¡logo</h1>
        <button 
          onClick={() => activeTab === "services" ? setServiceModalOpen(true) : setCatModalOpen(true)}
          className="bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold px-4 py-2 rounded-xl transition"
        >
          + Novo {activeTab === "services" ? "ServiÃ§o" : "Categoria"}
        </button>
      </div>

      {/* Tabs */}
      <div className="flex gap-4 border-b border-white/10">
        <button 
          onClick={() => setActiveTab("services")}
          className={`pb-3 text-sm font-medium transition border-b-2 ${activeTab === "services" ? "border-emerald-500 text-emerald-400" : "border-transparent text-slate-400"}`}
        >
          ServiÃ§os
        </button>
        <button 
          onClick={() => setActiveTab("categories")}
          className={`pb-3 text-sm font-medium transition border-b-2 ${activeTab === "categories" ? "border-emerald-500 text-emerald-400" : "border-transparent text-slate-400"}`}
        >
          Categorias
        </button>
      </div>

      {loading ? <div className="text-slate-500">Carregando...</div> : (
        <div className="grid gap-4">
          
          {/* LISTA SERVIÃ‡OS */}
          {activeTab === "services" && services.map(service => (
            <div key={service.id} className="bg-slate-900 border border-white/5 p-4 rounded-xl flex justify-between items-center group hover:border-white/10 transition">
              <div>
                <h3 className="font-semibold text-slate-200">{service.name}</h3>
                <p className="text-xs text-slate-500">
                  {service.duration} min â€¢ {new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(service.price)}
                </p>
              </div>
              <button onClick={() => handleDeleteService(service.id)} className="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition px-2">
                Excluir
              </button>
            </div>
          ))}

          {/* LISTA CATEGORIAS */}
          {activeTab === "categories" && categories.map(cat => (
            <div key={cat.id} className="bg-slate-900 border border-white/5 p-4 rounded-xl flex justify-between items-center group">
              <span className="font-medium text-slate-300">{cat.name}</span>
              <button onClick={() => handleDeleteCategory(cat.id)} className="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition px-2">
                Excluir
              </button>
            </div>
          ))}
          
          {activeTab === "services" && services.length === 0 && <p className="text-slate-500 text-sm">Nenhum serviÃ§o cadastrado.</p>}
          {activeTab === "categories" && categories.length === 0 && <p className="text-slate-500 text-sm">Nenhuma categoria cadastrada.</p>}
        </div>
      )}

      {/* MODAL SERVIÃ‡O */}
      <Modal isOpen={isServiceModalOpen} onClose={() => setServiceModalOpen(false)} title="Novo ServiÃ§o">
        <div className="space-y-4">
          <div>
            <label className="block text-xs text-slate-400 mb-1">Nome</label>
            <input className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white" 
              value={newServiceName} onChange={e => setNewServiceName(e.target.value)} />
          </div>
          <div className="grid grid-cols-2 gap-4">
             <div>
                <label className="block text-xs text-slate-400 mb-1">PreÃ§o (R$)</label>
                <input type="number" className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white" 
                  value={newServicePrice} onChange={e => setNewServicePrice(e.target.value)} />
             </div>
             <div>
                <label className="block text-xs text-slate-400 mb-1">DuraÃ§Ã£o (min)</label>
                <input type="number" className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white" 
                  value={newServiceDuration} onChange={e => setNewServiceDuration(e.target.value)} />
             </div>
          </div>
          <div>
            <label className="block text-xs text-slate-400 mb-1">Categoria</label>
            <select className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-slate-300"
              value={newServiceCategory} onChange={e => setNewServiceCategory(e.target.value)}>
                <option value="">Sem categoria</option>
                {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
            </select>
          </div>
          <button onClick={handleCreateService} className="w-full bg-emerald-500 hover:bg-emerald-400 text-black font-semibold py-2 rounded-lg mt-2">Salvar</button>
        </div>
      </Modal>

      {/* MODAL CATEGORIA */}
      <Modal isOpen={isCatModalOpen} onClose={() => setCatModalOpen(false)} title="Nova Categoria">
        <div className="space-y-4">
           <div>
            <label className="block text-xs text-slate-400 mb-1">Nome da Categoria</label>
            <input className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white" 
              value={newCatName} onChange={e => setNewCatName(e.target.value)} />
          </div>
          <button onClick={handleCreateCategory} className="w-full bg-emerald-500 hover:bg-emerald-400 text-black font-semibold py-2 rounded-lg mt-2">Salvar</button>
        </div>
      </Modal>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\pages\owner\ServicesPage.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\owner\SettingsPage.tsx ---
Path: src\react-app\pages\owner\SettingsPage.tsx
------------------------------
import { useEffect, useState } from "react";
import { useTenant } from "@/react-app/contexts/TenantContext";
import { getShopHours, upsertShopHour, seedDefaultHours } from "@/react-app/lib/api/shop-hours";
import { getSegments, getPaymentMethods, updateShop, createPaymentMethod } from "@/react-app/lib/api/shops";
import { pb } from "@/react-app/lib/api/pocketbase";
import type { ShopHour, Weekday, Segment, PaymentMethod } from "@/shared/types";
import Modal from "@/react-app/components/common/Modal";

const WEEKDAYS: { key: Weekday; label: string }[] = [
  { key: "dom", label: "Domingo" }, { key: "seg", label: "Segunda" },
  { key: "ter", label: "TerÃ§a" }, { key: "qua", label: "Quarta" },
  { key: "qui", label: "Quinta" }, { key: "sex", label: "Sexta" },
  { key: "sab", label: "SÃ¡bado" },
];

type Tab = "hours" | "details" | "finance";

export default function SettingsPage() {
  const { currentShop, currentCompany, setCurrentShop } = useTenant();
  const [activeTab, setActiveTab] = useState<Tab>("hours");
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);

  // --- DADOS CARREGADOS ---
  const [hours, setHours] = useState<ShopHour[]>([]);
  const [segments, setSegments] = useState<Segment[]>([]);
  const [allPaymentMethods, setAllPaymentMethods] = useState<PaymentMethod[]>([]);
  
  // --- FORMULÃRIO DADOS DA LOJA ---
  const [shopName, setShopName] = useState("");
  const [shopSlug, setShopSlug] = useState(""); 
  const [shopDescription, setShopDescription] = useState(""); 
  const [shopPhone, setShopPhone] = useState("");
  const [shopAddress, setShopAddress] = useState("");
  const [selectedSegment, setSelectedSegment] = useState("");
  const [minAdvance, setMinAdvance] = useState(""); 
  const [maxAdvance, setMaxAdvance] = useState(""); 
  
  // Logo
  const [logoPreview, setLogoPreview] = useState<string | null>(null);
  const [logoFile, setLogoFile] = useState<File | null>(null);

  // --- FORMULÃRIO FINANCEIRO ---
  const [pixKey, setPixKey] = useState("");
  const [pixKeyType, setPixKeyType] = useState("cpf");
  const [selectedPayments, setSelectedPayments] = useState<string[]>([]);
  
  // Modal Novo Pagamento
  const [isPayModalOpen, setPayModalOpen] = useState(false);
  const [newPayName, setNewPayName] = useState("");

  useEffect(() => {
    if (currentShop) {
      loadData();
      
      // Preenche estados do form
      setShopName(currentShop.name);
      setShopSlug(currentShop.slug);
      setShopDescription(currentShop.description || "");
      setShopPhone(currentShop.phone || "");
      setShopAddress(currentShop.address || "");
      setSelectedSegment(currentShop.segment_id || "");
      
      setMinAdvance(currentShop.min_advance_time?.toString() || "30");
      setMaxAdvance(currentShop.max_advance_time?.toString() || "30");

      setPixKey(currentShop.pix_key || "");
      setPixKeyType(currentShop.pix_key_type || "cpf");
      setSelectedPayments(currentShop.accepted_payment_methods || []);

      if (currentShop.logo) {
        // CORREÃ‡ÃƒO: getUrl -> getURL
        const url = pb.files.getURL(currentShop, currentShop.logo);
        setLogoPreview(url);
      } else {
        setLogoPreview(null);
      }
    }
  }, [currentShop?.id]);

  async function loadData() {
    if (!currentShop || !currentCompany) return;
    setLoading(true);
    try {
      const [h, s, p] = await Promise.all([
        getShopHours(currentShop.id),
        getSegments(),
        getPaymentMethods(currentCompany.id)
      ]);
      setHours(h);
      setSegments(s);
      setAllPaymentMethods(p);
    } catch (err: any) {
      // CORREÃ‡ÃƒO: Ignora cancelamento automÃ¡tico
      if (err.status === 0 || err.isAbort) return;
      console.error(err);
    } finally {
      setLoading(false);
    }
  }

  // --- HANDLERS ---

  async function handleSaveDetails() {
    if (!currentShop) return;
    setSaving(true);
    try {
      const payload: any = {
        name: shopName,
        slug: shopSlug,
        description: shopDescription,
        phone: shopPhone,
        address: shopAddress,
        segment_id: selectedSegment,
        min_advance_time: Number(minAdvance),
        max_advance_time: Number(maxAdvance),
      };

      if (logoFile) {
        payload.logo = logoFile;
      }

      const updated = await updateShop(currentShop.id, payload);
      setCurrentShop(updated);
      alert("Dados da loja atualizados!");
    } catch (error: any) {
      console.error(error);
      alert("Erro ao salvar. Verifique se o Slug jÃ¡ existe.");
    } finally {
      setSaving(false);
    }
  }

  async function handleSaveFinance() {
    if (!currentShop) return;
    setSaving(true);
    try {
      const updated = await updateShop(currentShop.id, {
        pix_key: pixKey,
        pix_key_type: pixKeyType as any,
        accepted_payment_methods: selectedPayments
      });
      setCurrentShop(updated);
      alert("ConfiguraÃ§Ãµes financeiras salvas!");
    } catch (error) {
      alert("Erro ao salvar financeiro.");
    } finally {
      setSaving(false);
    }
  }

  async function handleSaveHour(day: Weekday, start: string, end: string, closed: boolean) {
    if (!currentShop || !currentCompany) return;
    setSaving(true);
    await upsertShopHour({
      shopId: currentShop.id,
      companyId: currentCompany.id,
      weekday: day,
      startTime: start,
      endTime: end,
      isClosed: closed
    });
    const newHours = await getShopHours(currentShop.id);
    setHours(newHours);
    setSaving(false);
  }

  async function handleSeedHours() {
    if (!currentShop || !currentCompany) return;
    if (!confirm("Resetar horÃ¡rios para o padrÃ£o?")) return;
    setSaving(true);
    await seedDefaultHours(currentShop.id, currentCompany.id);
    loadData();
    setSaving(false);
  }

  async function handleCreatePayment() {
    if (!currentCompany || !newPayName.trim()) return;
    try {
        const created = await createPaymentMethod(currentCompany.id, newPayName.trim());
        setAllPaymentMethods([...allPaymentMethods, created]);
        setSelectedPayments([...selectedPayments, created.id]);
        setNewPayName("");
        setPayModalOpen(false);
    } catch (err) {
        alert("Erro ao criar mÃ©todo de pagamento.");
    }
  }

  const handleLogoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      const file = e.target.files[0];
      setLogoFile(file);
      setLogoPreview(URL.createObjectURL(file));
    }
  };

  const togglePayment = (id: string) => {
    setSelectedPayments(prev => 
      prev.includes(id) ? prev.filter(p => p !== id) : [...prev, id]
    );
  };

  if (!currentShop) return <div>Carregando...</div>;

  return (
    <div className="space-y-6 pb-20">
      <h1 className="text-2xl font-bold text-white">ConfiguraÃ§Ãµes</h1>

      <div className="flex gap-4 border-b border-white/10 overflow-x-auto">
        <button onClick={() => setActiveTab("hours")} className={`pb-3 text-sm font-medium border-b-2 transition whitespace-nowrap ${activeTab === "hours" ? "border-emerald-500 text-emerald-400" : "border-transparent text-slate-400"}`}>
          HorÃ¡rios
        </button>
        <button onClick={() => setActiveTab("details")} className={`pb-3 text-sm font-medium border-b-2 transition whitespace-nowrap ${activeTab === "details" ? "border-emerald-500 text-emerald-400" : "border-transparent text-slate-400"}`}>
          Dados da Loja
        </button>
        <button onClick={() => setActiveTab("finance")} className={`pb-3 text-sm font-medium border-b-2 transition whitespace-nowrap ${activeTab === "finance" ? "border-emerald-500 text-emerald-400" : "border-transparent text-slate-400"}`}>
          Financeiro & Pix
        </button>
      </div>

      {loading ? <div className="text-slate-500 animate-pulse">Carregando dados...</div> : (
        <div className="bg-slate-900 border border-white/10 rounded-2xl p-6">
          
          {/* ================= ABA HORÃRIOS ================= */}
          {activeTab === "hours" && (
            <div className="space-y-4">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-semibold text-white">HorÃ¡rios de Funcionamento</h3>
                {hours.length === 0 && (
                   <button onClick={handleSeedHours} className="text-xs text-emerald-400 bg-emerald-500/10 px-3 py-1 rounded hover:bg-emerald-500/20">Preencher PadrÃ£o</button>
                )}
              </div>
              {WEEKDAYS.map((day) => {
                const config = hours.find(h => h.weekday === day.key);
                const isClosed = config?.is_closed ?? false;
                const start = config?.start_time || "09:00";
                const end = config?.end_time || "18:00";
                return (
                  <div key={day.key} className="flex flex-wrap sm:flex-nowrap items-center gap-4 py-3 border-b border-white/5 last:border-0">
                    <div className="w-24 text-slate-300 font-medium capitalize">{day.label}</div>
                    
                    <div className="flex items-center gap-2">
                      <input type="time" disabled={isClosed || saving} value={start} 
                        onChange={e => handleSaveHour(day.key, e.target.value, end, isClosed)}
                        className="bg-black/30 border border-white/10 rounded px-2 py-1 text-sm text-white disabled:opacity-30 focus:border-emerald-500 outline-none" />
                      <span className="text-slate-500">-</span>
                      <input type="time" disabled={isClosed || saving} value={end}
                        onChange={e => handleSaveHour(day.key, start, e.target.value, isClosed)}
                        className="bg-black/30 border border-white/10 rounded px-2 py-1 text-sm text-white disabled:opacity-30 focus:border-emerald-500 outline-none" />
                    </div>

                    <label className="flex items-center gap-2 text-xs text-slate-400 cursor-pointer ml-auto hover:text-white">
                      <input type="checkbox" checked={isClosed} disabled={saving}
                        onChange={e => handleSaveHour(day.key, start, end, e.target.checked)}
                        className="rounded bg-black/40 border-white/20 text-red-500 focus:ring-red-500" />
                      Fechado
                    </label>
                  </div>
                );
              })}
            </div>
          )}

          {/* ================= ABA DADOS DA LOJA ================= */}
          {activeTab === "details" && (
            <div className="space-y-8 max-w-2xl">
              <div className="space-y-4">
                <h3 className="text-sm font-semibold text-emerald-400 uppercase tracking-wider">Identidade</h3>
                
                <div className="flex items-center gap-6">
                  <div className="h-20 w-20 rounded-full bg-slate-800 border-2 border-dashed border-white/20 flex items-center justify-center overflow-hidden shrink-0">
                    {logoPreview ? (
                      <img src={logoPreview} alt="Logo Preview" className="h-full w-full object-cover" />
                    ) : (
                      <span className="text-xs text-slate-500 text-center">Sem<br/>Logo</span>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-white mb-1">Logotipo da Unidade</label>
                    <input 
                      type="file" 
                      accept="image/*"
                      onChange={handleLogoChange}
                      className="block w-full text-xs text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-emerald-500/10 file:text-emerald-400 hover:file:bg-emerald-500/20"
                    />
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-xs text-slate-400 mb-1">Nome da Unidade</label>
                    <input className="w-full bg-black/30 border border-white/10 rounded-lg p-2.5 text-white focus:border-emerald-500 outline-none"
                      value={shopName} onChange={e => setShopName(e.target.value)} />
                  </div>
                  <div>
                    <label className="block text-xs text-slate-400 mb-1">Link Personalizado (Slug)</label>
                    <div className="flex items-center">
                      <span className="bg-slate-800 border border-white/10 border-r-0 rounded-l-lg p-2.5 text-slate-500 text-xs">/book/</span>
                      <input className="w-full bg-black/30 border border-white/10 rounded-r-lg p-2.5 text-white focus:border-emerald-500 outline-none"
                        value={shopSlug} onChange={e => setShopSlug(e.target.value.toLowerCase().replace(/\s+/g, '-'))} />
                    </div>
                  </div>
                </div>

                <div>
                  <label className="block text-xs text-slate-400 mb-1">DescriÃ§Ã£o</label>
                  <textarea className="w-full bg-black/30 border border-white/10 rounded-lg p-2.5 text-white focus:border-emerald-500 outline-none" rows={3}
                    value={shopDescription} onChange={e => setShopDescription(e.target.value)} />
                </div>

                <div>
                   <label className="block text-xs text-slate-400 mb-1">Segmento</label>
                   <select className="w-full bg-black/30 border border-white/10 rounded-lg p-2.5 text-slate-300 focus:border-emerald-500 outline-none"
                      value={selectedSegment} onChange={e => setSelectedSegment(e.target.value)}>
                      <option value="">Selecione...</option>
                      {segments.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                   </select>
                </div>
              </div>

              <div className="space-y-4 border-t border-white/5 pt-4">
                <h3 className="text-sm font-semibold text-emerald-400 uppercase tracking-wider">LocalizaÃ§Ã£o</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                   <div>
                    <label className="block text-xs text-slate-400 mb-1">Telefone / WhatsApp</label>
                    <input className="w-full bg-black/30 border border-white/10 rounded-lg p-2.5 text-white focus:border-emerald-500 outline-none"
                      value={shopPhone} onChange={e => setShopPhone(e.target.value)} />
                   </div>
                   <div>
                    <label className="block text-xs text-slate-400 mb-1">EndereÃ§o</label>
                    <input className="w-full bg-black/30 border border-white/10 rounded-lg p-2.5 text-white focus:border-emerald-500 outline-none"
                      value={shopAddress} onChange={e => setShopAddress(e.target.value)} />
                   </div>
                </div>
              </div>

              <div className="space-y-4 border-t border-white/5 pt-4">
                 <h3 className="text-sm font-semibold text-emerald-400 uppercase tracking-wider">Regras de Agenda</h3>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                       <label className="block text-xs text-slate-400 mb-1">AntecedÃªncia MÃ­nima (minutos)</label>
                       <input type="number" className="w-full bg-black/30 border border-white/10 rounded-lg p-2.5 text-white focus:border-emerald-500 outline-none"
                         value={minAdvance} onChange={e => setMinAdvance(e.target.value)} />
                    </div>
                    <div>
                       <label className="block text-xs text-slate-400 mb-1">Agenda Aberta (dias)</label>
                       <input type="number" className="w-full bg-black/30 border border-white/10 rounded-lg p-2.5 text-white focus:border-emerald-500 outline-none"
                         value={maxAdvance} onChange={e => setMaxAdvance(e.target.value)} />
                    </div>
                 </div>
              </div>

              <div className="pt-4">
                <button onClick={handleSaveDetails} disabled={saving} className="bg-emerald-500 hover:bg-emerald-400 text-black font-semibold px-8 py-3 rounded-xl transition shadow-lg shadow-emerald-500/20">
                  {saving ? "Salvando..." : "Salvar AlteraÃ§Ãµes"}
                </button>
              </div>
            </div>
          )}

          {/* ================= ABA FINANCEIRO ================= */}
          {activeTab === "finance" && (
            <div className="space-y-6 max-w-lg">
              <div>
                <h3 className="text-sm font-semibold text-slate-200 mb-3">ConfiguraÃ§Ã£o Pix</h3>
                <div className="grid grid-cols-3 gap-4 mb-2">
                   <div className="col-span-1">
                      <label className="block text-xs text-slate-400 mb-1">Tipo de Chave</label>
                      <select className="w-full bg-black/30 border border-white/10 rounded-lg p-2.5 text-slate-300 focus:border-emerald-500 outline-none"
                        value={pixKeyType} onChange={e => setPixKeyType(e.target.value)}>
                        <option value="cpf">CPF</option>
                        <option value="cnpj">CNPJ</option>
                        <option value="email">E-mail</option>
                        <option value="telefone">Telefone</option>
                        <option value="aleatoria">AleatÃ³ria</option>
                      </select>
                   </div>
                   <div className="col-span-2">
                      <label className="block text-xs text-slate-400 mb-1">Chave Pix</label>
                      <input className="w-full bg-black/30 border border-white/10 rounded-lg p-2.5 text-white focus:border-emerald-500 outline-none"
                        value={pixKey} onChange={e => setPixKey(e.target.value)} placeholder="Sua chave aqui" />
                   </div>
                </div>
              </div>

              <div>
                <div className="flex items-center justify-between mb-3">
                    <h3 className="text-sm font-semibold text-slate-200">MÃ©todos de Pagamento Aceitos</h3>
                    <button 
                        onClick={() => setPayModalOpen(true)}
                        className="text-xs bg-emerald-500/10 text-emerald-400 px-3 py-1 rounded hover:bg-emerald-500/20"
                    >
                        + Novo MÃ©todo
                    </button>
                </div>
                
                {allPaymentMethods.length === 0 ? (
                    <p className="text-xs text-slate-500 p-4 border border-dashed border-white/10 rounded-xl text-center">
                        Nenhum mÃ©todo cadastrado no sistema. <br/>
                        Clique em <strong>+ Novo MÃ©todo</strong> para comeÃ§ar.
                    </p>
                ) : (
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    {allPaymentMethods.map(pm => (
                        <label key={pm.id} className={`flex items-center gap-3 p-3 rounded-xl border cursor-pointer transition ${selectedPayments.includes(pm.id) ? "bg-emerald-500/10 border-emerald-500/50" : "bg-black/20 border-white/5 hover:bg-white/5"}`}>
                            <input type="checkbox" checked={selectedPayments.includes(pm.id)} onChange={() => togglePayment(pm.id)}
                            className="rounded bg-black/40 border-white/20 text-emerald-500 focus:ring-emerald-500" />
                            <span className={selectedPayments.includes(pm.id) ? "text-emerald-400" : "text-slate-400"}>{pm.name}</span>
                        </label>
                    ))}
                    </div>
                )}
              </div>

              <div className="pt-4">
                <button onClick={handleSaveFinance} disabled={saving} className="bg-emerald-500 hover:bg-emerald-400 text-black font-semibold px-8 py-3 rounded-xl transition shadow-lg shadow-emerald-500/20">
                  {saving ? "Salvando..." : "Salvar ConfiguraÃ§Ãµes"}
                </button>
              </div>
            </div>
          )}

        </div>
      )}

      {/* MODAL CRIAR MÃ‰TODO */}
      <Modal isOpen={isPayModalOpen} onClose={() => setPayModalOpen(false)} title="Novo MÃ©todo de Pagamento">
         <div className="space-y-4">
            <div>
               <label className="block text-xs text-slate-400 mb-1">Nome do MÃ©todo</label>
               <input className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white"
                  placeholder="Ex: Dinheiro, CartÃ£o de CrÃ©dito, Fiado..."
                  value={newPayName} onChange={e => setNewPayName(e.target.value)} />
            </div>
            <button onClick={handleCreatePayment} className="w-full bg-emerald-500 hover:bg-emerald-400 text-black font-semibold py-2 rounded-lg mt-2">
                Criar e Selecionar
            </button>
         </div>
      </Modal>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\pages\owner\SettingsPage.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\owner\ShopsPage.tsx ---
Path: src\react-app\pages\owner\ShopsPage.tsx
------------------------------
import { useState } from "react";
import { useTenant } from "@/react-app/contexts/TenantContext";
import { useNavigate } from "react-router-dom";
import Modal from "@/react-app/components/common/Modal";
import { createInitialShop } from "@/react-app/lib/api/onboarding";
import { useAuth } from "@/react-app/contexts/AuthContext";

export default function ShopsPage() {
  const { shops, currentShop, setCurrentShop, currentCompany, reloadTenants } = useTenant();
  const { user } = useAuth();
  const navigate = useNavigate();
  
  const [isModalOpen, setModalOpen] = useState(false);
  const [name, setName] = useState("");
  const [slug, setSlug] = useState("");

  const handleSwitch = (shopId: string) => {
    const found = shops.find(s => s.id === shopId);
    if (found) setCurrentShop(found);
  };

  const handleCreate = async () => {
     if (!user || !currentCompany) return;
     try {
        await createInitialShop(currentCompany.id, user.id, { name, slug });
        await reloadTenants();
        setModalOpen(false);
        setName("");
        setSlug("");
     } catch(e) {
        alert("Erro ao criar loja. Verifique se o slug Ã© Ãºnico.");
     }
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold text-white">Minhas Unidades</h1>
        <button onClick={() => setModalOpen(true)} className="bg-emerald-500 hover:bg-emerald-400 text-black font-semibold px-4 py-2 rounded-xl">
          + Nova Unidade
        </button>
      </div>

      <div className="grid gap-4 md:grid-cols-2">
         {shops.map(shop => {
            const isActive = shop.id === currentShop?.id;
            return (
                <div key={shop.id} className={`p-6 rounded-2xl border transition ${isActive ? 'bg-emerald-900/20 border-emerald-500/50' : 'bg-slate-900 border-white/5'}`}>
                   <div className="flex justify-between items-start">
                      <div>
                         <h3 className="text-lg font-bold text-white">{shop.name}</h3>
                         <p className="text-sm text-slate-400">/book/{shop.slug}</p>
                      </div>
                      {isActive ? (
                          <span className="bg-emerald-500 text-black text-xs font-bold px-2 py-1 rounded">Selecionada</span>
                      ) : (
                          <button onClick={() => handleSwitch(shop.id)} className="text-sm text-emerald-400 hover:underline">
                             Selecionar
                          </button>
                      )}
                   </div>
                   <div className="mt-4 flex gap-2">
                      <a href={`/book/${shop.slug}`} target="_blank" className="text-xs bg-black/30 px-3 py-1.5 rounded border border-white/10 text-slate-300 hover:text-white">
                         Ver pÃ¡gina pÃºblica â†—
                      </a>
                      <button onClick={() => navigate("/owner/settings")} className="text-xs bg-black/30 px-3 py-1.5 rounded border border-white/10 text-slate-300 hover:text-white">
                         Editar HorÃ¡rios
                      </button>
                   </div>
                </div>
            );
         })}
      </div>

      <Modal isOpen={isModalOpen} onClose={() => setModalOpen(false)} title="Nova Unidade">
         <div className="space-y-4">
            <div>
               <label className="block text-xs text-slate-400 mb-1">Nome</label>
               <input className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white"
                  value={name} onChange={e => {
                      setName(e.target.value);
                      setSlug(e.target.value.toLowerCase().replace(/\s/g, '-'));
                  }} />
            </div>
            <div>
               <label className="block text-xs text-slate-400 mb-1">Slug (URL)</label>
               <input className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white"
                  value={slug} onChange={e => setSlug(e.target.value)} />
            </div>
            <button onClick={handleCreate} className="w-full bg-emerald-500 hover:bg-emerald-400 text-black font-semibold py-2 rounded-lg mt-2">
                Criar Unidade
            </button>
         </div>
      </Modal>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\pages\owner\ShopsPage.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\owner\StaffPage.tsx ---
Path: src\react-app\pages\owner\StaffPage.tsx
------------------------------
import { useEffect, useState } from "react";
import { useTenant } from "@/react-app/contexts/TenantContext";
import { 
    getProfessionalsByShop, 
    createProfessionalUser, 
    updateProfessionalUser, 
    removeProfessional 
} from "@/react-app/lib/api/staff";
import type { User } from "@/shared/types";
import Modal from "@/react-app/components/common/Modal";

export default function StaffPage() {
  const { currentShop, currentCompany } = useTenant();
  const [staff, setStaff] = useState<User[]>([]);
  const [loading, setLoading] = useState(true);
  
  // Controle do Modal
  const [isModalOpen, setModalOpen] = useState(false);
  const [editingUser, setEditingUser] = useState<User | null>(null);

  // Form State
  const [name, setName] = useState("");
  const [email, setEmail] = useState("");
  const [phone, setPhone] = useState("");
  const [password, setPassword] = useState("");

  useEffect(() => {
    let isMounted = true;

    async function load() {
      if (!currentShop) return;
      setLoading(true);
      try {
        const data = await getProfessionalsByShop(currentShop.id);
        if (isMounted) {
          setStaff(data);
        }
      } catch (err: any) {
        if (err.status === 0 || err.isAbort) return;
        console.error(err);
      } finally {
        if (isMounted) setLoading(false);
      }
    }

    load();

    return () => {
      isMounted = false;
    };
  }, [currentShop?.id]);

  // Abre modal para CRIAR
  const handleOpenCreate = () => {
      setEditingUser(null);
      setName("");
      setEmail("");
      setPhone("");
      setPassword("");
      setModalOpen(true);
  };

  // Abre modal para EDITAR
  const handleOpenEdit = (user: User) => {
      setEditingUser(user);
      setName(user.name || ""); 
      setEmail(user.email);
      setPhone(user.phone || ""); 
      setPassword(""); 
      setModalOpen(true);
  };

  async function handleSave() {
    if (!currentShop || !currentCompany) {
        alert("Erro de contexto: Loja ou Empresa nÃ£o identificada.");
        return;
    }
    
    if (!name.trim()) return alert("O Nome Ã© obrigatÃ³rio.");
    if (!editingUser && !email.trim()) return alert("O E-mail Ã© obrigatÃ³rio.");
    if (!editingUser && password && password.length < 8) {
        return alert("A senha deve ter no mÃ­nimo 8 caracteres.");
    }

    try {
      if (editingUser) {
          // MODO EDIÃ‡ÃƒO
          await updateProfessionalUser(editingUser.id, { name, phone });
          alert("Dados atualizados com sucesso!");
      } else {
          // MODO CRIAÃ‡ÃƒO
          await createProfessionalUser({
            name, 
            email, 
            phone,
            password, 
            company_id: currentCompany.id, 
            shop_id: currentShop.id
          });
          alert("Profissional cadastrado com sucesso!");
      }
      
      setModalOpen(false);
      const data = await getProfessionalsByShop(currentShop.id);
      setStaff(data);
      
    } catch (err: any) {
        console.error("Erro completo:", err);
        if (err.status === 400) {
            alert("Erro de validaÃ§Ã£o (400). Verifique se o e-mail jÃ¡ estÃ¡ em uso.");
        } else {
            alert(`Ocorreu um erro: ${err.message}`);
        }
    }
  }

  async function handleRemove(id: string) {
    if (confirm("Remover acesso de profissional deste usuÃ¡rio?")) {
        await removeProfessional(id);
        const data = await getProfessionalsByShop(currentShop!.id);
        setStaff(data);
    }
  }

  if (!currentShop) return <div>Selecione uma unidade.</div>;

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold text-white">Profissionais</h1>
        <button onClick={handleOpenCreate} className="bg-emerald-500 hover:bg-emerald-400 text-black font-semibold px-4 py-2 rounded-xl">
          + Adicionar Profissional
        </button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {loading ? <p className="text-slate-500">Carregando...</p> : staff.map(user => (
          <div key={user.id} className="bg-slate-900 border border-white/5 p-4 rounded-xl flex items-center gap-4 relative group">
             <div className="h-12 w-12 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 font-bold overflow-hidden shrink-0">
                {user.avatar ? <img src={user.avatar} className="w-full h-full object-cover"/> : user.name?.[0]}
             </div>
             
             <div className="flex-1 min-w-0">
                <p className="font-semibold text-white truncate">{user.name}</p>
                <p className="text-xs text-slate-500 truncate">{user.email}</p>
                {user.phone && <p className="text-xs text-slate-600 truncate">{user.phone}</p>}
             </div>

             {user.role !== 'dono' && (
                 <div className="flex items-center gap-2">
                     <button onClick={() => handleOpenEdit(user)} className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition" title="Editar">âœï¸</button>
                     <button onClick={() => handleRemove(user.id)} className="p-2 text-slate-600 hover:text-red-400 hover:bg-slate-800 rounded-lg transition" title="Remover">ğŸ—‘ï¸</button>
                 </div>
             )}
          </div>
        ))}
      </div>

      <Modal isOpen={isModalOpen} onClose={() => setModalOpen(false)} title={editingUser ? "Editar Profissional" : "Novo Profissional"}>
         <div className="space-y-4">
            {!editingUser && (
                <div className="bg-slate-800 p-3 rounded-lg text-xs text-slate-300 border border-white/5">
                    <p>O profissional usarÃ¡ o <strong>e-mail</strong> e a <strong>senha</strong> abaixo para acessar.</p>
                </div>
            )}
            <div>
                <label className="block text-xs text-slate-400 mb-1">Nome Completo *</label>
                <input className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white outline-none focus:border-emerald-500"
                   value={name} onChange={e => setName(e.target.value)} placeholder="Ex: JoÃ£o Silva" />
            </div>
            
            <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="block text-xs text-slate-400 mb-1">E-mail</label>
                    <input type="email" className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white outline-none focus:border-emerald-500 disabled:opacity-50"
                    value={email} onChange={e => setEmail(e.target.value)} placeholder="joao@email.com" disabled={!!editingUser} />
                </div>
                <div>
                    <label className="block text-xs text-slate-400 mb-1">Telefone</label>
                    <input className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white outline-none focus:border-emerald-500"
                    value={phone} onChange={e => setPhone(e.target.value)} placeholder="(00) 00000-0000" />
                </div>
            </div>

            {!editingUser && (
                <div>
                    <label className="block text-xs text-slate-400 mb-1">Senha (Opcional)</label>
                    <input type="text" className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white outline-none focus:border-emerald-500"
                    value={password} onChange={e => setPassword(e.target.value)} placeholder="PadrÃ£o: Mudar@123" />
                </div>
            )}

            <button onClick={handleSave} className="w-full bg-emerald-500 hover:bg-emerald-400 text-black font-semibold py-2 rounded-lg mt-2 transition">
                {editingUser ? "Salvar AlteraÃ§Ãµes" : "Cadastrar Profissional"}
            </button>
         </div>
      </Modal>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\pages\owner\StaffPage.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\public\LandingPage.tsx ---
Path: src\react-app\pages\public\LandingPage.tsx
------------------------------
// Caminho: src/react-app/pages/public/LandingPage.tsx
import { Link } from "react-router-dom";

export default function LandingPage() {
  return (
    <div className="min-h-screen bg-slate-950 text-white overflow-x-hidden">

      {/* ğŸ”® Background com glow */}
      <div className="absolute inset-0 -z-10">
        <div className="absolute -left-20 -top-20 w-72 h-72 bg-emerald-500/30 blur-3xl rounded-full" />
        <div className="absolute -right-16 bottom-0 w-80 h-80 bg-sky-500/30 blur-3xl rounded-full" />
      </div>

      {/* HERO */}
      <header className="min-h-[70vh] flex flex-col items-center justify-center text-center px-6">
        <h1 className="text-4xl md:text-6xl font-bold leading-tight">
          Transforme a forma como vocÃª gerencia
          <br />
          <span className="text-emerald-400">agendamentos e clientes</span>
        </h1>

        <p className="text-slate-300 max-w-2xl mt-4 text-sm md:text-base">
          Uma plataforma completa para Barbearias, SalÃµes, ClÃ­nicas EstÃ©ticas,
          Esmalterias e Studios. Tudo em um sÃ³ lugar.
        </p>

        <div className="flex flex-col md:flex-row gap-4 mt-8">
          <Link
            to="/login"
            className="px-6 py-3 rounded-xl bg-white text-slate-900 font-semibold shadow-lg hover:opacity-90"
          >
            Entrar
          </Link>

          <Link
            to="/register"
            className="px-6 py-3 rounded-xl bg-emerald-500 text-slate-900 font-semibold shadow-lg hover:bg-emerald-400"
          >
            ComeÃ§ar grÃ¡tis por 15 dias
          </Link>
        </div>
      </header>

      {/* FERRAMENTAS */}
      <section className="py-20 px-6 max-w-6xl mx-auto">
        <h2 className="text-3xl font-bold text-center mb-12">
          Ferramentas que fazem diferenÃ§a
        </h2>

        <div className="grid md:grid-cols-3 gap-8">
          {[
            {
              icon: "ğŸ“…",
              title: "Agenda Inteligente",
              desc: "Evite overbooking com horÃ¡rios automatizados.",
            },
            {
              icon: "ğŸ’ˆ",
              title: "Profissionais organizados",
              desc: "Cada membro vÃª sua prÃ³pria agenda e atualiza atendimentos.",
            },
            {
              icon: "ğŸ“Š",
              title: "Faturamento claro",
              desc: "Veja todos os nÃºmeros importantes em tempo real.",
            },
          ].map((item) => (
            <div
              key={item.title}
              className="bg-slate-900 p-6 rounded-2xl border border-slate-800 space-y-2"
            >
              <div className="text-3xl">{item.icon}</div>
              <h3 className="text-xl font-semibold">{item.title}</h3>
              <p className="text-slate-400 text-sm">{item.desc}</p>
            </div>
          ))}
        </div>
      </section>

      {/* CTA FINAL */}
      <section className="py-20 px-6 text-center bg-gradient-to-r from-emerald-600 to-sky-600">
        <h2 className="text-3xl md:text-4xl font-bold mb-4">
          Comece agora mesmo
        </h2>
        <p className="text-white/80 mb-6">Leva menos de 1 minuto.</p>

        <Link
          to="/register"
          className="px-10 py-4 bg-white text-slate-900 rounded-xl font-semibold shadow-xl hover:opacity-90"
        >
          Criar conta gratuitamente
        </Link>
      </section>

      <footer className="py-6 text-center text-slate-500 text-sm">
        Â© 2025 TeaAgendei â€” Todos os direitos reservados.
      </footer>
    </div>
  );
}

--- FIM DO ARQUIVO: src\react-app\pages\public\LandingPage.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\staff\StaffAgendaPage.tsx ---
Path: src\react-app\pages\staff\StaffAgendaPage.tsx
------------------------------
import { useEffect, useState, useMemo } from "react";
import { useAuth } from "@/react-app/contexts/AuthContext";
import { getStaffAppointmentsByDate, updateAppointmentStatus } from "@/react-app/lib/api/appointments";
import { getPaymentMethods } from "@/react-app/lib/api/shops"; 
import { Appointment, AppointmentStatus, PaymentStatus, PaymentMethod } from "@/shared/types";
import Modal from "@/react-app/components/common/Modal"; 
import { StaffBookingModal } from "@/react-app/components/dashboard/StaffBookingModal";
import { Ban, Clock } from "lucide-react";

// CORREÃ‡ÃƒO: Time Visual (Converte UTC do banco para hora local do navegador)
// Antes estava cortando a string (substring), o que mostrava a hora UTC (+3h)
const formatTime = (isoString: string) => {
  if (!isoString) return "--:--";
  return new Date(isoString).toLocaleTimeString("pt-BR", {
    hour: "2-digit", 
    minute: "2-digit"
  });
};

// Helper Money
const formatMoney = (val: number) => 
  new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(val);

export default function StaffAgendaPage() {
  const { user } = useAuth();
  
  const [selectedDate, setSelectedDate] = useState(() => {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  });

  const [appointments, setAppointments] = useState<Appointment[]>([]);
  const [loading, setLoading] = useState(true);

  // Estados dos Modais
  const [isFinishModalOpen, setFinishModalOpen] = useState(false);
  const [apptToFinish, setApptToFinish] = useState<Appointment | null>(null);
  const [availableMethods, setAvailableMethods] = useState<PaymentMethod[]>([]);
  const [finalPaymentMethod, setFinalPaymentMethod] = useState("");
  const [finishing, setFinishing] = useState(false);
  const [isBookingModalOpen, setBookingModalOpen] = useState(false);

  async function loadAgenda() {
      if (!user) return;
      setLoading(true);
      try {
        const data = await getStaffAppointmentsByDate(user.id, selectedDate);
        setAppointments(data);
      } catch (err: any) {
        if (err.status === 0 || err.isAbort) return;
        console.error("Erro ao carregar agenda", err);
      } finally {
        setLoading(false);
      }
    }

  useEffect(() => {
    let isMounted = true;
    async function load() {
        if(isMounted) await loadAgenda();
    }
    load();

    if (user?.company_id) {
        getPaymentMethods(user.company_id).then(methods => {
            if(isMounted) setAvailableMethods(methods);
        }).catch(err => { if (err.status !== 0) console.error(err); });
    }
    
    const interval = setInterval(() => { if(isMounted) loadAgenda(); }, 60000);
    return () => { isMounted = false; clearInterval(interval); };
  }, [user?.id, selectedDate, user?.company_id]);


  // --- CÃLCULOS DO DASHBOARD (KPIS DIÃRIOS) ---
  const dailyStats = useMemo(() => {
    const activeAppts = appointments.filter(a => a.status !== AppointmentStatus.Cancelled);
    
    // CORREÃ‡ÃƒO: NÃ£o conta bloqueios (Status 6) nos KPIs de atendimento
    const realAppointments = activeAppts.filter(a => a.status !== AppointmentStatus.Blocked);
    
    const totalCount = realAppointments.length;
    
    const totalRevenue = realAppointments
        .reduce((acc, curr) => acc + (curr.total_amount || 0), 0);
        
    const completedCount = realAppointments.filter(a => a.status === AppointmentStatus.Completed).length;

    return { totalCount, totalRevenue, completedCount };
  }, [appointments]);


  const handlePrevDay = () => {
    const date = new Date(selectedDate + "T00:00:00");
    date.setDate(date.getDate() - 1);
    setSelectedDate(date.toISOString().split('T')[0]);
  };
  const handleNextDay = () => {
    const date = new Date(selectedDate + "T00:00:00");
    date.setDate(date.getDate() + 1);
    setSelectedDate(date.toISOString().split('T')[0]);
  };

  async function handleStatusChange(id: string, newStatus: AppointmentStatus) {
    setAppointments(prev => prev.map(appt => 
      appt.id === id ? { ...appt, status: newStatus } : appt
    ));
    try {
      await updateAppointmentStatus(id, newStatus);
    } catch (err) {
      alert("Erro ao atualizar. Recarregando...");
      loadAgenda();
    }
  }

  const openFinishModal = (appt: Appointment) => {
    setApptToFinish(appt);
    setFinalPaymentMethod(appt.payment_method || (availableMethods[0]?.id || ""));
    setFinishModalOpen(true);
  };

  const handleConfirmFinish = async () => {
    if (!apptToFinish) return;
    setFinishing(true);
    try {
        await updateAppointmentStatus(
            apptToFinish.id, 
            AppointmentStatus.Completed, 
            PaymentStatus.PAGO, 
            finalPaymentMethod
        );
        setAppointments(prev => prev.map(appt => 
            appt.id === apptToFinish.id ? { 
                ...appt, 
                status: AppointmentStatus.Completed, 
                payment_status: PaymentStatus.PAGO,
                payment_method: finalPaymentMethod,
                expand: {
                   ...appt.expand,
                   payment_method: availableMethods.find(m => m.id === finalPaymentMethod)
                }
            } : appt
        ));
        setFinishModalOpen(false);
        setApptToFinish(null);
    } catch (error) {
        alert("Erro ao finalizar atendimento.");
    } finally {
        setFinishing(false);
    }
  };

  const displayDate = new Date(selectedDate + "T00:00:00").toLocaleDateString("pt-BR", { 
    weekday: 'long', day: 'numeric', month: 'long' 
  });
  
  const isToday = (() => {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    return selectedDate === `${year}-${month}-${day}`;
  })();

  return (
    <div className="space-y-8 pb-20">
      
      <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
           <h1 className="text-3xl font-bold text-white mb-1">OlÃ¡, {user?.name?.split(' ')[0]} ğŸ‘‹</h1>
           <p className="text-slate-400">Aqui estÃ¡ sua programaÃ§Ã£o de hoje.</p>
        </div>
        
        <div className="flex gap-3">
            <button 
                onClick={() => setBookingModalOpen(true)}
                className="bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-bold px-4 py-2 rounded-xl transition shadow-lg shadow-emerald-500/20 flex items-center gap-2"
            >
                + Agenda / Bloqueio
            </button>

            <div className="flex items-center gap-2 bg-slate-900 p-1.5 rounded-xl border border-white/10 shadow-lg">
                <button onClick={handlePrevDay} className="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition">â†</button>
                <div className="px-2 text-center">
                    <span className="block text-xs text-slate-500 uppercase font-bold tracking-wider">{isToday ? "Hoje" : "Data"}</span>
                    <input 
                    type="date"
                    value={selectedDate}
                    onChange={(e) => setSelectedDate(e.target.value)}
                    className="bg-transparent border-none text-white text-sm font-medium focus:ring-0 cursor-pointer p-0 w-24 text-center [&::-webkit-calendar-picker-indicator]:hidden"
                    />
                </div>
                <button onClick={handleNextDay} className="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition">â†’</button>
            </div>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div className="bg-indigo-600/10 border border-indigo-500/20 p-4 rounded-2xl flex flex-col justify-between h-28">
             <div className="text-indigo-400 text-sm font-medium">Agendamentos</div>
             <div className="text-3xl font-bold text-white">{dailyStats.totalCount}</div>
          </div>
          <div className="bg-emerald-600/10 border border-emerald-500/20 p-4 rounded-2xl flex flex-col justify-between h-28">
             <div className="text-emerald-400 text-sm font-medium">Faturamento do Dia</div>
             <div className="text-2xl font-bold text-white">{formatMoney(dailyStats.totalRevenue)}</div>
          </div>
          <div className="bg-slate-800/50 border border-white/5 p-4 rounded-2xl flex flex-col justify-between h-28 col-span-2 md:col-span-2">
             <div className="text-slate-400 text-sm font-medium">Progresso</div>
             <div className="w-full bg-slate-700 h-2 rounded-full overflow-hidden mt-2">
                 <div 
                    className="bg-indigo-500 h-full transition-all duration-500" 
                    style={{ width: `${dailyStats.totalCount > 0 ? (dailyStats.completedCount / dailyStats.totalCount) * 100 : 0}%` }}
                 />
             </div>
             <div className="text-xs text-slate-500 mt-2 text-right">
                {dailyStats.completedCount} de {dailyStats.totalCount} finalizados
             </div>
          </div>
      </div>

      <div className="h-px bg-white/5 w-full my-6"></div>

      <h2 className="text-xl font-bold text-white flex items-center gap-2">
         Agenda <span className="text-slate-500 text-base font-normal capitalize">({displayDate})</span>
      </h2>

      {loading ? (
        <div className="flex justify-center py-20 text-slate-500">Carregando agenda...</div>
      ) : appointments.length === 0 ? (
        <div className="text-center py-16 px-6 bg-slate-900/30 rounded-3xl border border-white/5 border-dashed">
          <p className="text-slate-400 text-lg">Livre! ğŸ‰</p>
          <p className="text-sm text-slate-500">Nenhum agendamento para este dia.</p>
        </div>
      ) : (
        <div className="relative border-l border-white/10 ml-4 space-y-8">
          {appointments.map((appt: any) => {
            const status = appt.status;
            // Verifica explicitamente se Ã© status 6 (Bloqueio)
            const isBlocked = status === AppointmentStatus.Blocked;

            const clientName = isBlocked 
                ? "BLOQUEIO DE AGENDA" 
                : (appt.expand?.client_id?.name || appt.customer_name || "Cliente Avulso");

            const serviceName = isBlocked 
                ? (appt.notes || "IndisponÃ­vel") 
                : (appt.expand?.service_id?.name || "ServiÃ§o");

            const paymentName = appt.expand?.payment_method?.name || (appt.payment_method ? "Pagamento Definido" : "NÃ£o escolhido");
            
            const isCompleted = status === AppointmentStatus.Completed;
            const isCancelled = status === AppointmentStatus.Cancelled;
            const isInProgress = status === AppointmentStatus.InProgress;

            let cardBg = "bg-slate-900";
            let borderColor = "border-white/5";
            let timeColor = "text-slate-400";
            let titleColor = "text-slate-100";

            if (isBlocked) {
                cardBg = "bg-red-950/20";
                borderColor = "border-red-500/20";
                timeColor = "text-red-400";
                titleColor = "text-red-200";
            } else if (isInProgress) {
                cardBg = "bg-indigo-900/20";
                borderColor = "border-indigo-500/50";
                timeColor = "text-indigo-400";
            } else if (isCompleted) {
                cardBg = "bg-emerald-900/10";
                borderColor = "border-emerald-500/20";
                timeColor = "text-emerald-500";
            }

            return (
              <div key={appt.id} className="relative pl-8">
                <div className={`absolute -left-[5px] top-6 w-2.5 h-2.5 rounded-full border-2 border-slate-950 
                    ${isBlocked ? 'bg-red-500' : isInProgress ? 'bg-indigo-500 animate-pulse' : isCompleted ? 'bg-emerald-500' : 'bg-slate-600'}`}>
                </div>
                
                <div className={`p-5 rounded-2xl border ${borderColor} ${cardBg} transition hover:border-white/10 ${isCancelled ? 'opacity-50 grayscale' : ''}`}>
                    <div className="flex flex-col md:flex-row gap-4 justify-between">
                        
                        <div>
                            <div className={`text-sm font-bold font-mono mb-1 ${timeColor} flex items-center gap-2`}>
                                <Clock size={14} />
                                {/* CORREÃ‡ÃƒO: Exibe a hora convertida para local */}
                                {formatTime(appt.start_time)}
                                {isBlocked && <span className="text-[10px] uppercase ml-1 border border-red-500/30 px-1 rounded bg-red-500/10">Bloqueado</span>}
                            </div>
                            
                            <h3 className={`text-lg font-bold ${titleColor}`}>{clientName}</h3>
                            <p className="text-slate-400 text-sm flex items-center gap-2">
                                {isBlocked && <Ban size={14} />} {serviceName}
                            </p>
                            
                            {!isBlocked && (
                                <>
                                    {appt.customer_phone && <p className="text-xs text-slate-500 mt-1">ğŸ“ {appt.customer_phone}</p>}
                                    <div className="flex gap-2 mt-3">
                                        <span className="px-2 py-0.5 rounded text-[10px] bg-slate-800 text-slate-400 border border-white/5 uppercase tracking-wide">
                                            {paymentName}
                                        </span>
                                        {isCancelled && <span className="px-2 py-0.5 rounded text-[10px] bg-red-500/20 text-red-400 border border-red-500/20 uppercase">Cancelado</span>}
                                        {isCompleted && <span className="px-2 py-0.5 rounded text-[10px] bg-emerald-500/20 text-emerald-400 border border-emerald-500/20 uppercase">ConcluÃ­do</span>}
                                    </div>
                                </>
                            )}
                        </div>

                        <div className="flex flex-col justify-between items-end gap-4">
                            {!isBlocked && <p className="text-xl font-bold text-white">{formatMoney(appt.total_amount || 0)}</p>}
                            
                            <div className="flex gap-2">
                                {!isCancelled && !isCompleted && (
                                    <>
                                        {status !== AppointmentStatus.InProgress && (
                                            <button 
                                                onClick={() => { if(confirm(isBlocked ? "Remover este bloqueio?" : "Cancelar este agendamento?")) handleStatusChange(appt.id, AppointmentStatus.Cancelled) }}
                                                className={`px-3 py-2 rounded-lg text-xs font-medium transition flex items-center gap-1
                                                    ${isBlocked ? "text-red-300 hover:text-red-100 bg-red-500/20 hover:bg-red-500/30" : "text-slate-500 hover:text-red-400 hover:bg-red-500/10"}
                                                `}
                                            >
                                                {isBlocked ? "ğŸ”“ Desbloquear" : "Cancelar"}
                                            </button>
                                        )}
                                        
                                        {!isBlocked && (
                                            <>
                                                {(status === AppointmentStatus.Pending || status === AppointmentStatus.Confirmed) ? (
                                                    <button 
                                                        onClick={() => handleStatusChange(appt.id, AppointmentStatus.InProgress)}
                                                        className="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold shadow-lg shadow-indigo-500/20 transition"
                                                    >
                                                        Iniciar
                                                    </button>
                                                ) : status === AppointmentStatus.InProgress ? (
                                                    <button 
                                                        onClick={() => openFinishModal(appt)}
                                                        className="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-slate-950 text-xs font-bold shadow-lg shadow-emerald-500/20 transition animate-pulse"
                                                    >
                                                        Finalizar
                                                    </button>
                                                ) : null}
                                            </>
                                        )}
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
              </div>
            );
          })}
        </div>
      )}

      <Modal 
        isOpen={isFinishModalOpen} 
        onClose={() => setFinishModalOpen(false)} 
        title="Finalizar Atendimento"
      >
        <div className="space-y-6">
            <div className="bg-slate-800 p-6 rounded-2xl text-center border border-white/5">
                <p className="text-slate-400 text-sm mb-1 uppercase tracking-wider">Valor a Receber</p>
                <p className="text-4xl font-bold text-emerald-400">
                    {formatMoney(apptToFinish?.total_amount || 0)}
                </p>
            </div>

            <div>
                <label className="block text-sm font-medium text-slate-300 mb-3">Como o cliente pagou?</label>
                {availableMethods.length === 0 ? (
                    <p className="text-xs text-slate-500 text-center py-4">Nenhum mÃ©todo cadastrado na loja.</p>
                ) : (
                    <div className="grid grid-cols-2 gap-2">
                        {availableMethods.map(method => (
                            <button
                                key={method.id}
                                onClick={() => setFinalPaymentMethod(method.id)}
                                className={`p-3 rounded-xl text-sm font-medium border transition flex items-center justify-center gap-2
                                    ${finalPaymentMethod === method.id 
                                        ? "bg-emerald-500 text-slate-950 border-emerald-500 shadow-lg shadow-emerald-500/20" 
                                        : "bg-slate-900 border-white/10 text-slate-400 hover:bg-slate-800 hover:text-white"}
                                `}
                            >
                                {method.name}
                            </button>
                        ))}
                    </div>
                )}
            </div>

            <button 
                onClick={handleConfirmFinish}
                disabled={finishing || !finalPaymentMethod}
                className="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-bold py-4 rounded-xl transition shadow-xl shadow-emerald-500/20 disabled:opacity-50 disabled:cursor-not-allowed text-lg"
            >
                {finishing ? "Processando..." : "Confirmar Recebimento ğŸ’°"}
            </button>
        </div>
      </Modal>

      <StaffBookingModal 
         isOpen={isBookingModalOpen}
         onClose={() => setBookingModalOpen(false)}
         onSuccess={() => loadAgenda()}
      />

    </div>
  );
}

--- FIM DO ARQUIVO: src\react-app\pages\staff\StaffAgendaPage.tsx ---


--- INICIO DO ARQUIVO: src\react-app\pages\staff\StaffProfilePage.tsx ---
Path: src\react-app\pages\staff\StaffProfilePage.tsx
------------------------------
import { useState, useEffect } from "react";
import { useAuth } from "@/react-app/contexts/AuthContext";
import { pb } from "@/react-app/lib/api/pocketbase";

export default function StaffProfilePage() {
  const { user } = useAuth();
  
  const [name, setName] = useState("");
  const [email, setEmail] = useState("");
  const [phone, setPhone] = useState("");
  
  const [oldPassword, setOldPassword] = useState("");
  const [newPassword, setNewPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");

  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (user) {
      setName(user.name || "");
      setEmail(user.email || "");
      setPhone(user.phone || "");
    }
  }, [user]);

  const handleUpdateProfile = async () => {
    if (!user) return;
    setLoading(true);
    try {
      await pb.collection("users").update(user.id, {
        name: name.trim(),
        phone: phone.trim(),
      });
      alert("Dados atualizados com sucesso!");
    } catch (error: any) {
      console.error(error);
      alert("Erro ao atualizar dados.");
    } finally {
      setLoading(false);
    }
  };

  const handleChangePassword = async () => {
    if (!user) return;
    
    if (!oldPassword || !newPassword || !confirmPassword) {
      return alert("Preencha todos os campos de senha.");
    }
    if (newPassword.length < 8) {
        return alert("A nova senha deve ter no mÃ­nimo 8 caracteres.");
    }
    if (newPassword !== confirmPassword) {
      return alert("A nova senha e a confirmaÃ§Ã£o nÃ£o conferem.");
    }

    setLoading(true);
    try {
      // Exige senha antiga para troca
      await pb.collection("users").update(user.id, {
        oldPassword: oldPassword,
        password: newPassword,
        passwordConfirm: confirmPassword,
      });
      
      alert("Senha alterada com sucesso!");
      setOldPassword("");
      setNewPassword("");
      setConfirmPassword("");
    } catch (error: any) {
      console.error(error);
      alert("Erro ao alterar senha. Verifique se a senha atual estÃ¡ correta.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="max-w-2xl mx-auto space-y-8 pb-20">
      <div>
        <h1 className="text-2xl font-bold text-white">ConfiguraÃ§Ãµes da Conta</h1>
        <p className="text-slate-400">Mantenha seus dados de acesso e contato atualizados.</p>
      </div>

      {/* DADOS BÃSICOS */}
      <section className="bg-slate-900 border border-white/5 rounded-2xl p-6 space-y-4">
        <h2 className="text-lg font-semibold text-white border-b border-white/5 pb-2">Meus Dados</h2>
        
        <div className="grid md:grid-cols-2 gap-4">
            <div>
                <label className="block text-xs text-slate-400 mb-1">Nome Completo</label>
                <input 
                    type="text" 
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    className="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white outline-none focus:border-emerald-500 transition"
                />
            </div>
            <div>
                <label className="block text-xs text-slate-400 mb-1">E-mail (NÃ£o alterÃ¡vel)</label>
                <input 
                    type="email" 
                    value={email}
                    disabled
                    className="w-full bg-black/30 border border-white/5 rounded-lg p-3 text-slate-500 cursor-not-allowed"
                />
            </div>
            <div className="md:col-span-2">
                <label className="block text-xs text-slate-400 mb-1">Telefone / WhatsApp</label>
                <input 
                    type="text" 
                    value={phone}
                    onChange={(e) => setPhone(e.target.value)}
                    className="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white outline-none focus:border-emerald-500 transition"
                />
            </div>
        </div>
        
        <div className="pt-2 text-right">
            <button 
                onClick={handleUpdateProfile}
                disabled={loading}
                className="bg-emerald-600 hover:bg-emerald-500 text-white font-medium px-6 py-2 rounded-xl transition disabled:opacity-50"
            >
                {loading ? "Salvando..." : "Salvar AlteraÃ§Ãµes"}
            </button>
        </div>
      </section>

      {/* SEGURANÃ‡A */}
      <section className="bg-slate-900 border border-white/5 rounded-2xl p-6 space-y-4">
        <h2 className="text-lg font-semibold text-white border-b border-white/5 pb-2">SeguranÃ§a</h2>
        
        <div className="space-y-4">
            <div>
                <label className="block text-xs text-slate-400 mb-1">Senha Atual</label>
                <input 
                    type="password" 
                    value={oldPassword}
                    onChange={(e) => setOldPassword(e.target.value)}
                    className="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white outline-none focus:border-emerald-500 transition"
                />
            </div>
            <div className="grid md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-xs text-slate-400 mb-1">Nova Senha</label>
                    <input 
                        type="password" 
                        value={newPassword}
                        onChange={(e) => setNewPassword(e.target.value)}
                        className="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white outline-none focus:border-emerald-500 transition"
                        placeholder="MÃ­nimo 8 caracteres"
                    />
                </div>
                <div>
                    <label className="block text-xs text-slate-400 mb-1">Confirmar Nova Senha</label>
                    <input 
                        type="password" 
                        value={confirmPassword}
                        onChange={(e) => setConfirmPassword(e.target.value)}
                        className="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white outline-none focus:border-emerald-500 transition"
                    />
                </div>
            </div>
        </div>

        <div className="pt-2 text-right">
            <button 
                onClick={handleChangePassword}
                disabled={loading}
                className="bg-slate-700 hover:bg-slate-600 text-white font-medium px-6 py-2 rounded-xl transition disabled:opacity-50"
            >
                {loading ? "Atualizando..." : "Trocar Senha"}
            </button>
        </div>
      </section>
    </div>
  );
}
--- FIM DO ARQUIVO: src\react-app\pages\staff\StaffProfilePage.tsx ---


--- INICIO DO ARQUIVO: src\react-app\routes\AppRouter.tsx ---
Path: src\react-app\routes\AppRouter.tsx
------------------------------
import { BrowserRouter, Routes, Route, Navigate, Outlet } from "react-router-dom";

import LandingPage from "../pages/public/LandingPage";
import LoginPage from "../pages/auth/LoginPage";
import RegisterPage from "../pages/auth/RegisterPage";
import BookPage from "../pages/booking/BookPage";
import OnboardingRouter from "../pages/onboarding/OnboardingRouter";
import DashboardHome from "../pages/dashboard/DashboardHome";

// Pages Staff
import StaffAgendaPage from "../pages/staff/StaffAgendaPage";
import StaffProfilePage from "../pages/staff/StaffProfilePage"; 

// Pages Owner
import ClientPanelPage from "../pages/client/ClientPanelPage";
import SettingsPage from "../pages/owner/SettingsPage";
import ServicesPage from "../pages/owner/ServicesPage";
import ShopsPage from "../pages/owner/ShopsPage";
import StaffPage from "../pages/owner/StaffPage";
import FinancialPage from "../pages/owner/FinancialPage"; // IMPORTAR AQUI

import ProtectedRoute from "./ProtectedRoute";
import AppLayout from "../components/layout/AppLayout";
import StaffLayout from "../components/layout/StaffLayout" 

export default function AppRouter() {
  return (
    <BrowserRouter>
      <Routes>
        {/* PÃšBLICA RAIZ */}
        <Route path="/" element={<LandingPage />} />

        {/* AUTH */}
        <Route path="/login" element={<LoginPage />} />
        <Route path="/register" element={<RegisterPage />} />

        {/* BOOKING PÃšBLICO */}
        <Route path="/book/:slug" element={<BookPage />} />

        {/* ONBOARDING (DONO) */}
        <Route
          path="/onboarding/*"
          element={
            <ProtectedRoute allowedRoles={["dono"]}>
              <OnboardingRouter />
            </ProtectedRoute>
          }
        />

        {/* --- ROTAS DO PAINEL DO DONO (Layout AppLayout) --- */}
        <Route element={<AppLayout />}>
          <Route
            path="/owner/dashboard"
            element={
              <ProtectedRoute allowedRoles={["dono"]}>
                <DashboardHome />
              </ProtectedRoute>
            }
          />
          
          {/* NOVA ROTA FINANCEIRA */}
          <Route
            path="/owner/financial"
            element={
              <ProtectedRoute allowedRoles={["dono"]}>
                <FinancialPage />
              </ProtectedRoute>
            }
          />

          <Route
            path="/owner/shops"
            element={
              <ProtectedRoute allowedRoles={["dono"]}>
                <ShopsPage />
              </ProtectedRoute>
            }
          />

          <Route
            path="/owner/services"
            element={
              <ProtectedRoute allowedRoles={["dono"]}>
                <ServicesPage />
              </ProtectedRoute>
            }
          />

          <Route
            path="/owner/staff"
            element={
              <ProtectedRoute allowedRoles={["dono"]}>
                <StaffPage />
              </ProtectedRoute>
            }
          />

          <Route
            path="/owner/settings"
            element={
              <ProtectedRoute allowedRoles={["dono"]}>
                <SettingsPage />
              </ProtectedRoute>
            }
          />
        </Route>

        {/* --- ÃREA DO STAFF (Layout StaffLayout) --- */}
        <Route
          path="/staff"
          element={
            <ProtectedRoute allowedRoles={["staff", "dono"]}>
              <StaffLayout>
                <Outlet />
              </StaffLayout>
            </ProtectedRoute>
          }
        >
            <Route index element={<Navigate to="agenda" replace />} />
            <Route path="agenda" element={<StaffAgendaPage />} />
            <Route path="settings" element={<StaffProfilePage />} />
        </Route>


        {/* PAINEL DO CLIENTE */}
        <Route
          path="/client"
          element={
            <ProtectedRoute allowedRoles={["cliente"]}>
              <ClientPanelPage />
            </ProtectedRoute>
          }
        />

        {/* FALLBACK */}
        <Route path="*" element={<Navigate to="/" replace />} />

      </Routes>
    </BrowserRouter>
  );
}

--- FIM DO ARQUIVO: src\react-app\routes\AppRouter.tsx ---


--- INICIO DO ARQUIVO: src\react-app\routes\ProtectedRoute.tsx ---
Path: src\react-app\routes\ProtectedRoute.tsx
------------------------------
// src/react-app/routes/ProtectedRoute.tsx
import { ReactNode } from "react";
import { Navigate, useLocation } from "react-router-dom";
import { useAuth } from "../contexts/AuthContext";
import type { UserRole } from "@/shared/types";

interface ProtectedRouteProps {
  allowedRoles?: UserRole[];
  children: ReactNode;
}

const DEFAULT_ROUTE_BY_ROLE: Record<UserRole, string> = {
  dono: "/owner/dashboard",
  staff: "/staff/agenda",
  cliente: "/client",
};

export default function ProtectedRoute({ allowedRoles, children }: ProtectedRouteProps) {
  const { user, isAuthenticated, loading } = useAuth(); // <-- nomes reais
  const location = useLocation();

  // Estado de carregamento inicial
  if (loading) {
    return <div>Carregando...</div>;
  }

  // NÃ£o autenticado â†’ volta ao login
  if (!isAuthenticated || !user) {
    return <Navigate to="/login" replace state={{ from: location }} />;
  }

  const userRole = user.role as UserRole;

  // Se rota requer role, validar
  if (allowedRoles && !allowedRoles.includes(userRole)) {
    const fallback = DEFAULT_ROUTE_BY_ROLE[userRole] ?? "/";
    return <Navigate to={fallback} replace />;
  }

  return <>{children}</>;
}

--- FIM DO ARQUIVO: src\react-app\routes\ProtectedRoute.tsx ---


--- INICIO DO ARQUIVO: src\shared\types.ts ---
Path: src\shared\types.ts
------------------------------
// src/shared/types.ts

// ------------------------------------
// ENUMS / TIPOS BÃSICOS
// ------------------------------------

export type UserRole = 'dono' | 'cliente' | 'staff';

export enum AppointmentStatus {
  Cancelled = '0',
  Pending = '1',
  Confirmed = '2',
  InProgress = '3',
  Completed = '4',
  NoShow = '5',
  Blocked = '6',
  Rescheduled = '7',
  AwaitingPayment = '8',
  Other = '9',
}

export enum PaymentStatus {
  A_PAGAR = '1',
  PAGO = '2',
  PENDENTE = '3',
}

export type PixKeyType = 'cpf' | 'cnpj' | 'email' | 'telefone' | 'aleatoria';

export type Weekday = 'dom' | 'seg' | 'ter' | 'qua' | 'qui' | 'sex' | 'sab';

export type CompanyPlanStatus = 'trial' | 'active' | 'suspended' | 'cancelled';

export type SubscriptionPlan = 'trial' | 'basic' | 'pro';

// ------------------------------------
// BASE RECORD
// ------------------------------------

export interface BaseRecord {
  id: string;
  created: string; // ISO date
  updated: string; // ISO date
}

// ------------------------------------
// USERS
// ------------------------------------

export interface User extends BaseRecord {
  email: string;
  name?: string;
  avatar?: string;
  role: UserRole;
  phone?: string;
  company_id?: string | null;
  shop_id?: string | null;
  is_professional?: boolean;
}

// ------------------------------------
// COMPANIES
// ------------------------------------

export interface Company extends BaseRecord {
  legal_name: string;
  cnpj?: string;
  plan_status: CompanyPlanStatus;
  owner_id: string;
  plan?: SubscriptionPlan | null;
  active_subscription_id?: string | null;
  trial_expires_at?: string | null;
  max_shops?: number | null;
  max_professionals?: number | null;
  billing_cycle?: string | null;
}

// ------------------------------------
// SHOPS
// ------------------------------------

export interface Shop extends BaseRecord {
  name: string;
  slug: string;
  logo?: string;
  address?: string;
  phone?: string;
  company_id: string;
  owner_id: string;
  description?: string;
  accepted_payment_methods?: string[];
  pix_key?: string;
  pix_key_type?: PixKeyType;
  segment_id?: string | null;
  min_advance_time?: number | null;
  max_advance_time?: number | null;
  is_active?: boolean;
}

// ------------------------------------
// CATEGORIES & SERVICES
// ------------------------------------

export interface Category extends BaseRecord {
  name: string;
  shop_id: string;
}

export interface Service extends BaseRecord {
  name: string;
  description?: string;
  price: number;
  duration: number;
  is_active?: boolean;
  shop_id: string;
  category_id?: string | null;
}

// ------------------------------------
// SHOP_HOURS
// ------------------------------------

export interface ShopHour extends BaseRecord {
  company_id: string;
  shop_id: string;
  weekday: Weekday;
  start_time: string;
  end_time: string;
  is_closed?: boolean;
}

// ------------------------------------
// PAYMENT_METHODS & SEGMENTS
// ------------------------------------

export interface PaymentMethod extends BaseRecord {
  name: string;
  company_id: string;
  is_active: boolean;
}

export interface Segment extends BaseRecord {
  name: string;
  slug: string;
  icon?: string;
}

// ------------------------------------
// APPOINTMENTS (Alterado)
// ------------------------------------

export interface Appointment extends BaseRecord {
  start_time: string;
  end_time?: string | null;
  status: AppointmentStatus | string;
  payment_status: PaymentStatus | string;
  payment_method?: string | null;
  total_amount?: number | null;
  notes?: string;

  // ATUALIZAÃ‡ÃƒO: client_id opcional + campos avulsos
  client_id?: string; 
  customer_name?: string; // Novo: Nome do cliente avulso
  customer_phone?: string; // Novo: Telefone do cliente avulso
  
  barber_id: string;
  service_id: string;
  shop_id: string;

  expand?: {
    client_id?: User;
    barber_id?: User;
    service_id?: Service;
    shop_id?: Shop;
    payment_method?: PaymentMethod;
  };
}

// ------------------------------------
// SUBSCRIPTIONS
// ------------------------------------

export interface Subscription extends BaseRecord {
  company_id: string;
  plan: SubscriptionPlan;
  trial_expires_at?: string | null;
  max_shops: number;
  max_professionals: number;
  billing_cycle?: string | null;
}

// ------------------------------------
// DTOs (Alterado)
// ------------------------------------

export interface CreateAppointmentDTO {
  start_time: string;
  end_time?: string;
  
  // Opcionais para staff
  client_id?: string;
  customer_name?: string;
  customer_phone?: string;
  
  barber_id: string;
  service_id: string;
  shop_id: string;
  total_amount?: number;
  notes?: string;
  payment_method?: string | null;
}

export interface ClientAppointmentView {
  appointment: Appointment;
  service: Service;
  shop: Shop;
  barber: User;
}

export interface CreateCompanyDTO {
  legal_name: string;
  cnpj?: string;
}

export interface CreateShopDTO {
  name: string;
  slug: string;
  company_id: string;
  owner_id: string;
  phone?: string;
  address?: string;
  segment_id?: string;
}

// ------------------------------------
// TIPOS AUXILIARES FRONTEND
// ------------------------------------

export interface TimeSlot {
  time: string;
  startISO: string;
  endISO: string;
  isAvailable: boolean;
}

export interface ProfessionalOption {
  id: string;
  name: string;
  avatar?: string;
}

export interface ClientCompanyLink extends BaseRecord {
  user_id: string;
  company_id: string;
  shop_id?: string | null;
}

export interface RegisterOwnerInput {
  name: string;
  email: string;
  password: string;
  phone?: string;
}

export interface RegisterClientInput {
  name: string;
  email: string;
  password: string;
  phone?: string;
  companyId: string;
  shopId: string;
}

export interface ShopWithCompany {
  shop: any;
  company: any;
}
--- FIM DO ARQUIVO: src\shared\types.ts ---
